成功分割为 22 个章节块

生成的知识库内容：
 {'input_documents': [Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='arXiv:1407.7676v3  [astro-ph.IM]  15 Feb 2015\nG AL SIM : The modular galaxy image simulation toolkit\nBarnaby Rowea,b,c,∗, Mike Jarvisd,∗, Rachel Mandelbaume,∗, Gary M. Bernsteind, James Boschf, Melanie Simete,\nJoshua E. Meyersg, Tomasz Kacprzaka,h, Reiko Nakajimai, Joe Zuntzh, Hironao Miyatakef,j, Jörg P. Dietrichk,l, Robert Armstrongf,\nPeter Melchiorm , Mandeep S. S. Gilln\naDepartment of Physics & Astronomy, University College London, Gower Street, London, WC1E 6BT, United Kingdom\nbJet Propulsion Laboratory, California Institute of Technology, 4800 Oak Grove Drive, Pasadena, CA 91109, United States of America\ncCalifornia Institute of Technology, 1200 East California Boulevard, Pasadena, CA 91106, United States of America\ndDepartment of Physics & Astronomy, University of Pennsylvania, Philadelphia, PA 19104, United States of America\neMcWilliams Center for Cosmology, Department of Physics, Carnegie Mellon University, 5000 Forbes Ave., Pittsburgh, PA15213, United States of America\nfDepartment of Astrophysical Sciences, Princeton University, Peyton Hall, Princeton, NJ 08544, United States of America\ngKavli Institute for Particle Astrophysics and Cosmology, Department of Physics, Stanford University, Stanford, CA 94305, United States of America\nhJodrell Bank Centre for Astrophysics, University of Manchester, Manchester, M13 9PL, United Kingdom\niArgelander-Institut für Astronomie, Universität Bonn, Auf dem Hügel 71, D-53121 Bonn, Germany\njKavli Institute for the Physics and Mathematics of the Universe (Kavli IPMU, WPI), The University of Tokyo, Kashiwa, Chiba 277-8582, Japan\nkUniversitäts-Sternwarte München, Scheinerstr. 1, 81679 München, Germany\nlExcellence Cluster Universe, 85748 Garching b. München, Germany\nm Center for Cosmology and Astro-Particle Physics and Department of Physics, The Ohio State University, Columbus, OH 43210, United States of America\nnKavli Institute for Particle Astrophysics and Cosmology, SLAC National Accelerator Laboratory, Menlo Park, CA 94025-7015, United States of America\nAbstract\nG AL SIM is a collaborative, open-source project aimed at providingan image simulation tool of enduring beneﬁt to the astronomical\ncommunity. It provides a software library for generating images of astronomical objects such as stars and galaxies in a variety of\nways, efﬁciently handling image transformations and operations such as convolution and rendering at high precision. We describe\nthe GAL SIM software and its capabilities, including necessary theoretical background. We demonstrate that the performance of\nG AL SIM meets the stringent requirements of high precision image analysis applications such as weak gravitational lensing, for\ncurrent datasets and for the Stage IV dark energy surveys of the Large Synoptic Survey Telescope, ESA’sEuclidmission, and\nNASA’s WFIRST-AFTA mission. The GAL SIM project repository is public and includes the full code history, all open and closed\nissues, installation instructions, documentation, and wiki pages (including a Frequently Asked Questions section).The G AL SIM\nrepository can be found athttps://github.com/GalSim-developers/GalSim.\nKeywords: methods: data analysis, techniques: image processing, gravitational lensing, cosmology: observations\n1. Introduction\nRapid advances in instrumentation and telescope technology\nare forcing changes in the techniques used to analyse astronom-\nical data. As data volumes increase, and statistical uncertainties\ndecrease correspondingly, systematic biases resulting from im-\nperfect or approximate inference must be reduced to ensure full\nreturn on investments made into increasingly large projects.\nAn area of research where technology and data volumes\nare placing increasingly stringent requirements on data anal-\nysis methodology is observational cosmology. Recent years\nhave seen a number of wide area, long exposure imaging sur-\nveys of the extragalactic sky from both ground-based tele-\nscopes (e.g. SDSS1, CFHTLS 2,3: see Abazajian et al., 2009;\n∗Corresponding author\nEmail addresses:browe@star.ucl.ac.uk(Barnaby Rowe),\nmichael@jarvis.net(Mike Jarvis),rmandelb@andrew.cmu.edu\n(Rachel Mandelbaum)\n1http://www.sdss.org/\n2http://www.cfht.hawaii.edu/Science/CFHTLS/\n3http://www.cfhtlens.org/\nHeymans et al., 2012, respectively) and space (COSMOS4: see\nScoville et al., 2007). Data from these projects continue tobe\nexploited for their rich scientiﬁc content.\nMore ambitious ground-based projects are already un-\nderway, including the Dark Energy Survey5 (DES: see\ne.g. Sánchez et al., 2010), Hyper Suprime-Cam6 (HSC: see\nMiyazaki et al., 2012) and the Kilo Degree Survey7 (KiDS: see\nde Jong et al., 2013). By most measures these upcoming sur-\nveys of the deep extragalactic sky will bring an order of mag-\nnitude more imaging data than their recent predecessors. In\nthe 2020s, the ground-based Large Synoptic Survey Telescope\n(LSST 8), and the ESAEuclid9 and NASA WFIRST-AFTA 10\nspace missions, will be taking extragalactic imaging data in\n4http://cosmos.astro.caltech.edu/\n5http://www.darkenergysurvey.org/\n6http://www.naoj.org/Projects/HSC/\n7http://kids.strw.leidenuniv.nl/\n8http://www.lsst.org/lsst/\n9http://sci.esa.int/euclid/, http://www.euclid-ec.\norg\n10http://wfirst.gsfc.nasa.gov/\nPreprint submitted to Elsevier February 17, 2015\nvast quantities. These successive generations of projectsare\nexamples of “Stage III” and “Stage IV” dark energy surveys\n(Albrecht et al., 2006).\nThe increasing data volumes in these planned surveys are\ndue to increases in survey area and, to a somewhat lesser ex-\ntent, depth, as motivated by their science goals (Albrecht et al.,\n2006; Peacock et al., 2006). Increasing area and depth brings\na greater number of galaxy objects, and thus a decrease in the\nstatistical uncertainties on ﬁnal measurements. However,this\nmeans that the tolerablesystematicerror in the inferred prop-\nerties of each galaxy needs to be reduced commensurately. As\nsurveys become larger, the accurate estimation of galaxy prop-\nerties from noisy images becomes increasingly important. In\nthis context the GAL SIM project was conceived, aiming to pro-\nvide a common image simulation tool for use across multiple\nsurveys and to aid comparison between measurement methods.\nWeak gravitational lensing (for reviews see, e.g., Schneider,\n2006; Bartelmann, 2010; Huterer, 2010) is a prime example ofa\nscientiﬁc application that relies on reliable inference regarding\nthe properties of astrophysical objects from imperfect images.\nHere theshape of the galaxy (typically some property related\nto its ellipticity) is used to construct a noisy estimate of gravi-\ntationalshear, which can be related to second derivatives of the\nprojected gravitational potential and is thus sensitive toall mat-\nter (including dark matter). Weak lensing can be used to con-\nstrain both cosmic expansion and the growth of matter structure\nover time, and is thus valuable as a test of dark energy and mod-\niﬁed gravity models (e.g. Albrecht et al., 2006; Peacock et al.,\n2006).\nTo achieve this potential as a probe of cosmology,\nhowever, the weak lensing community must control ad-\nditive and multiplicative systematic biases in shear esti-\nmates to∼ 2 × 10−4 and 2 × 10−3, respectively (e.g.\nHuterer et al., 2006; Amara & Réfrégier, 2008; Massey et al.,\n2013; Mandelbaum et al., 2014). This accuracy must be\nachieved in the presence of detector imperfections, telescope\nblurring and distortion, atmospheric effects (for ground-based\nsurveys), and noise (galaxies used for lensing typically have a\nsignal-to-noise ratio of the ﬂux as low as 10). Weak lensing\ninference for cosmology presents a signiﬁcant technical chal-\nlenge.\nSimulations of astronomical imaging data will play an\nimportant part in meeting this challenge. For example,\nweak lensing estimators typically invoke non-linear com-\nbinations of image pixels, and can be shown to suf-\nfer from generic systematic biases when applied to noisy\ngalaxy images (e.g. Kaiser, 2000; Bernstein & Jarvis, 2002;\nHirata et al., 2004; Refregier et al., 2012; Melchior & Viola,\n2012) unless constructed extremely carefully (Kaiser, 2000;\nBernstein & Armstrong, 2014). Simulations of weak lensing\nsurvey data in the GREAT08 (GRavitational lEnsing Accuracy\nTesting 2008) challenge (Bridle et al., 2010) clearly showed\nthe impact of noise in a blind comparison of shear estima-\ntion methods. This helped reinvigorate activity aimed at bet-\nter characterizing these “noise biases” (Refregier et al.,2012;\nMelchior & Viola, 2012; Kacprzak et al., 2012) or eliminating\nthem (Bernstein & Armstrong, 2014).\nAnother type of bias arises when true galaxy surface bright-\nness proﬁles do not match the models being ﬁt, often referred\nto as model bias or underﬁtting bias (e.g. V oigt & Bridle, 2010;\nBernstein, 2010; Melchior et al., 2010; Kacprzak et al., 2014).\nOne of the goals of GREAT3 (Mandelbaum et al., 2014), the\nthird challenge in the GREAT series, is to explore the im-\npact of model bias across a range of shear measurement meth-\nods. For one of its “experiments”, it takes real galaxy images\nfrom theHubble Space Telescope(HST ) as the underlying sur-\nface brightness proﬁles of the galaxies, and draws sheared ver-\nsions of these proﬁles using a method derived from that of\nMandelbaum et al., 2012: see §6.5 in this article. GREAT3\nalso involved controlled tests of the impact of multiepoch (i.e.\nmultiple exposure) imaging and realistic uncertainty about the\npoint spread function (PSF) in survey data (Mandelbaum et al.,\n2014). The initial imperative for developing GAL SIM was\nspeciﬁcally to enable the creation of the required images for\nthe GREAT3 challenge.\nBut there are other issues in both space and ground-\nbased data that are still to be fully addressed for preci-\nsion photometry and shape estimation. These include ob-\nject confusion (or deblending), PSF-object colour mismatch-\ning (Cypriano et al., 2010), differential atmospheric chromatic\nrefraction (Meyers & Burchat, 2014), galaxy colour gradients\n(V oigt et al., 2012; Semboloni et al., 2013), and non-linearde-\ntector effects (e.g. Rhodes et al., 2010; Seshadri et al., 2013;\nAntilogus et al., 2014). Simulation investigations into the many\ndifferent aspects of the shear measurement problem will con-\ntinue to improve our understanding of how to meet these chal-\nlenges for upcoming surveys.\nSystematic biases are likely to be present, to some degree, in\nallpracticalestimators of shear, and thus simulations of weak\nlensing observations will berequiredfor precision cosmology:\neither to estimate (and thus calibrate) biases for a given sur-\nvey, or (ideally) to demonstrate that they have been controlled\nto tolerable levels. The same is also true of the many applica-\ntions that rely on highly accurate photometry and astrometry.\nThese measurements often require steps such as the classiﬁ-\ncation and removal of outliers, the application of calibration\ncorrections, and the ﬁtting of models to data; simulated tests\nof these techniques are typically necessary. Those who study\ngalaxy properties by ﬁtting parametric models in order to learn\nsomething about galaxy evolution also beneﬁt from controlled\nsimulations with which to test their analysis methods. Moti-\nvated by these requirements, the GAL SIM project has drawn\ncontributions from members of multiple Stage III and Stage\nIV survey collaborations, aimed at producing an open-source,\ncommunity-vetted toolkit for building these indispensable im-\nage simulations.\nThe structure of this paper is as follows. In §2 we provide an\noverview of the GAL SIM software toolkit, and describe the mo-\ntivation and structure of the different component parts of GAL -\nSIM . In §2.3 we provide references to where these component\nparts are described, in greater detail, in the rest of the paper.\nIn §3 we describe the types of astronomical objects that\nG AL SIM can currently represent. In §4 we describe the GAL -\nSIM “lensing engine”, which generates cosmologically moti-\n2\nvated shear ﬁelds. In §5 we describe how transformations be-\ntween coordinate systems are represented, including between\nimage pixel coordinates and “world coordinate systems” (which\nmay use either celestial coordinates or a Euclidean tangent\nplane approximation). In §6 we describe how GAL SIM objects\nare rendered to form images, and §7 describes the noise models\nthat can be invoked to add noise to images. In §8 we describe\nsome of the shear estimation routines that come as part of GAL -\nSIM .\nIn §9 we describe the numerical validation of GAL SIM via\nseries of tests and comparisons, and §10 discusses performance.\nIn §11 we highlight some important effects in real data that\nG AL SIM does not currently include, and we end with a sum-\nmary and conclusions in §12.\n2. Software overview\nThe design and characteristics of GAL SIM arose through the\nneed to meet goals and requirements that were set down early in\nthe life of the project. We describe these, along with some as-\npects of the collaborative development process, and show how\nthey led to the current state of the GAL SIM software. All of\nthe code described in this paper can be found in version 1.2 of\nG AL SIM .\n2.1. Science requirements\nThe basic capabilities of GAL SIM were driven by the need\nto meet the following requirements for simulating astronomical\nimages:\n1. The ability to ﬂexibly represent and render a broad range\nof models for astronomical objects in imaging data, in-\ncluding observationally-motivated PSF and galaxy pro-\nﬁles.\n2. Handling of coordinate transformations such as shear, di-\nlation and rotation for all objects being rendered, moti-\nvated by the need to simulate weak lensing effects at high\nprecision.\n3. Representation of the convolution of two or more objects,\nto describe the convolution of galaxy surface brightness\nproﬁles with PSFs.\n4. Accuracy in object transformation, convolution and ren-\ndering at the level required for Stage IV surveys.\n5. Flexibility in specifying image pixel noise models and data\nconﬁgurations (e.g. overlapping objects), so as to allow\nthe importance of these data properties to be evaluated in\ncontrolled tests.\n6. The ability to do all the above for galaxy or PSF models\ngenerated from an input image, e.g. from theHST , so as\nto be able to compare results against those obtained from\nsimpler parametric prescriptions for galaxies and PSF pro-\nﬁles.\nAs can be seen, many of these requirements are driven by the\nneed to simulate weak lensing observations. Precision sim-\nulation of astrometry and photometry places similar require-\nments.11 Software which meets the above requirements is there-\nfore of great value for simulations that require accurate photom-\netry (e.g. for photometric redshift estimation).\n2.2. Software design requirements\nIn addition to the scientiﬁc goals for the GAL SIM project, an\nemphasis was also placed on software design and implementa-\ntion considerations. GAL SIM was conceived to be freely avail-\nable under an open-source (BSD-style) license, and writtenin\nnon-proprietary programming languages, making it available to\nall. This aim is satisﬁed by the choice of Python in combination\nwith C++.\nG AL SIM was also designed to bemodular, i.e. separated into\nvarious functional components, and thus easily extensible. En-\nforcing modularity allows parts of the code to be written and\nmaintained independently by multiple individuals. This design\nfeature was important in allowing GAL SIM to be developed col-\nlaboratively. Within a modular program design there is scope\nfor different modules (with a common interface) to be used in-\nterchangeably, and this property was crucial in providing the\nﬂexibility demanded by GAL SIM ’s science goals (§2.1: item\n1). Future extensions to the project also occur naturally within\nthis framework as additional modules.\nTo ensure that the learning curve for GAL SIM users is as easy\nas possible, we require clear documentation on all new features\nbefore they are deployed, and major features are demonstrated\nin heavily-commented example scripts that amount to a kind of\ntutorial for how to use GalSim. Writing these example scripts\nhas been very useful as a design tool to help determine what\nuser interface is most natural for realistic applications.\nSimilarly, all new code also requires an accompanying test\nsuite before being merged into the main code base. While we\nhave not tried to impose the precepts of test-driven development\nwithin the collaboration, we do take seriously the requirement\nthat all code be tested as comprehensively as possible. In addi-\ntion to checking the general validity of new code, the extensive\nunit tests have proved extremely valuable for dealing with is-\nsues of cross-platform portability: we regularly run the tests on\na wide variety of systems with various idiosyncrasies.\nFinally, we require all new code to undergo extensive code\nreview by the rest of the development team, including reviewof\nthe code, the documentation, and the unit tests. This reviewpro-\ncess is facilitated by the “Pull Request” feature of GITH UB 12,\nwhere the code is hosted. The other members of the collabora-\ntion team can easily see the set of changes being proposed and\neven comment on individual lines of code. While bugs are in-\nevitable at some level no matter how much care is taken to avoid\nthem, these steps have been quite effective at catching bugsand\ndocumentation errors before code is deployed.\n2.3. The structure ofG AL SIM\nGiven the emphasis on modularity, and the desire to make the\nsoftware easily useable for as many scientiﬁc projects and ap-\nplications as possible, GAL SIM was conceived from the outset\n11For example, see http://www.lsst.org/files/docs/SRD.\npdf.\n12https://github.com\n3\nto be a toolkit of library routines rather than as a “monolithic”\npackage. From the user’s perspective GAL SIM is fundamen-\ntally a Pythonclass library, providing a number of objects that\ncan be employed for astronomical image simulation in almost\nany combination speciﬁed by the calling code.\nIn addition, for users who may be more comfortable using\nconﬁguration ﬁles than writing Python code, we also provide\na stand-alone executable that reads relatively simple conﬁgura-\ntion ﬁles, which can carry out most of the important GAL SIM\nfunctionality. In particular, each of the tutorial examplescripts\nhave a corresponding conﬁguration ﬁle that produces the same\noutput ﬁles13. Information about the conﬁguration ﬁle interface\ncan be found on the GAL SIM wiki14.\nThe classes and functions in the GAL SIM toolkit can be\nseparated into the following broad categories by functionality.\nThese are (with references to relevant Sections of this article):\n• Representing astronomical objects, including any transfor-\nmations, distortions, and convolutions (see §3).\n• Generating gravitational lensing distortions to be applied\nto astronomical objects (see §4).\n• Characterizing the connection between image coordinates\nand world coordinates (see §5).\n• Rendering the proﬁles into images (see §6).\n• Generating random numbers, and using these to apply\nnoise to images according to physically-motivated models\n(see §7).\n• Estimating the shapes of objects once these have been ren-\ndered into images (useful for testing, see §8).\nFor information about the practical use of these tools, we refer\nthe reader to the online documentation available at the GAL SIM\nproject page15. Further information and a forum for questions\nregarding the structure or usage of the GAL SIM software can\nbe found in the repository Issues pages, or via thegalsimtag\non the StackOverﬂow web site16.\nWhile Python serves as the principal user interface to GAL -\nSIM , many of the numerical calculations are actually imple-\nmented in C++. However, this should be considered a mere\nimplementation detail; the structure of GAL SIM is intended to\nprevent the user from needing to interface with the C++ layer\ndirectly.\nIn this paper, we will focus on a scientiﬁc, theoretical de-\nscription of the output generated by GAL SIM ’s classes and\nfunctions, and the validation of those outputs to ensure they\nmeet our accuracy requirements.\n13 Actually, as of version 1.2, the chromatic functionality has yet to be\nported over to the conﬁguration interface, so the example script for that\n(demo12) does not yet have a corresponding conﬁguration ﬁle. We plan to\nadd this functionality in the near future.\n14 https://github.com/GalSim-developers/GalSim/\nwiki/Config-Documentation\n15See https://github.com/GalSim-developers/GalSim.\nThe example scripts and Quick Reference Guide provide a goodstarting point\nfor documentation, in addition to the Python docstrings forindividual functions\nand class methods.\n16http://stackoverflow.com/tags/galsim/info\n3. Surface brightness proﬁles\nIn this section we describe the kinds of surface brightness\nproﬁles that are available in GAL SIM . We include their analytic\nformulae where appropriate, and the physical and observational\nmotivations for the models.\n3.1. Galaxy models\n3.1.1. The exponential disk proﬁle\nFirst identiﬁed in M33 by Patterson (1940), and observed\nsystematically by de Vaucouleurs (1959) as a characteristic\ncomponent of the light proﬁle in a sample of the brightest\nnearby galaxies, the exponential disk proﬁle provides a good\ndescription of the outer, star-forming regions of spiral galaxies\n(e.g. Lackner & Gunn, 2012).\nThe surface brightness of an exponential disk proﬁle varies\nas\nI(r)= F\n2πr2\n0\ne−r/r0 (1)\n= F\n2.23057r2e\ne−1.67835r/re, (2)\nwhere F is the total ﬂux,r0 is the scale radius, andre =\n1.67835r0 is the half-light radius, the radius that encloses half\nof the total ﬂux.\nIt is represented in GAL SIM by theExponentialclass,\nand the size can be speciﬁed using eitherr0 or the half-light\nradius.\n3.1.2. The de Vaucouleurs proﬁle\nThis proﬁle (ﬁrst used by de Vaucouleurs, 1948) is found to\ngive a good ﬁt to the light proﬁles of both elliptical galaxies\nand the central bulge regions of galaxies that are still actively\nstar-forming (e.g. Lackner & Gunn, 2012).\nThe surface brightness of a de Vaucouleurs proﬁle varies as\nI(r)= F\n7!·8πr2\n0\ne−(r/r0)1/4\n(3)\n= F\n0.010584r2e\ne−7.66925(r/re)1/4\n, (4)\nwhere F is the total ﬂux,r0 is the scale radius, andre is the\nhalf-light radius.\nDe Vaucouleurs proﬁles are notorious for having both very\ncuspy cores and also very broad wings. The cusp occurs around\nthe size of the scale radiusr0, but because of the broad wings,\nthe half-light radius is several orders of magnitude larger17. As\nsuch, the second formula is more often used in practice.\nIt is represented in GAL SIM by theDeVaucouleursclass,\nand the size can be speciﬁed using eitherr0 or the half-light\nradius.\nBecause de Vaucouleurs proﬁles have such broad wings, it\nis sometimes desirable to truncate the proﬁle at some radius,\nrather than allow it extend to inﬁnity. Thus, GAL SIM provides\nthe option of specifying a truncation radius beyond which to\nhave the surface brightness drop to zero.\n17 More precisely,re ≃ 3459.485r0\n4\n3.1.3. The Sérsic proﬁle\nThis proﬁle, developed by Sérsic (1963), is a generalization\nof both the exponential and de Vaucouleurs proﬁles. The sur-\nface brightness of a Sérsic proﬁle proﬁle varies as\nI(r)= F\n2nπΓ(2n)r2\n0\ne−(r/r0)1/n\n(5)\n= F\na(n)r2e\ne−b(n)(r/re)1/n\n, (6)\nwhere F is the total ﬂux,r0 is the scale radius,re is the half-\nlight radius, anda(n) andb(n) are known functions with nu-\nmerical solutions. Note that the indexn need not be an integer.\nFlux normalization determinesa(n). To calculateb(n) in GAL -\nSIM we start with the approximation given by Ciotti & Bertin\n(1999), then perform a small number of iterations of a numeri-\ncal, non-linear root solver to increase accuracy.\nAs with the de Vaucouleurs proﬁle, it is standard practice to\nuse the second formula using the half-light radius, since that\nsize more closely matches the apparent size of the galaxy, par-\nticularly for largern values (n ≳ 2.5).\nThe Sérsic proﬁle is represented in GAL SIM by theSer-\nsicclass, and the size can be speciﬁed using eitherr0 or the\nhalf-light radius. Then parameter is allowed to range from\nn = 0.3, below which there are serious numerical problems,\nton = 6.2, above which rendering inaccuracy may exceed the\nrequirements set for GAL SIM (see §9.1).\nAs withDeVaucouleurs, it is also possible to specify a\ntruncation radius for the proﬁle, rather than allow it to extend\nindeﬁnitely.\n3.1.4. Galaxy proﬁles from direct observations\nObservations made using theHST provide high resolu-\ntion images of individual galaxies that can be used as di-\nrect models of light proﬁles for simulations (Kaiser, 2000;\nMandelbaum et al., 2012). These proﬁles naturally include re-\nalistic morphological variation and irregular galaxies, acontri-\nbution of increasing importance to the galaxy population athigh\nredshift.\nThe details of the implementation of such galaxy proﬁles are\ncovered in two later Sections: §3.3.3, which describes how ob-\njects are represented via two-dimensional lookup tables, and\n§6.5, which discusses the speciﬁcs of howHST galaxy images\nand their PSFs are handled by GAL SIM . However, it is worth\nstating here that such a model, based on direct observationsof\na large sample of individual galaxies, is available in GAL SIM .\nIt is represented in GAL SIM by theRealGalaxyclass.\n3.2. Stellar & PSF models\n3.2.1. The Airy & obscured Airy proﬁle\nThe ﬁnite circular aperture of a telescope gives rise to a\ndiffraction pattern for the light passing through the aperture, an\neffect ﬁrst explained by Airy (1835). The resulting image has a\ncentral peak surrounded by a series of rings.\nThe theoretical intensity distribution for a perfectly circular\naperture is given by\nI(r)=\n[ J1(ν)\nν\n] 2\n, (7)\nν≡ πrD /λ, (8)\nwhere D is the diameter of the telescope,λ is the wavelength\nof the light (see, e.g., Born & Wolf, 1999), andJ1 is the Bessel\nfunction of the ﬁrst kind of order one.\nIn many telescopes, the light is additionally diffracted bya\ncentral circular obscuration – either a secondary mirror ora\nprime focus camera. The diffraction pattern in this case is also\nanalytic:\nI(r)=\n[ J1(ν)−ǫJ1(ǫν)\nν\n] 2\n, (9)\nwhere ǫis the fraction of the pupil radius (as a linear dimension,\nnot by area) that is obscured.\nIt is represented in GAL SIM by theAiryclass, and the size\nis speciﬁed in terms ofλ/D , which dimensionally gives a size\nin radians, but which is typically converted to arcsec in practice.\n3.2.2. The Zernike aberration model\nComplex, aberrated wavefronts incident on a circular pupil\ncan often be well approximated by a sum of Zernike polyno-\nmials (Zernike, 1934). These functions form an orthogonal set\nover a circle of unit radius.\nIn GAL SIM the convention of Noll (1976) is adopted, which\nlabels these polynomials by an integerj. It is also useful to\ndeﬁne the polynomials in terms ofn and m , which are functions\nof jsatisfying|m | ≤ n withn −|m |being even18. The integersn\nand m specify the Zernike polynomials in polar coordinates as\nZeven j =\n√\n2(n +1)Rm\nn(r) cos(m θ) (10)\nZodd j =\n√\n2(n +1)Rm\nn(r) sin(m θ) (11)\nfor integerm /nequal0 and integern, and\nZ j =\n√\nn +1R0\nn(r), (12)\nform = 0, where\nRm\nn(r)=\n(n−m )/2∑\ns=0\nr(n−2s) (−1)s(n−s)!\ns!\n[ n+m\n2 −s\n]\n!\n[ n−m\n2 −s\n]\n!\n. (13)\nThe low order Zernike polynomials map to the low order\naberrations commonly found in telescopes, such as defocus (j=\n4), astigmatism (j = 5,6), coma (j = 7,8), trefoil (j = 9,10)\netc. In practice, Zernike polynomials have been found to pro-\nvide a convenient, and compact, approximate model for tele-\nscope aberrations.\nGiven such a model for the wavefront incident at the pupil,\nthe PSF is also determined at a given image plane location. In\n18 Speciﬁcally, the rule is that the Noll indicesjare in order of increasing\nn, and then increasing|m |, and negativem values have oddj(Noll, 1976).\n5\nthe Fraunhofer diffraction limit, the PSF is calculated as the\nFourier transform of the autocorrelation of the pupil wavefront.\nThe resulting proﬁle is represented in GAL SIM by theOp-\nticalPSFclass. The size is speciﬁed in terms ofλ/D , just as\nforAiry. There are also options for specifying a circular cen-\ntral obscuration as well as rectangular support struts. In GAL -\nSIM versions through 1.1, aberrations up to Noll indexj = 11\n(spherical aberration) can be included, but there are plansto\nallow for Zernike terms to arbitrary order.\nBecause the proﬁle is not analytic in either real or Fourier\nspace, the implementation of this class in GAL SIM involves\ncreating an image of the PSF in real space by Discrete Fourier\nTransform, and then using theInterpolatedImageclass\nto handle the interpolation across this image. Therefore, the\ntechniques that we will describe in §6 for interpolated images\nalso apply toOpticalPSF.\n3.2.3. The Moffat proﬁle\nMoffat (1969) investigated the hypothesis that stellar PSFs\ncould be modelled as a Gaussian seeing kernel convolved by\nan obstructed Airy diffraction pattern. He discovered thatthe\nGaussian was not a viable model for the seeing component.\nInstead, he developed an analytic model for stellar PSFs with\nbroader wings that provides a better ﬁt to observations, a model\nwhich now bears his name.\nThe surface brightness of a Moffat proﬁle varies as\nI(r)= F (β−1)\nπr2\n0\n[\n1 +(r/r0)2] −β\n(14)\nwhere F is the total ﬂux,r0 is the scale radius, andβtypically\nranges from 2 to 5. In the limitβ→ ∞, the Moffat proﬁle tends\ntowards a Gaussian.\nIt is represented in GAL SIM by theMoffatclass, and the\nsize can be speciﬁed usingr0, the full-width at half-maximum\n(FWHM), or the half-light radius. It is also possible to specify\na truncation radius for the Moffat proﬁle, rather than allowit to\nextend indeﬁnitely.\n3.2.4. The Kolmogorov proﬁle\nIn a long ground-based exposure, the PSF is predicted to fol-\nlow a particular functional form due to the Kolmogorov spec-\ntrum of turbulence in the atmosphere. Racine (1996) showed\nthat this prediction was indeed a better ﬁt to the observations of\nstars in long exposures than a Moffat proﬁle.\nThe surface brightness of a Kolmogorov proﬁle is deﬁned in\nFourier space as\n˜I(k)= F e−(k/k0)5/3\n, (15)\nwhere F is the total ﬂux,k0 = Aλ/r0,A ≃ 2.99 is a constant\ngiven by Fried (1966), and herer0 is the Fried parameter (to\nbe distinguished from the use ofr0 to denote the scale radius in\nother proﬁles). Typical values for the Fried parameter are on the\norder of 10 cm for most observatories and up to 20 cm for ex-\ncellent sites. The values are usually quoted atλ= 500 nm, and\nthe Fried parameterr0 depends on wavelength asr0 ∝ λ−6/5.\nThis proﬁle is represented in GAL SIM by theKolmogorov\nclass, and the size can be speciﬁed usingλ/r0, the FWHM, or\nthe half-light radius.\n3.3. Generic models\n3.3.1. The Gaussian proﬁle\nThe Gaussian proﬁle has convenient properties: it is rel-\natively compact and analytic in both real space and Fourier\nspace, and convolutions of Gaussian proﬁles can themselvesbe\nwritten as a new Gaussian proﬁle. Observational propertiesof\nGaussian proﬁles, such as their second moments, are also typi-\ncally analytic.\nFor this reason the Gaussian proﬁle is often used to represent\ngalaxies and PSFs in simple simulations where speed is valued\nabove realism. And thanks to its analytic properties, it hasgreat\nvalue for testing purposes. Furthermore, while a single Gaus-\nsian proﬁle is generally a poor approximation to both real PSFs\nand real galaxies, linear superpositions of Gaussian proﬁles can\nbe used to approximate realistic proﬁles with much greater ac-\ncuracy (e.g. Hogg & Lang, 2013; Sheldon, 2014).\nThe surface brightness of a Gaussian proﬁle varies as\nI(r)= F\n2πσ2 e−r2/2σ2\n, (16)\nwhere F is the total ﬂux andσis the usual Gaussian scale pa-\nrameter.\nIt is represented in GAL SIM by theGaussianclass, and\nthe size can be speciﬁed usingσ, the FWHM, or the half-light\nradius.\n3.3.2. Shapelet proﬁles\nShapelets were developed independently by\nBernstein & Jarvis (2002) and Refregier (2003) as an ef-\nfective means of characterizing compact surface brightness\nproﬁles such as galaxies or stars. The shapelets basis set\nconsists of two-dimensional Gaussian proﬁles multiplied by\npolynomials, and they have a number of useful properties. For\nexample, they constitute a complete basis set, so in theory any\nimage can be decomposed into a shapelet vector; however,\nproﬁles that are not well matched to the size of the Gaussian\nwill require very high order shapelet terms, such that the\ndecomposition is unfeasible in practice (e.g. Melchior et al.,\n2010).\nFor images that are relatively well approximated by a Gaus-\nsian, they provide a compact representation of the object, since\nmost of the information in the image is described by low order\ncorrections to the Gaussian, which is what the shapelet decom-\nposition provides.\nThe Shapeletclass in GAL SIM follows the notation\nof Bernstein & Jarvis (2002), although it is also similar to\nwhat has been called “polar shapelets” by Massey & Refregier\n(2005). The shapelet expansion is indexed by two numbers,p\nand q19:\nI(r,θ)=\n∑\np,q≥0\nbpqψσ\npq(r,θ) (17)\n19 The shapelet functions happen to be eigenfunctions of the 2Dquantum\nharmonic oscillator. In that framework,p and q count the number of quanta\nwith positive and negative angular momentum, respectively. N = p + q is the\ntotal energy andm = p −q is the net angular momentum.\n6\nψσ\npq(r,θ)= (−1)q\n√πσ2\n√\nq!\np!\n( r\nσ\n) m\neim θe−r2/2σ2\n×L(m )\nq (r2/σ2) ( p ≥ q) (18)\nψσ\nqp(r,θ)=\nψσpq(r,θ) (19)\nm ≡ p −q. (20)\nL(m )\nq (x) are the Laguerre polynomials, which satisfy the recur-\nrence relation:\nL(m )\n0 (x)= 1 (21)\nL(m )\n1 (x)= (m +1)− x (22)\n(q +1)L(m )\nq+1(x)= [(2q +m +1)− x]L(m )\nq (x)\n−(q +m )L(m )\nq−1(x). (23)\nThe functions may also be indexed byN = p + q and m =\np − q, which is sometimes more convenient. Both indexing\nconventions are implemented in GAL SIM .\nOne of the handy features of shapelets is that their Fourier\ntransforms are also shapelets:\n˜ψσ\npq(k,φ)= (−i)m\n√π\n√\nq!\np!(kσ)m eim φe−k2σ2/2\n×L(m )\nq (k2σ2) ( p ≥ q). (24)\nThis means convolving shapelets in Fourier space is very efﬁ-\ncient.\n3.3.3. Interpolated images\nIn some cases, it is useful to be able to take a given image\nand treat it as a surface brightness proﬁle. This requires deﬁning\nhow to interpolate between the pixel values at which the surface\nbrightness is sampled.\nOne application for this is the use of direct observations of\nindividual galaxies (e.g., fromHST ) as the models for further\nsimulations, already mentioned in §3.1.4. See §6.5 for more\nabout this possibility.\nAnother application was also mentioned above in §3.2.2. The\ngeneral aberrated optical PSF is too complicated to model ana-\nlytically, so theOpticalPSFclass is internally evaluated by\ninterpolation over a ﬁnite grid of samples of the surface bright-\nness proﬁle.\nThe InterpolatedImageclass converts an arbitraryn×n\nimage array with elementsIi jon pixels of sizes into a continu-\nous surface brightness distribution\nI(x,y)=\n∑\ni,j\nIi jκ(x/s−i,y/s−j), (25)\nwhere κ is a real-space kernel chosen from those listed in Ta-\nble 1. Each interpolant usesK ×K input pixel values around the\ngiven (x,y) to render a sample at that location. Rendering an\nM × M output image hence requiresK 2 M 2 operations, and the\nfootprint of theInterpolatedImageis extended byKs /2\nbeyond the original input image.\nThe delta-function kernel yields inﬁnite (or zero) values in\ndirect rendering and is hence a highly ill-advised choice for\nan InterpolatedImagethat is to be rendered without fur-\nther convolutions. The sinc kernel has inﬁnite extent and hence\nuses allN ×N input samples to reconstruct each output sample,\nleading toN 2 M 2 operations in a direct-space rendering. In a\nhigh-volume simulation this will also be ill-advised. Approxi-\nmations to the sinc kernel that provide ﬁnite support are often\nfound to give a good compromise. Examples include the kernel\nthat represents cubic and quintic (i.e. 3rd and 5th order) poly-\nnomial interpolation, and the Lanczos kernel (see Table 1, also\nBernstein & Gruen, 2014). As will be demonstrated in §9.2\nand §9.3, these higher-order interpolation kernels meet strin-\ngent performance requirements for the representation of galaxy\nimages.\n3.4. Transformations\nMany of the proﬁles we have described so far are circularly\nsymmetric and centred on the coordinate origin. GAL SIM can,\nhowever, use these proﬁles to represent (for example) ellipti-\ncal, off-centred surface brightness proﬁles. Various transforma-\ntions can be applied to a GAL SIM object representing a surface\nbrightness distributionI(x), to return a new object representing\nI′(x).\nThe overall amplitude of the proﬁle can be rescaled by some\nfactor simply by using the*operator. It is also possible to get\na rescaled proﬁle with a speciﬁed value for the new total ﬂux.\nEither way, the new proﬁle isI′(x)= cI(x) for some constantc.\nAny one-to-one transformationT of the plane deﬁnes an im-\nage transformation via\nI′(x)= I\n[\nT −1(x)\n]\n. (26)\nThe G AL SIM operationtransformimplements local linear\ntransformations deﬁned by a transformation matrixA as\nT (x)= Ax . (27)\nThis can account for any arbitrary distortion, rotation, parity ﬂip\nor expansion of the coordinate system. The user can specifyA\ndirectly; alternatively the GAL SIM operationsrotate, ex-\npand, magnify, shear,and lensimplement restricted\nversions of the transformation that are often convenient inprac-\ntice.\nThere is also a command calleddilatethat combines an\nexpansion of the linear size (i.e.A being a multiple of the iden-\ntity matrix) with an amplitude scale factor to keep the overall\nﬂux of the resulting proﬁle unchanged. This is merely a con-\nvenience function, but it is handy, since this operation is fairly\ncommon.\nFinally, theshiftfunction can translate the entire proﬁle\nby some amountx0. This corresponds to the transformation\nT (x)= x +x0. (28)\nTogether,shiftand transformenable any arbitrary afﬁne\ntransformation.\n7\nTable 1: Properties of interpolants\nName Formula Notes a No. of pointsK\nDelta δ(x) Cannot be rendered in x domain; extreme aliasing∝ 1. 0,1\nNearest 1, |x| <1/2 Aliasing ∝ k−1 1\nLinear 1 −| x|, |x| <1 Aliasing ∝ k−2 2\nCubic piecewise cubicb Common choice forK 4\nQuintic piecewise quinticb Optimized choice forK k (cf. §6.2.4) 6\nLanczos sincx sinc(x/n), |x| <n Common choice forK withn = 3–5 2n\nSincInterpolantsincx Perfect band-limited interpolation; slowest ∞\naCoordinate distance from the origin in Fourier space is denotedk.\nbFormulae forCubicand Quinticinterpolants are given in the Appendix to Bernstein & Gruen (2014).\nAll of these operations are implemented in GAL SIM via a\nwrapper object that exists independently of, and interfaces with,\nthe original proﬁle. This means the code for implementing\nthese transformations (e.g. the effect in Fourier space, orthe de-\nﬂections to apply for photon shooting, see §6.3) exists in a sin-\ngle place, which helps minimize unnecessary duplication and\nensure the reliability of the transformation routines.\nFor reasons discussed in §6, GAL SIM does not currently han-\ndle non-afﬁne transformations acting on a single proﬁle (asre-\nquired by simulations of ﬂexion such as Velander et al., 2011;\nRowe et al., 2013), but see §5 for how to handle such coordi-\nnate transformation across a full image, using the appropriate\nlocally linear approximation at the location of each object.\n3.5. Compositions\nTwo or more individual surface brightness proﬁles may be\nadded together using the+operator to obtain a proﬁle with\nI′(x)= I1(x)+I2(x)+... .\nThe convolution of two or more objectsI1,I2 is deﬁned as\nusual via\nI′(x)= (I1 ◦I2)(x)=\n∫\nI1(x′)I2(x −x′) d2x′. (29)\nThis is implemented in GAL SIM with theConvolvefunction,\nwhich takes a list of two or more objects to be convolved to-\ngether.\nThere are also two special functions that can afford some\nmodest efﬁciency gains if they apply.AutoConvolveper-\nforms a convolution of an object with itself, i.e. withI2(x) =\nI1(x) in equation (29).AutoCorrelateperforms a con-\nvolution of an object with a 180◦ rotation of itself, i.e. with\nI2(x)= I1(−x).\nFinally, GAL SIM can implement a deconvolution as well.\nThis lets users solve for the solutionI′ to the equationI1 =\nI′ ◦I2, which in Fourier space is simply\n˜I′(k)= ˜I1(k)/˜I2(k) (30)\nThe functionDeconvolveimplements the inverse of a proﬁle\n(e.g.I2 above) in Fourier space, which is a deconvolution in\nreal space. The returned object is not something that can be\nrendered directly. It must be convolved by some other proﬁleto\nproduce something renderable (I1 in this example).\nOne common use case for this is to deconvolve an observed\nimage (represented by anInterpolatedImageobject) by\nits original PSF and pixel response, producing an object that\nwould then be reconvolved by some other PSF corresponding to\na different telescope and rendered on an image with a new pixel\nscale. This is the functionality at the heart of GAL SIM ’s imple-\nmentation of the reconvolution algorithm described in §6.5and\nused by theRealGalaxyclass (§3.1.4). As will be discussed\nin §6.5, the latter PSF must be band-limited at a lower spatial\nfrequency than the original (deconvolved) PSF to avoid serious\nartifacts in the ﬁnal image.\n3.6. Chromatic objects\nReal astronomical stars and galaxies have wavelength-\ndependent intensity distributions. To model this, it is possible in\nG AL SIM to deﬁne objects whose surface brightness is a func-\ntion not only of position, but also of wavelength. These objects\ncan then be rendered as seen through a particular bandpass (the\nthroughput as a function of wavelength).\nThe simplest of the wavelength-dependent classes is the\nChromaticclass, which is constructed from an achromatic\nproﬁle (i.e. any of the proﬁles described above) and a Spec-\ntral Energy Distribution (SED). The SED deﬁnes a wavelength-\ndependent ﬂux for the object.\nChromatic objects can be transformed, added, and convolved\nusing precisely the same syntax as for achromatic objects. The\naddition of multiple chromatic objects provides a simple way to\ncreating galaxies with non-trivial wavelength-dependentmor-\nphologies. A bulge and a disk can have different SEDs; star\nforming regions or HII regions can also be added in with their\nown SEDs.\nIn addition, the various transformations can take functions of\nwavelength for their arguments. For example, differentialchro-\nmatic refraction is implemented by a wavelength-dependent\nshift, and the effects of chromatic variation in Kolmogorov\nturbulence can be approximately modelled with a wavelength-\ndependent dilation. GAL SIM provides the helper function\nChromaticAtmosphere, which encapsulates both of these\neffects for an atmospheric PSF.\nA more detailed discussion of this recent addition to\nthe G AL SIM toolkit is reserved for future work, but it\nprovides a valuable resource for simulating a number of\nimportant wavelength-dependent effects in cosmology (e.g.\n8\nCypriano et al., 2010; V oigt et al., 2012; Plazas & Bernstein,\n2012; Semboloni et al., 2013; Meyers & Burchat, 2014).\n4. Lensing shear and magniﬁcation\nA primary purpose of GAL SIM is to make simulated images\nthat can be used to test weak gravitational lensing data analy-\nsis algorithms, which means that a framework for simulating\nlensing shear and convergence (see, e.g., Schneider, 2006,for\na review) is critical. In the weak gravitational lensing limit, the\ntransformation between unlensed coordinates (xu,yu; with the\norigin taken to be at the center of a distant galaxy light source)\nand the lensed coordinates in which we observe galaxies (xl,yl;\nwith the origin at the center of the observed image) is linear:\n( xu\nyu\n)\n=\n( 1 −γ1 −κ −γ2\n−γ2 1 +γ1 −κ\n)( xl\nyl\n)\n. (31)\nHere we have introduced the two components of lensing shear\nγ1 and γ2, and the lensing convergenceκ. The shear describes\nthe anisotropic stretching of galaxy images in weak lensing.\nThe convergenceκ describes an isotropic change in apparent\nobject size: areas of the sky for whichκ is non-zero have ap-\nparent changes in area (at ﬁxed surface brightness). Lensing\nmagniﬁcation is produced from a combination of the shear and\nconvergence.\nIt is worth noting that even whenκ = 0 the transformation\nmatrix in equation (31) will not have a unit determinant in gen-\neral. Object area (and thus ﬂux when conserving surface bright-\nness) is therefore not conserved by weak lensing shear, an effect\nwhich is not always desired when simulating images. For con-\nvenience, GAL SIM implements a unit determinant shear trans-\nformation that conserves object area, while also implement-\ning the non-area conserving shear deﬁned by the weak lensing\ntransformation of equation (31).\nIn the simplest use case, GAL SIM will take single values for\nthe lensing shear and convergence and apply them to objects.In\naddition, however, GAL SIM is able to generate ﬁelds of coher-\nent shear and convergence values corresponding to two physical\nscenarios described below: cosmological weak lensing ﬁelds\nwith some power spectrum, and the weak lensing that arises\nfrom a spherical NFW halo (Navarro, Frenk, & White, 1996).\n4.1. Cosmological lensing ﬁelds\nG AL SIM provides routines to simulate a Gaussian random\nﬁeld approximation to a cosmological lensing signal, charac-\nterized wholly by its power spectrum. In reality, shear and con-\nvergence ﬁelds show signiﬁcant non-Gaussianity. The inten-\ntion, therefore, is not highly cosmologically accurate shear and\nconvergence ﬁelds, such as would be suitable for an end-to-end\ntest of cosmological parameter determination. The intention is\nrather to provide basic functionality for making semi-realistic,\nspatially varying lensing ﬁelds so as to be able to test measure-\nment algorithms that ﬁnd such regimes challenging in general.\nThere is nothing to prevent any user from using outputs\nfrom a more realistic cosmological ray-tracing simulation(e.g.\nBecker, 2013) to create an observed galaxy shape catalog that\nincludes a realistic shear and convergence ﬁeld. If realismis\nrequired, this procedure should be followed.\n4.1.1. Basic capabilities\nAny shear ﬁeld can be projected into orthogonalE - andB-\nmode components, named for their similarity to the electromag-\nnetic vector ﬁelds with zero curl and zero divergence, respec-\ntively (see, e.g. Schneider, 2006; Mandelbaum et al., 2014).\nG AL SIM is capable of taking inputE - andB-mode shear power\nspectra as user supplied functions, and generating random re-\nalizations of shear and convergence ﬁelds drawn from those\npower spectra. The basic functionality is carried out by the\nPowerSpectrumclass. Shears are generated on a grid of\npositions, but GAL SIM can interpolate to arbitrary positions\nwithin the bounds of the grid using the interpolants discussed\nin §6.2.\nObservable quantities such as the shear correlation functions\nare deﬁned using the vectors connecting pairs of galaxies atsep-\narationθ,\nξ±(θ)= ξ++(θ)±ξ××(θ) (32)\n=\n∫∞\n0\n1\n2π[P E (k)±P B (k)]J0/4(kθ)k dk (33)\nwhere J0/4 denotes the 0th and 4th Bessel function of the\nﬁrst kind, as is appropriate forξ+ and ξ−, respectively. See\nSchneider et al. (2002) for more details about relating the cor-\nrelation functions to theE - andB-modes of the ﬂat-sky power\nspectra20.\nFor cosmological shear correlationsP B ≃ 0 to a very good\napproximation, although higher order effects (e.g. sourcered-\nshift clustering) can introduce physical B-modes (see, e.g.,\nSchneider, 2006). It is useful to includeP B when generating\nshears for other purposes, such as when drawing atmospheric\nPSF anisotropies according to some power spectrum (which\ntypically requires similar amounts ofE and B power). Here\nP E (k) andP B (k) have dimensions of angle2; GAL SIM can ac-\ncept the power spectra in various formats and sets of units.\nThese deﬁnitions of observables rely on continuous Fourier\ntransforms, but in practice we implement the calculations us-\ning discrete Fourier Transforms (DFT), and we must be care-\nful about the DFT conventions. We assume we have a grid\nwith lengthL along one dimension and spacingd between grid\npoints. Given a Fourier-space grid of size consistent with that\nof the input real-space grid, the minimum and maximum one-\ndimensional wavenumbers|k| on the grid arekmin = 2π/L and\nkmax = π/d. The lensing engine ﬁnds the powerP(k) according\nto the value ofk =\n√\nk2\n1 +k2\n2 on the grid, draws random ampli-\ntudes from a Rayleigh distribution based on√P(k) and random\nphases from a uniform distribution, and transforms back to our\nreal-space grid to get the real-space shear ﬁeld, with periodic\nboundary conditions. The standard deﬁnition of the correlation\nfunction (Eq. 33) uses the angular frequency, non-unitary deﬁ-\nnition of the 1D Fourier transform:\n˜f(k)=\n∫∞\n−∞\nf(x)e−ikx dx ≡ F{ f(x)}; (34)\n20Many standard references regarding lensing power spectra work in terms\nof the spherical harmonicsℓ, with the power spectrum denotedC ℓ. In the ﬂat-\nsky limit we can simply swapℓwith wavenumberk and C ℓ withP(k).\n9\nf(x)= 1\n2π\n∫∞\n−∞\n˜f(k)eikx dk ≡ F −1{˜\nf(k)}. (35)\nIf we trace through the impact of this convention on the discrete,\nﬁnitely-sampled power spectrum, then our use of the NUM PY 21\npackage for Fourier transforms (with the more common unitary\ndeﬁnition of the DFT) necessitates various normalization fac-\ntors related to the input grid conﬁguration. For further details,\nsee Appendix A.\n4.1.2. Implementation details\nAny DFT-based algorithm to generate shears according to\na power spectrum is subject to limitations due to the implicit\nchoice of a ﬁnite range in wavenumber and the difference be-\ntween a discrete and continuous Fourier transform. GAL SIM\nincludes options to ameliorate these limitations:\n• G AL SIM can optionally decrease (increase) the minimum\n(maximum) value ofk by internally expanding (contract-\ning) the real-space grid before generating shears. This\nhelps avoid problems with missing shear power on vari-\nous scales; in the case of cosmological power spectra it is\nparticularly recommended for those who wish to properly\nreproduce the large-scale shear correlation function (on\nscales comparable to∼ 1/4 the total grid extent). There\nis an important tradeoff implicit in the use of these op-\ntions: the power spectra that result from using internally\nenlarged grids is not strictly the same as the input one, and\nthere can beE and B mode leakage as a result of using\nthese options.\n• G AL SIM has a utility to predict the shear correlation func-\ntion resulting from the use of a limitedk range when gen-\nerating shears. While the output is not exactly what will be\ngenerated in reality since the algorithm does not account\nfor the use of a DFT, it permits users to assess in advance\nwhether their grid choices permit them to roughly repro-\nduce shear correlations on the scales they want.\n• A natural consequence of the limitedk range is that alias-\ning can occur if users supply a power spectrum with power\nbelow the grid Nyquist scale. GAL SIM shear generation\nroutines can optionally band-limit the input power spec-\ntrum by applying a hard or soft cutoff at the Nyquist scale\nto avoid aliasing.\n4.1.3. Interpolation to non-gridded positions\nAfter building a grid of shears and convergences, users can\ninterpolate them to arbitrary positions within the grid. However,\nwhen using this functionality, some care must be employed to\nprevent the interpolation procedure from spuriously modifying\nthe shear power spectrum or correlation function at scales of\ninterest.\nThe key effect of interpolation is to multiply the shear power\nspectrum by a quantity proportional to the square of the Fourier\n21http://www.numpy.org/\ntransform of the interpolant. As a result, we found that all inter-\npolants modify the shear 2-point functions in a signiﬁcant way\n(>10% but sometimes much more) for scales below 3 times the\noriginal grid spacing. Thus, when interpolating shears to ran-\ndom points, the grid spacing should be chosen with care, keep-\ning in mind the minimum scale above which the shear two-point\nfunctions should be preserved. Edge effects can also be impor-\ntant depending on the intended use for the resulting interpolated\nshears and the choice of interpolant (see Table 1; §3.3.3).\n4.2. Lensing by individual dark matter halos\nThe NFWHaloclass can produce shears and convergences\ncorresponding to a dark matter halo following a spherical NFW\n(Navarro et al., 1996) proﬁle, using analytic formulae from\nBartelmann (1996) and Wright & Brainerd (2000). The formu-\nlae depend on the cosmology being assumed, which in GAL SIM\nis allowed to be an arbitraryΛCDM cosmology. It would not\nbe difﬁcult to extend this to more sophisticated cosmological\nmodels.\nThe NFW lensing halo is deﬁned in terms of its mass, con-\ncentration, redshift, and position in the image. Then for any\ngiven position and redshift of the source galaxy to be lensed, the\nappropriate lensing quantities can be computed analytically. It\nis, however, important to note that the implementation in GAL -\nSIM adopts the coordinate frame of the observed galaxies, i.e.\nno deﬂection angles are calculated or applied to galaxy posi-\ntions. As a consequence the density of galaxies behind NFW\nhalos is not altered as would happen in nature. If needed, e.g.\nfor studies of magniﬁcation from galaxy clusters, this effect\nshould be taken into account.\n5. World coordinate systems\nThe galaxy models described above are generally deﬁned in\nterms of angular units on the sky. For example, a Sérsic proﬁle\nmight be constructed to have a half-light radius of 1.6 arcsec.\nBefore rendering this object onto an image, one must specify\nhow the image pixel coordinates relate to sky coordinates (also\nknown as world coordinates).\nThe simplest such relationship is to assign a pixel scale to the\nimage, typically in units of arcsec/pixel. However, this isnot\nthe only possible such relationship; in general, the “worldcoor-\ndinates” on the sky can be rather complicated functions of the\nimage coordinates. GAL SIM allows for a variety of “world co-\nordinate systems” (WCS) ranging from a simple pixel scale to\nthe kinds of WCS functions typically found in the FITS (Flex-\nible Image Transport System, see e.g. Pence et al., 2010) head-\ners of real data images.\n5.1. Types of WCS functions\nThe WCS classes used by GAL SIM can be broken into two\nbasic types: celestial and euclidean coordinate systems.\nCelestial coordinate systems are deﬁned in terms of right as-\ncension (RA) and declination (Dec). In GAL SIM this kind of\nWCS is represented by subclasses ofCelestialWCS. This\n10\nincludesRaDecFunction, which can represent any arbi-\ntrary function the user supplies for RA(x,y) and Dec(x,y), and\nFitsWCS, which reads in the WCS information from a FITS\nheader.\nEuclidean coordinate systems are deﬁned relative to a tangent\nplane projection of the sky. Taking the sky coordinates to be\non an actual sphere with a particular radius, the tangent plane\nwould be tangent to that sphere. We use the labels (u,v) for the\ncoordinates in this system, where+v points north and+u points\nwest22.\nIn GAL SIM this kind of WCS is represented by subclasses of\nEuclideanWCS. The most general isUVFunction, which\ncan represent any arbitrary function the user supplies foru(x,y)\nand v(x,y).AffineTransformis the most generaluniform\ncoordinate transformation where all pixels have the same size\nand shape, but that shape is an arbitrary parallelogram.\nOther classes representing restricted specializations of\nAffineTransformare available. The simplest one,Pix-\nelScale, describes uniform square pixels. To date, this\nis what has been used in simulations testing shear mea-\nsurement methods, including the most recent GREAT3 chal-\nlenge (Mandelbaum et al., 2014), as well as all previous shear\ntesting projects (Heymans et al., 2006; Massey et al., 2007;\nBridle et al., 2010; Kitching et al., 2012, 2013). GAL SIM there-\nfore makes it easy to ignore all of the WCS options and just use\na pixel scale instead. Any function that can take a WCS param-\neter, can also take a pixel scale parameter, which is interpreted\nas aPixelScaleWCS.\n5.2. Converting proﬁles\nIt is relatively straightforward to convert a surface brightness\nproﬁle from the sky coordinates in which it is deﬁned to image\ncoordinates. We only need to assume that the ﬁrst derivatives\nof the WCS functions are approximately constant over the size\nof the object being modelled, which is generally a safe assump-\ntion. That is, we use the local linear approximation of the WCS\ntransformation at the location of the object. Currently, GAL SIM\ncannot accurately handle transformations that vary signiﬁcantly\nover the size of the proﬁle being rendered; in fact this opera-\ntion would be very similar to what is required for implementing\nﬂexion, and would most simply be incorporated in the context\nof photon shooting (see §6.3).\nThe ﬁrst step if we are dealing with a celestial coordinate\nsystem is to do a local tangent projection at the position of the\nobject. Speciﬁcally, we use the TAN projection described by\nCalabretta & Greisen (2002), but it is likely that any of the tan-\ngent plane projections discussed in that work would providean\nequivalent conversion to a local Euclidean coordinate system.\nThe next step is to calculate the Jacobian of the WCS at the\nlocation of the object:\nJ =\n( du/dx du/dy\ndv/dx dv/dy\n)\n(36)\n22This can be counterintuitive to some, but it matches the viewfrom Earth.\nWhen looking up into the sky, if north is up, then west is to theright.\nThis Jacobian deﬁnes the local afﬁne approximation of the\nWCS at the location of the object, which we assume we can\ntake as uniform over the extent of the proﬁle we need to con-\nvert.\nApplying a general Jacobian transformation in GAL SIM was\ndescribed above in §3.4. Here, we are transforming from (u,v)\nto (x,y), which means the transformation to be applied is really\nJ−1. To preserve the total ﬂux of the proﬁle, we also need to\nmultiply the resulting proﬁle by|detJ|.\nThe G AL SIM WCS classes have functionstoImageand\ntoWorldthat effect the conversion in either direction, using\nwhatever subset of the above steps are required for the given\nWCS. If the WCS transformation is not uniform (so it matters\nwhere the object is in the image), then the position of the object\n(in either coordinate system) must be speciﬁed.\n5.3. Integrating over pixels\nWhile the galaxy proﬁles are naturally deﬁned in world co-\nordinates, the pixel response is most naturally deﬁned in image\ncoordinates, where it can typically be modelled as a unit square\ntop hat proﬁle. The PSF proﬁle may be more naturally consid-\nered in either coordinate system depending on where the model\nis coming from. Thus, careful attention is required to handle all\nof these correctly when using a complicated WCS.\nWe start by ignoring the PSF to show how to properly han-\ndle a galaxy drawn onto uniform square pixels of dimension\ns in an image (corresponding to aPixelScaleWCS). Let\nthe galaxy surface brightness be given in world coordinatesas\nIw (u,v). According to the methods in the previous section, the\ncorresponding proﬁle in image coordinates would be\nIi(x,y)= s2Iw (xs,ys) (37)\nwhere s2 is the|detJ| factor mentioned above, which ensures\nthat the integral of each version of the proﬁle gives the same\ntotal ﬂux.\nThe pixel response in the two coordinate systems is given by\na 2-dimensional top hat function with unit ﬂux:\nPw (u,v)= T s(u,v)≡\n\uf8f1\n\uf8f4\n\uf8f4\n\uf8f2\n\uf8f4\n\uf8f4\n\uf8f3\n1\ns2 |u|<s/2,|v|<s/2\n0 otherwise (38)\nPi(x,y)= T1(x,y) (39)\nin world and image coordinates respectively, where in the latter\nthe pixel size is, by deﬁnition, equal to 1.\nWhen observed on an image, the galaxy’s surface brightness\nproﬁle is integrated over the area of the pixel. In a particular\npixel (i, j), the integrated ﬂuxIi jis\nIi j=\n∫is+s/2\nis−s/2\n∫ js+s/2\njs−s/2\nIw (u,v) du dv (40)\n=\n∫+∞\n−∞\n∫+∞\n−∞\ns2Iw (u,v)Pw (is−u, js−v) du dv (41)\n= s2(Iw ◦Pw )(is, js) (42)\n=\n∫+∞\n−∞\n∫+∞\n−∞\nIi(x,y)Pi(i−x, j−y) dxdy (43)\n11\n= (Ii ◦Pi)(i, j) (44)\nWe thus ﬁnd thatIi jis the convolution of the galaxy proﬁle with\nthe pixel response evaluated at the centre of the pixel, and then\nmultiplied by the pixel area. Furthermore, this calculation can\nbe done in either coordinate system. This well-known result\n(e.g. Lauer, 1999) is the basis of how GAL SIM implements the\nintegration of a surface brightness proﬁle over the pixel area.\nFor more complicated WCS functions, we can still apply the\nsame procedure. We either convert the galaxy proﬁle to image\ncoordinates and convolve by a unit square pixel, or convert the\nunit square pixel to world coordinates and do the convolution\nthere. In GAL SIM thedrawImagemethod that performs the\nrendering has access to the WCS of the image, and this convolu-\ntion is handled automatically. The pattern adopted in the code is\nto transform the galaxy proﬁle into image coordinates and then\nconvolve by a unit square pixel, but the converse would have\nbeen equally valid.\nFor the PSF, when using a non-trivial WCS, some care is re-\nquired regarding the coordinate system in which the PSF proﬁle\nis deﬁned. The processes that cause the image coordinates to\nbecome distorted from a square pixel are related to the causes\nof the PSF, namely the atmosphere and the optics of the tele-\nscope. Therefore, when choosing to apply a distorted WCS,\ncare is needed about whether the PSF is deﬁned in world or im-\nage coordinates. If it is deﬁned in image coordinates, then it\nshould be converted to world coordinates (as described in §5.2)\nprior to convolution by the galaxy proﬁle.\nFinally, if a PSF is measured from an image, such as a real\ndata image of a star, then it already includes a convolution by\na pixel response23. To apply this consistently to simulated data\nusing the same WCS and pixel scale, an additional convolution\nby a pixel should not be applied, since that would effectively\nconvolve by the pixel response twice. This kind of rendering\nwithout the extra pixel convolution is possible in GAL SIM using\ntheno_pixeloption ofdrawImage.\n6. Image rendering\nA given object can be rendered onto an image (“drawn”)\nthrough three methods in GAL SIM : direct drawing in real\nspace; drawing via discrete Fourier transform (DFT); or draw-\ning via “photon shooting,” whereby the surface brightness pro-\nﬁle is treated as a probability distribution, and a ﬁnite number\nof “photons” sampled from this distribution are “shot” ontothe\nimage.\nIn principle all three rendering methods should be equivalent,\napart from the shot noise that is inherent to the photon-shooting\nmethod. However, there is one additional difference that is\nworth noting. The photon-shooting method bins the photons\naccording to the pixels they fall into and hence automatically\n23 It is possible to remove the pixel response from the PSF imagewith the\nDeconvolveoperator in GAL SIM which deconvolves by the original pixel.\nThis will only be numerically viable if the resulting objectis drawn onto an\nimage with pixels that are either the same size or (preferably) larger.\nintegrates the proﬁle over the pixels. Thus, theno_pixelop-\ntion ofdrawImagementioned above in §5.3 will always use\neither direct rendering or DFT as appropriate.\nThere are in practice also further minor differences between\nthe rendered output of the different methods that are due to ap-\nproximations inherent to each technique. These we highlight\nbelow.\nNot all objects can be rendered with all three methods. In par-\nticular, convolution in real space is only implemented for con-\nvolution of two proﬁles, one of which is typically the pixel re-\nsponse (cf. §6.1.5). Deconvolution (see §3.5; §6.5) is onlypos-\nsible with the DFT method. Non-afﬁne transformations such\nas ﬂexion (Goldberg & Bacon, 2005; Irwin & Shmakova, 2005;\nBacon et al., 2006) cannot be done in Fourier space; ﬂexion is\nnot currently implemented in GAL SIM for this reason. Table 2\nsummarizes the advantages and disadvantages of each render-\ning method.\n6.1. Direct rendering\nThe default way to draw an object in GAL SIM is to integrate\nits surface brightness over the pixel response by convolving the\nobject’s proﬁle with a square pixel (cf. §5.3). This means the\nobject that is actually being drawn will really be a convolution,\nwhich is normally rendered using the DFT method (§6.2).\nHowever, it is possible to tell GAL SIM not to convolve by\nthe pixel and instead draw the proﬁle directly by sampling the\nsurface brightness at the centre of each pixel. This is the easiest\nrendering method to understand, so we describe it ﬁrst. But\nof course, it does not directly correspond to a real image, so\nthe sum of the pixel values may not match the input ﬂux, for\ninstance.\n6.1.1. Analytic objects\nIf an analytic surface brightness proﬁle is drawn without con-\nvolving by the pixel response, GAL SIM will use direct render-\ning, which just involves calculatingI(x,y) at the location of\neach output pixel. The formulae forI(x,y) for our various an-\nalytic objects were given in §3, and they are summarized in\nTable 3.\nMany objects have an analytic formula in real space, so\nthe direct rendering is straightforward. However, theKol-\nmogorovproﬁle is only analytic in Fourier space, so the im-\nplementation ofI(r) in real space uses a cubic spline lookup\ntable for the Hankel transform of˜I(k). This calculation is done\nthe ﬁrst time aKolmogorovobject is instantiated and saved\nfor any further instantiations, so the setup cost is only required\nonce.\nFor the radially symmetric proﬁles, we can take advantage\nof the known symmetry to speed up the calculation. There are\nalso usually vectorization techniques that lead to furtherim-\nprovements in efﬁciency.\n6.1.2. Shapelet proﬁles\nThe shapelet functions are not radially symmetric, but the\ncode to directly renderShapeletobjects uses fast recurrence\nrelations for the shapelet functions given in Bernstein & Jarvis\n12\nTable 2: Characteristics of different rendering methods\nCharacteristic Direct real-space Fourier Photon shooting\nOperations for setupa 0 O (N 2 logN ) O (N 2 logN )\nOperations for renderinga O (N 2) O (N 2 logN ) O (N γ logN )\nOperations for additiona O (N 2) O (N 2) O (N γ)\nOperations for convolutiona O (N 4)b O (N 2) O (N γ)\nOperations for deconvolutiona impossible O (N 2) impossible\nEasy to apply afﬁne transformations? yes yes yes\nEasy to apply non-afﬁne transformations? yes no yes\nInaccuracies - band-limiting, folding shot noise, truncation\nFastest for analytic objects high S/N low S/N\naFor operation counts,N is the typical linear size of an input or output image, andN γ is the number of photons traced during photon shooting.\nbDirect rendering can only handle convolution of two proﬁles.\nTable 3: Analytic GAL SIM objects\nClass name Real-space formula a Fourier-space formulaa Photon-shooting methodb\nExponential e−r/rs\n(\n1 +k2r2\ns\n) −3/2\nInterval\nDeVaucouleurse−7.669(r/re)1/4\nLUT Interval\nSersic e−b(n)(r/re)1/n\nLUT Interval\nAiry\n[ J1(ν)−ǫJ1(ǫν)\nν\n] 2\n, ν = πrD /λ Analyticc Interval\nMoffat\n(\n1 + r2\nr2\n0\n) −β\nLUT d Analytic\nKolmogorov LUT e−(k/k0)5/3\nInterval\nGaussian e−r2/2σ2\ne−k2σ2/2 Analytic\nShapelet See §3.3.2 See §3.3.2 Not implemented\nPixel 1,|x| < s/2,|y| < s/2 sinc( skx) sinc(sky) Analytic\naNormalization factors have been omitted from the given formulae for brevity; the integral of the real-space proﬁle and the k = 0 value in Fourier space should both\nequal the ﬂuxF of the object. “LUT” means that the function requires integrations that are precomputed and stored in a cubic-spline look-up table.\nbThe photon-shooting methods are the following: “Analytic”means that photon locations are derived from a remapping of one or more uniform deviates intox;\n“Interval” involves a combination of weighting and rejection sampling, as described in Section 6.3; “Not implemented”means that GAL SIM cannot currently\nrender this with photon shooting.\ncFourier representation of the Airy function with obscuration is analytic but too complex for the table.\ndFor genericβvalues, a lookup table is used. However, some particular values ofβhave analytic Fourier-space formulae, which GAL SIM uses in these cases.\n13\n(2002), which vectorize conveniently when applied to the pixels\nin the image. They are thus also relatively efﬁcient to draw.\n6.1.3. Interpolated images\nInterpolatedImageobjects are usually the slowest to\ndirectly render, since equation (25) involves a sum over a num-\nber of the original pixels for each output pixel value, the exact\nnumber depending on the interpolant being used (see Table 1).\n6.1.4. Transformations\nAll of the transformations described in §3.4 are very simple\nto apply when directly rendering. The value of the transformed\nproﬁle, including all three kinds of effects, is simply\nI′(x)= c I\n[\nA −1(x −x0)\n]\n. (45)\nwhere I(x) is the original proﬁle.\n6.1.5. Compositions\nDirectly rendering a sum of proﬁles is trivial, since each pro-\nﬁle can be rendered individually, adding the ﬂux to whatever\nhas already been rendered.\nThe rendering of a convolution is almost always done via\nDFT or photon-shooting methods. However, when convolving\ntwo objects that are both known to have high-frequency con-\ntent, such that an unaliased DFT is impractical, GAL SIM may\nelect to render it directly through a Gauss-Kronrod-Patterson\nevaluation of the convolution integral, equation (29).\nGenerally such circumstances do not represent any physi-\ncally realizable image, since real telescopes and detectors lead\nto band-limited images. However, in simulated images, it can\nhappen if two objects being convolved both have hard edges.\nHere, a “hard edge” means a place where the surface brightness\nabruptly drops from some ﬁnite value to zero. For example a\nPixelconvolved with a truncatedMoffatproﬁle would by\ndefault be convolved using direct integration. In this and simi-\nlar cases, the direct integration is generally both faster and more\naccurate.\n6.2. Discrete Fourier transform rendering\nWhen rendering images that include convolution by a pixel\nresponse (and often other proﬁles such as a PSF), GAL SIM uses\nDFTs by default.\n6.2.1. Band limiting and folding\nTo sample a surface brightness proﬁleI(x) onto anM × M\ngrid with sample pitch∆x via DFT, we will need to know its\nFourier transform˜I(k) at all points withkx,ky being multiples\nof∆k = 2π/(M ∆x). If any frequency modes are present in˜I(k)\nbeyond the Nyquist frequencyπ/∆x of the output grid these\nwill be aliased in the output image, as required for the correct\nrendering of undersampled data.\nThe input to the DFT will be theM × M Hermitian array of\nFourier coefﬁcients summed over all aliases:\n˜ai j=\n∑\np,q\n˜I[ (i+ pM )∆k,(j+qM )∆k)] ,\n− M /2 ≤ i, j< M /2. (46)\nThese sums must be truncated at some ﬁnite (p,q) range. We\nmust select a spatial frequencykmax such that we approximate\n˜I(kx,ky) = 0 for|kx| > kmax or |ky| > kmax . Any real telescope\nproduces bandlimited images, transmitting zero power beyond\na wave vector ofkmax = 2πD /λ, whereD is the maximum en-\ntrance aperture dimension andλis the wavelength of observa-\ntion. For space-based observations we are typically creating im-\nages sampled near the Nyquist scale ofλ/2D for this frequency,\nand we can run the sum (46) over all physically realizable fre-\nquencies without approximation.\nFor ground-based observations, the PSF is typically much\nlarger than the diffraction limit, and the pixel scale has Nyquist\nfrequency well below the physicalkmax . To render images\nwith acceptable speed it is often necessary to approximate the\nFourier transform˜I(k) as being identically zero beyond a cho-\nsen kmax . This is called band-limiting the image. Common\nidealizations of PSFs, such as the Gaussian, Moffat, and Kol-\nmogorov functions, are unbounded ink, and therefore we must\nselect akmax which yields an acceptable approximation.\nEvery kind of surface brightness proﬁle in GAL SIM is able\nto calculate and return itskmax , which we take to be the value\nofk where the Fourier-domain proﬁle drops below a threshold\nof 10−3 of the peak. See §6.4 for more detail about the param-\neter (maxk_threshold) that controls this value. For some\nproﬁleskmax can be calculated analytically; where this is not\npossiblekmax is determined numerically using an appropriate\nmethod for each proﬁle.\nAnother characteristic of the DFT is that each output value\nIi j= I(i∆x, j∆x) is actually the true function folded at the pe-\nriodP = M ∆x = 2π/∆k:\nIi j=\n∑\np,q\nI(i∆x + pP, j∆x +qP ). (47)\nSince it is impossible forI(x) to be compact after being band-\nlimited, this leads to some degree of inaccuracy due to folding\nof the image. We can limit the aliasing errors by ensuring that\nevery DFT is done with a sufﬁciently large period. Every sur-\nface brightness proﬁle in GAL SIM also knows whatkstepvalue\nshould be used for the DFT (cf.folding_thresholdin\n§6.4). The DFT is executed with periodP ≥ 2π/kstep, implying\n∆k ≤ kstepand M ≥ 1/kstep∆x.\nIf the user has requested rendering of an image that does not\nmeet this criterion, GAL SIM will execute the DFT on a grid of\nlargerM that does, and then extract the output image from the\nresult of this larger DFT. If the user does not specify an image\nsize, GAL SIM will select a value that satisﬁes this bound.\nThe DFT image must have dimensionM ≥ 2kmax /kstep. Some\nof the GAL SIM proﬁles contain sharp features that cause this\nminimum M to exceed the maximum allowed DFT size, in par-\nticular thePixelclass and theSersicclass with higher in-\ndices, including theDeVaucouleursclass. GAL SIM will\nraise an error if one attempts to render such an object via DFT\nwithout ﬁrst convolving by another object that attenuates the\nhigh-frequency information. This should not be an issue for\nrendering of realistic images, in which convolution with the\n14\nPSF and pixel response will typically limit the bandwidth of\nthe image to a manageable value.\n6.2.2. Analytic objects\nTable 3 lists the proﬁles for which GAL SIM calculates\nFourier-domain values analytically.\nFor those radial proﬁles without fast analytic formulae in\nFourier domain, we tabulate numerical transforms into a lookup\ntable and use cubic spline interpolation to return˜I(k). The ini-\ntial setup of these tables can take some time, but they are cached\nso that later Fourier-domain evaluations of the same type ofpro-\nﬁle are accomplished in constant time.\nAt small values ofk = |k| we generally replace the spline\ninterpolation with an analytic quadratic (or higher) orderTay-\nlor expansion of˜I(k), because the behaviour of˜I(k) near the\norigin has a strong effect on the appearance of poorly-resolved\nobjects. In particular the second derivative of˜I(k) determines\nthe second central moments that are critical for measurement\nof weak gravitational lensing, and the spline interpolation can\nproduce incorrect derivatives at the origin.\n6.2.3. Shapelet proﬁles\nSince shapelets are their own Fourier transforms (cf. equa-\ntion (24)), the code to draw aShapeletobject in Fourier\nspace is essentially identical to the code to directly render it. It\nuses fast recurrence relations, which are efﬁcient when applied\nto the pixels in the Fourier image.\n6.2.4. Interpolated images\nGiven anN ×N array of samples at pitch∆x, we can perform\na DFT to yield samples of the Fourier transform at a grid of val-\nues ki j= (i/N ∆x, j/N ∆x). To render this function back onto a\ndifferentx-domain grid, or to execute transformations, we need\nto evaluate˜I(k) at arbitraryk between the grid of DFT values.\nThis requires somek-space interpolation scheme.\nFurthermore we need to account for the facts that (a) the in-\nterpolated image is ﬁnite in extent, while the DFT will yieldthe\ntransform of a periodic function, and (b) it represents a contin-\nuous, interpolated version of the input sample grid. Thus two\ndistinct interpolants are required: thex-domain interpolantK x\nis chosen by the user and is part of the deﬁnition ofI(x); thek-\ndomain interpolantK k is used to generate˜I(k) by interpolating\nover the DFT of the input image and the Fourier transform of\nK x.\nCorrect evaluation of the interpolated function ink-space is\nnot trivial. Bernstein & Gruen (2014) present a detailed de-\nscription of the steps required, and we summarize their results\nhere. First, they ﬁnd that the rigorously correct form ofK k is\na sinc function wrapped at the extent of thex → k DFT. Since\nthis interpolant spans the entire plane, it means that the inter-\npolation of˜I(k) to all theM × M points needed for the DFT\nrequiresN 2 M 2 operations, which can be prohibitively slow. As\na consequence we normally elect to approximate this using a\ncompact interpolant forK k.\nBernstein & Gruen (2014) demonstrate that the conse-\nquences of this interpolation are a slight multiplicative scaling\nof the image, plus the generation of 4 “ghost images” displaced\nby N ∆x along each axis. They ﬁnd that these artifacts can be\nreduced below 0.001 of the input ﬂux by a combination of zero-\npadding the input image by 4× in each direction before con-\nducting thex → k DFT, producing a denser set of samples in\nk space, and then using a custom-designed, 6-point piecewise\nquintic polynomial interpolant forK k. This recipe is the default\nfor Fourier-domain rendering of theInterpolatedImage\nin GAL SIM . Users can override the default 4-fold zero-padding\nfactor and/or the choice of theQuinticinterpolant when in-\ntializing anInterpolatedImageobject.\nThe value ofkstep for an interpolated image of input sizeN\nand pitch∆x would naively be set at 2π/(N ∆x) to reﬂect the\nbounded size of the input image. We must recall, however, that\nthe interpolation of the input image by the kernelK x will ex-\ntend the support of the object and slightly lower the desiredkstep\n(with the sinc interpolant extending the footprint of the image\nenormously).\nThe value ofkmax for a raw sampled image is inﬁnite be-\ncause it is composed ofδ functions. However the application\nof the interpolantK x to the samples will cause˜I(k) to roll off\nyieldingkmax = cπ/∆x, wherec is a constant characteristic to\nthe chosenK x. In this respect the band-limited sinc interpolant,\nwithc = 1, is ideal, but the Lanczos interpolants withn = 3–\n5 offer much more compact support with 2< c < 3 sufﬁcing\nto contain all aliases with amplitude> 0.001. See Table 1 in\nBernstein & Gruen (2014) for the relevant characteristics of the\ninterpolants.\n6.2.5. Transformations\nTransformations of functions have well-known correspon-\ndents in Fourier domain, which we quickly review here.\nA shiftI′(x) = I(x − x0) has Fourier-domain equivalent\n˜I′(k)= eik·x0 ˜I(k). A shift leaveskmax and kstepunchanged.\nLinear transformations of the plane, such thatI′(x) =\nI(A −1x),are equivalent to˜I′(k)=˜I(A T k).We identify the max-\nimum and minimum eigenvaluesλ+ and λ− ofA , and set\nkmax → λ−1\n− kmax (48)\nkstep→ λ−1\n+ kstep (49)\n6.2.6. Compositions\nThe Fourier transform is linear, so that ifI(x) = aIA (x) +\nbIB (x), we also have˜I(k) = a˜IA (k) + b˜IB (k). When we are\ndealing with a sum of multiple componentsIi, we set\nkmax = max i(kmax ,i) (50)\nkstep= mini(kstep,i) (51)\nThe convolutionI(x) = (IA ◦ IB )(x) is equivalent to˜I(k) =\n˜IA (k)˜IB (k). Under a convolution of multiple elements, we set\nkmax = mini(kmax ,i) (52)\nkstep=\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n∑\ni\nk−2\nstep,i\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n−1/2\n(53)\n15\nWhile the propagation of the band limitkmax is rigorously cor-\nrect for convolution, the propagation ofkstepin equation (53) is\nmerely heuristic. It is based on the exact statement that thecen-\ntral second moments of objects sum in quadrature under con-\nvolution. But there is no general rule for the propagation of\nthe radius enclosing some chosen fraction of the total object\nﬂux, so our heuristic is known to be correct only for Gaussian\nobjects. For strictly compact functions such as aPixel, the\nmaximum nonzero elementxmax actually adds linearly, not in\nquadrature, under convolution. GAL SIM provides the option to\nmanually increase the size of DFTs if one is worried that the\nkstepheuristic will lead to excessive aliasing.\nFinally, aDeconvolveoperation applied to some image\nIA (x) yields 1/˜IA (k) in the Fourier domain. We leavekmax and\nkstep unaltered, because the deconvolved object is usually ill-\ndeﬁned unless it is later re-convolved with an object that has a\nsmallerkmax value.\n6.3. Photon shooting\n“Photon shooting” was used successfully by Bridle et al.\n(2009, 2010) and Kitching et al. (2012, 2013) to generate the\nsimulated images for the GREAT08 and GREAT10 weak lens-\ning challenges. The objects were convolutions of elliptical\nSérsic-proﬁle galaxies with Moffat-proﬁle PSFs. GAL SIM ex-\ntends this technique to enable photon shooting for nearly all of\nits possible objects, except for deconvolutions.\nWhen we “shoot” a GAL SIM object,N γ photons are created\nwith weightsw i and positionsxi. The total weight within any\nregion has an expectation value of the ﬂux in that region, and\nthe total weights in any two regions are uncorrelated24.\nWe allow for non-uniform weights primarily so that we can\nrepresent negative values of surface brightness. This is neces-\nsary to realize interpolation with kernels that have negative re-\ngions (as will any interpolant that approximates band-limited\nbehaviour), and to correctly render interpolated images that\nhave negative pixel values, such as might arise from using em-\npirical, noisy galaxy images.\nFor photon shooting to be possible on a GAL SIM object, it\nmust be able to reportfpos and fneg, the absolute values of the\nﬂux in regions withI(x) > 0 andI(x) < 0, respectively. When\nN γ photons are requested, we draw their positions from the dis-\ntribution deﬁned by|I(x)|and then assign weights\nw i = fabs\nN γ\nsign [I(xi)]= fpos + fneg\nN γ\nsign [I(xi)]. (54)\nShot noise in the fraction of photons that end up in the\nnegative-brightness regions will lead to variations in thetotal\nﬂux of the photons. GAL SIM mostly accounts for this effect\nautomatically by selecting an appropriate number of photons to\nget the noise correct (cf. §6.3.6). However, the partial cancel-\nlations between positive- and negative-ﬂux photons means that\n24 This will not be true if you turn off the Poisson variation in the total ﬂux,\nwhich is optional but turned on by default, since then the ﬁxed total ﬂux will\nlead to some correlation in the pixel values.\nthe resulting noise will not actually be distributed precisely ac-\ncording to a Poisson distribution for the given ﬂux; only the\nvariance of the noise will be approximately accurate. For ob-\njects constructed purely from positive-ﬂux proﬁles, this effect\nis absent, and the noise is indeed Poisson.\nWe will see below that in some cases,|w i|is allowed to depart\nslightly from the constantfabs/N γ value, which also alters the\nnoise properties slightly.\n6.3.1. Analytic objects\nPhoton shooting a surface-brightness functionI(x) is sim-\nplest when there is a known transformation from the unit square\nor circle to the plane whose Jacobian determinant is∝ I.\nPixelis the simplest such case, since it is just a scaling of\nthe unit square.\nMany other proﬁles are circularly symmetric functions with\na cumulative radial distribution function\nC (r)=\n∫r\n0 I(r′)r′ dr′\n∫∞\n0 I(r′)r′ dr′\n. (55)\nIfu is a uniform deviate between 0 and 1,C −1(u) will be dis-\ntributed asrI(r), the distribution of ﬂux with radius. A second\nuniform deviate can determine the azimuthal angle of each pho-\nton.\nG AL SIM uses fast analyticC −1(u) functions for theGaus-\nsian(e.g. Press et al., 1992) andMoffatclasses.\nFor the other circularly symmetric proﬁles we use the follow-\ning algorithm to convert a uniform deviate into the radial ﬂux\ndistribution of|I|. The algorithm is provided with the function\nI(r) and with a ﬁnite set of points{R0,R1,R2,..., R M } with the\nguarantee that each interval (Ri,Ri+1) contains no sign changes\nand at most one extremum ofI(r). The absolute ﬂux|fi|in each\nannulus is obtained with standard numerical integration tech-\nniques.\nNote that this algorithm requires a maximum radius, so the\nphoton shooting rendering requires truncation of unbounded\nproﬁles. The fraction of excluded ﬂux due to this truncationis\ngiven by theshoot_accuracyparameter described in §6.4.\nThe algorithm proceeds as follows:\n1. The code ﬁrst inserts additional nodes into theRi series at\nthe locations of any extrema.\n2. The radial intervals are recursively bisected until either\nthe absolute ﬂux in the interval is small, or the ratio\nmax|I|/min |I| over the interval is below a chosen thresh-\nold.\n3. The integralfi of the absolute ﬂux is calculated for each\nannular interval along with the probabilitypi = fi/∑\ni fi of\na photon being shot into the interval. We can also calcu-\nlate the cumulative probabilityPi = ∑\nj<i pj of the photon\nbeing interior to the annulus.\n4. For each photon we draw a uniform deviateu. It is mapped\nto a radiusr by ﬁnding the intervalisuch thatPi ≤ u <\nPi+1 and then assigning\nr2 = R2\ni+ u −Pi\npi\n(\nR2\ni+1 −R2\ni\n)\n. (56)\n16\nIn other words we drawr from a ﬂux distribution that ap-\nproximates|I(r)| as a “wedding cake” of constant-valued\nannuli.\n5. (a) Ifr is in an interval that has a narrow range of bright-\nness variation, we re-weight the photon by a factor equal\nto the brightness atr relative to the mean brightness in the\nannulus:\nw = fabs\nN γ\nI(r)π\n(\nR2\ni+1 −R2\ni\n)\nfi\n. (57)\n(b) If the range of variation ofI in the annulus is large,\nwhich can happen when the annulus is near a zero cross-\ning, we implement rejection sampling by drawing an-\nother uniform deviateu′, and keeping the photonr if\n|I(r)|/max |I| > u′. If the photon is rejected, we use an-\nother uniform deviateu to select a new trial radius within\nthe interval:\nr2 = R2\ni+u\n(\nR2\ni+1 −R2\ni\n)\n. (58)\nThe rejection test is repeated, and the process is iterated\nuntil a photon radius is accepted. This photon is given the\nnominal weight (54).\n6. The azimuthal angle of the photon is selected with a uni-\nform deviate.\nThis procedure yieldsN γ photon locations and weights, em-\nploying 2N γ(1+ǫ) uniform deviates andN γ(1+ǫ) evaluations of\nI(r), whereǫ is the fraction of photons rejected in step 5b. We\nnote that the ﬁnite widths of the annuli must be small for the\napproximation to be good: the close correspondence of photon\nshooting and DFT rendering results in §9.1 demonstrates that\nthis is achieved in GAL SIM .\nIn practice we re-order the intervals into a binary tree (see,\ne.g., Makinson, 2012) to optimize the selection of an interval\nwith the initial uniform deviate. With this tree structure the\nmean number of operations to select an interval approaches the\noptimal−∑pilogpi < logM , whereM is the ﬁnal number of\nradius intervals.\nThe Sersic,Exponential,DeVaucouleurs,Airy,\nand Kolmogorovclasses use this interval-based photon\nshooting algorithm. The construction of the interval structure\nand ﬂux integrals are done only once for theExponential\nand DeVaucouleursproﬁles and once for each distinct Sér-\nsic indexn forSersicproﬁles or distinct central obscuration\nforAiry. These results are cached for use by future instances\nof the classes in each case.\n6.3.2. Shapelets\nBecause shapelet proﬁles are not radially symmetric, imple-\nmenting photon shooting for such objects represents a signif-\nicant challenge (although it is far from impossible). As of\nG AL SIM version 1.1, we have not attempted to support photon\nshooting forShapeletobjects.\n6.3.3. Interpolated images\nPhoton shooting anInterpolatedImageobject requires\ntwo steps: ﬁrst we distribute the photons among the grid points\n(i∆x, j∆x) with probabilitiespi j= |ai j|/∑|ai j|. We select an\nordering for these probabilities and create the cumulativeprob-\nabilitiesPi j. For each photon, we draw a uniform deviateu, and\nassign an (i, j) value as the last one in the ordering withPi j<u.\nThe weight is given the sign ofai j. As we did with the radial\nfunction intervals above, we create a tree structure which re-\nduces the selection of each (i, j) toO (logN ) for anN ×N input\nimage.\nThe second step in photon shooting theInterpolated-\nImageis to convolve the gridded samples with the interpola-\ntion kernelK x by adding to each photon’s location a displace-\nment drawn from the kernel. Since our 2D interpolants are all\nseparable into 1D functions, we can draw anx and y displace-\nment from the 1D functions. Theδ-function interpolant can\nof course skip this step, and the nearest-neighbour and linear\ninterpolants are trivially generated from uniform deviates. Pho-\nton shooting is implemented for the other interpolants using the\nsame algorithm described for the radial analytic functions, with\nthe replacement ofr2 → x in equations (56) & (57) because of\nthe linear instead of circular geometry.\nAttempts to shoot photons through an image with a sinc in-\nterpolant will throw an exception. The long oscillating tail of\nthe sinc function means thatfabs is divergent.\nPhoton shooting anInterpolatedImagethus requires\n3N γ(1+ǫ) random deviates plus, for most interpolants, 2N γ(1+\nǫ) evaluations of the 1D kernel function.\n6.3.4. Transformations\nAll the transformations described in §3.4 are very simply im-\nplemented in photon shooting. Flux rescaling is simply a rescal-\ning of thew i. Any transformation of the plane can be executed\nby xi → T (xi).\n6.3.5. Compositions\nTo shootN γ photons from a sum ofM proﬁles, we draw\nthe number of photons per summand{n1,n2,..., nM } from\na multinomial distribution with expectation value⟨nj⟩ =\nN γfabs,j/∑\nj fabs,j. Then we concatenate the lists ofni photons\ngenerated by shooting the individual summands.\nConvolution is similarly straightforward: to shootN γ pho-\ntons throughIA ◦ IB , we drawN γ photons each fromIA and IB ,\nset the output weights tow i = w i,A w i,B , and sum the positions to\ngetxi = xi,A +xi,B .To ensure that there is no correlation between\nthe photon positions ofA and B in the sequence, GAL SIM ran-\ndomizes the order of theB photons. This procedure generalizes\nstraightforwardly to the case of convolving more than two pro-\nﬁles together.\nWe are not aware of a practical means of implementing de-\nconvolution via photon shooting, so GAL SIM cannot use pho-\nton shooting for any proﬁle that involves a deconvolution.\n6.3.6. Selecting an appropriate number of photons\nOne of the main advantages of using the photon-shooting\nmethod for rendering images is that for objects with low signal-\nto-noise (S/N ), it can be much faster to shoot a relatively\nsmall number of photons compared to performing one or more\nFourier transforms. However, for this to be effective, one must\n17\nknow how many photons to shoot so as to achieve the desired\nﬁnalS/N value.\nThe simplest case is when there are no components that re-\nquire negative-ﬂux photons. Then the ﬂuxf of the object given\nin photons25 is exactly equal to the number of photons that\nwould be detected by the CCD. In such a case, the ﬂux itself\nprovides the number of photons to shoot.\nThis simple procedure is complicated by a number of con-\nsiderations. The ﬁrst is that the ﬂux itself is a random variable.\nSo by default, GAL SIM will vary the total number of photons\naccording to Poisson statistics, which is the natural behaviour\nfor real photons. This means that the actual realized ﬂux of the\nobject varies according to a Poisson distribution with the given\nmean value. This feature can also be turned off if desired, since\nfor simulations, users may want a speciﬁc ﬂux value, rather than\njust something with the right expectation value.\nA more serious complication happens when there are com-\nponents that require negative-ﬂux photons to be shot, such as\nthose involving interpolants (cf. §6.3.3). We need more pho-\ntons to get the right total ﬂux, since some of them have negative\nﬂux, but then the increased count leads to more noise than we\nwant. The solution we adopt to address this is to have each\nphoton carry somewhat less ﬂux and use even more photons.\nLet us deﬁneηto be the fraction of photons being shot that\nhave negative ﬂux, and let each photon carry a ﬂux of±g. We\nwant both the total ﬂux shot and its variance to equal the desired\nﬂux, f:\nf = N photons(1−2η)g (59)\nVar(f)= N photonsg2 (60)\nSetting these equal, we obtain\ng = 1 −2η (61)\nN photons = f/(1−2η)2 (62)\nG AL SIM ’s functiondrawImageautomatically does the\nabove calculation by default when photon shooting, although\nusers can override it and set a different number of photons tobe\nshot if they prefer.\nNote that the above calculation assumes thatη is a constant\nover the extent of the proﬁle being shot. In reality, it is notcon-\nstant, which leads to correlations between different regions of a\nphoton-shot image using photons of mixed sign. The resulting\nnoise pattern will roughly resemble the noise of a real photon\nimage, but one should not rely on the noise being either sta-\ntionary or uncorrelated in this case. Nor will the noise in any\npixel follow Poisson statistics. These inaccuracies gets more\npronounced asηnears 0.5.\nThere is one additional feature, which can be useful for ob-\njects with moderately high ﬂux, but which are still dominated\n25 Technically, in GAL SIM the ﬂux is deﬁned in so-called analog-to-digital\nunits, ADU. These are the units of the numbers on astronomical images. We\nallow againparameter, given in photons/ADU, to convert between these units\nand the actual number of photons, combining both the normal gain in e-/ADU\nand the quantum efﬁciency in e-/photon. The default behaviour is to ignore all\nthese issues and use a gain of 1.\nby sky background light (a relatively common use case). It may\ntake many photons to get the noise level correct, a computa-\ntional cost which is wasted if a larger amount of noise is then\nadded from the sky background. The same ﬁnalS/N can be ob-\ntained (to a very good approximation) by shooting fewer pho-\ntons, each with ﬂux larger than the normal choice ofg = 1 −2η.\nTo address this, GAL SIM has an option to allow the pho-\nton shooting process to add an additional noise per pixel over\nthe Poisson noise expected for each pixel. Each pixel may be\nallowed to haveν excess variance. The brightest pixel in the\nimage, with ﬂuxImax , can then have a variance of up toImax +ν.\nThus the number of photons can be reduced by as much as\nImax /(Imax + ν). The ﬂux carried by each photon is increased\nto keep the total ﬂux equal to the target value,f:\nN photons ≥ Imax f\n(Imax +ν)(1−2η)2 (63)\ng = f\nN photons(1−2η) (64)\nClearly, this is only helpful ifν≫ Imax , which is indeed the case\nwhen the image is sky noise dominated. This is a common use\ncase in realistic simulations, particularly ones that are meant to\nsimulate ground-based observations.\nUsers of this behaviour in GAL SIM must explicitly indicate\nhow much extra noise per pixel,ν, is tolerable. Typically this\nwill be something like 1% of the sky noise per pixel. This isnot\nthe default behaviour, because at the time of rendering the im-\nage, the code does not know how much (or whether) sky noise\nwill be added.\nAn additional complication with the above prescription is\nthat the code does not know the value ofImax a priori. So the ac-\ntual algorithm starts by shooting enough photons to get a decent\nestimate forImax . Then it continues shooting until it reaches the\nvalue given by equation (63), while periodically updating the\nestimatedImax . At the end of this process, it rescales the ﬂux of\nall the photons according to equation (64) using the ﬁnal value\nofN photons.\n6.4. Setting tolerances on rendering accuracy\nSome of the algorithms involved in rendering images involve\ntradeoffs between speed and accuracy. In general, we have\nset accuracy targets appropriate for the weak lensing require-\nments of Stage IV surveys such as LSST,Euclid(Laureijs et al.,\n2011), andWFIRST (cf. §9). However, users may prefer faster\ncode that is slightly less accurate for some purposes, or more ac-\ncurate but slower for others. This is possible in GAL SIM using\na structure calledGSParams, which includes many parameters\npertaining to the speed versus accuracy tradeoff, some of which\nare described below:\n• folding_threshold26 sets a maximum permitted\namount of real space image folding due to the periodic\n26In earlier versions of G AL SIM this parameter was named\nalias_threshold. It was renamed for clarity and to avoid confusion with\nthe phenomenon of aliasing in undersampled data.\n18\nnature of DFTs, as described in §6.2.1. It is the critical pa-\nrameter for deﬁning the appropriate step sizekstep. Addi-\ntionally, it is relevant when letting GAL SIM choose output\nimage sizes: the image will be large enough that at most a\nfractionfolding_thresholdof the total ﬂux falls off\nthe edge of the image. The default is5.e-3.\n• maxk_thresholdsets the maximum amplitude of the\nhigh frequency modes in Fourier space that are ex-\ncluded by truncating the DFT at some maximum value\nkmax . As described in §6.2.1, this truncation is required\nfor proﬁles that are not formally band-limited. Reduc-\ningmaxk_thresholdcan help minimize the effect of\n“ringing” in images for which this consideration applies.\nThe default is1.e-3.\n• xvalue_accuracyand kvalue_accuracyset the\naccuracies of values in real and Fourier space respectively.\nWhen an approximation must be made for some calcula-\ntion, such as when to transition to Taylor approximation as\nsmallr ork, the error in the approximation is constrained\nto be no more than one of these values times the total ﬂux.\nThe default for each is1.e-5.\n• realspace_relerrand realspace_abserrset\nthe relative and absolute error tolerances for real-space\nconvolution. The estimated integration error for the ﬂux\nvalue in each pixel is constrained to be less than ei-\ntherrealspace_relerrtimes its own ﬂux orre-\nalspace_abserrtimes the object’s total ﬂux. The de-\nfault values are1.e-4and 1.e-6respectively.\n• shoot_accuracysets the relative accuracy on the\ntotal ﬂux when photon shooting. When the photon-\nshooting algorithm needs to make approximations, such\nas how high in radius it must sample the radial pro-\nﬁle, the resulting fractional error in the ﬂux is limited to\nshoot_accuracy. The default value is1.e-5.\nThere are several less important parameters that can also be\nset similarly, but the above parameters are the most relevant for\nmost use cases. All the GAL SIM objects described in §3 have\nan optional parametergsparamsthat can set any number of\nthese parameters to a non-default value when initializing the\nobject.\n6.5. Representing realistic galaxies\nG AL SIM can carry out a process (‘reconvolution’) to render\nan image of a real galaxy observed at high resolution (with the\nHST ),removing theHST PSF, with an applied lensing shear\nand/or magniﬁcation, as it would be observed with a lower-\nresolution telescope. Reconvolution was mentioned in Kaiser\n(2000) and implemented in Mandelbaum et al. (2012) in the\nSHERA (SHEar Reconvolution Analysis) software27.\n27http://www.astro.princeton.edu/~rmandelb/shera/\nshera.html\nReconvolution is possible when the target band limitkmax,targ\nrelates to the originalHST band limitkmax,HST via\nkmax,targ<\n(\n1 −\n√\nκ2 +γ2\n)\nkmax,HST . (65)\nFor weak shears and convergences, this condition is easily sat-\nisﬁed by all upcoming lensing surveys, even those from space.\nIn GAL SIM , theRealGalaxyclass represents theHST\ngalaxy deconvolved by its original PSF. This can then be trans-\nformed (sheared, etc.) and convolved by whatever ﬁnal PSF is\ndesired. Observations of galaxies from theHST COSMOS sur-\nvey (described in Koekemoer et al., 2007), which form the basis\nof theRealGalaxyclass, are available for download from the\nG AL SIM repository28. Padding the input postage stamp images\nis necessary, for the reasons described in §6.2.4. We carry out\nnoise padding on the ﬂy, with a noise ﬁeld corresponding to that\nin the rest of the postage stamp (unlikeSHERA , which required\npadded images as inputs). The amount of padding was exten-\nsively tested during the numerical validation of the GAL SIM\nsoftware, and results for the default (strongly recommended)\nchoice are described in §9.2.\nThe implementation is updated compared to that inSHERA\nin several ways. First,SHERA only implemented a cubic inter-\npolant, whereas GAL SIM includes many interpolants that can\nbe tuned to users’ needs (c.f. §3.3.3). Second, GAL SIM fully\ndeconvolves the originalHST PSF. SHERA uses a technique\ncalled pseudo-deconvolution, only deconvolving theHST PSF\non scales accessible in the ﬁnal low-resolution image. In prac-\ntice, the difference between pseudo-deconvolution and decon-\nvolution is irrelevant, and what matters is the ability to render\nsheared galaxies very accurately (see §9). Finally, the original\nHST images typically contain correlated noise, and further cor-\nrelations are introduced by the shearing and subsequent convo-\nlution. In §7.5 we describe how GAL SIM (unlikeSHERA ) can\nmodel this correlated noise throughout the reconvolution pro-\ncess and then whiten the ﬁnal rendered image so that it contains\nonly uncorrelated Gaussian noise.\n7. Noise models\nNoise is a feature of all real imaging data, due to ﬁnite num-\nbers of photons arriving at each detector, thermal noise and\nelectronic noise within the detector and readout, and otherlossy\nprocesses. GAL SIM therefore provides a number of stochastic\nnoise models that can be applied to simulated images.\nIt is worth noting that images rendered by photon shooting\n(see §6.3) already contain noise: photon counts are drawn from\na Poisson distribution of mean equal to the expected ﬂux at each\npixel. But there may still be occasions when it is desirable to\nadd further noise, such as to simulate a shallower image or to\nadd detector read noise. Images rendered by DFT (§6.2) need\nnoise to be added to be made realistic.\n28https://github.com/GalSim-developers/GalSim/\nwiki/RealGalaxy%20Data\n19\n7.1. Random deviates\nUnderlying all the noise models in GAL SIM are implementa-\ntions of random deviates that sample from a range of probability\ndistributions. These include the uniform distributionU(0,1)\n(implemented by theUniformDeviateclass), the Gaus-\nsian/normal distributionN(µ,σ2) (GaussianDeviate), and\nthe Poisson distribution Pois(λ) (PoissonDeviate).\nThese fundamentally important distributions form the basis\nof noise models in GAL SIM , but they are also quite useful for\ngenerating random variates for various galaxy or PSF parame-\nters in large simulations. Additionally, we include some other\ndistributions that are more useful in this latter context rather\nthan for noise models: the binomial distribution, the Gamma\ndistribution, the Weibull distribution (a generalizationof the\nexponential and Rayleigh distributions) and theχ2 distribution\n(see, e.g., Johnson et al., 2005).\nFinally, GAL SIM also supports sampling from an arbitrary\nprobability distribution function, supplied by the user inthe\nform of either a lookup table and interpolating function, ora\ncallable Python function with a speciﬁed min and max value\nrange. This is the implemented by theDistDeviateclass.\n7.2. Uncorrelated noise models\nThe majority of noise models that GAL SIM implements gen-\nerate uncorrelated noise, i.e. noise that takes a statistically inde-\npendent value from pixel to pixel. The simplest is theGaus-\nsianNoiseclass, which adds values drawn fromN(0,σ2) to\nan image. The noise is thus spatially stationary, i.e. having a\nconstant variance throughout the image, as well as being uncor-\nrelated.\nThe PoissonNoiseclass adds Poisson noise Pois(λi) to\nthei-th pixel of the image, whereλi corresponds to the mean\nnumber of counts in that pixel (an optional sky level can be\nsupplied when simulating sky-subtracted images). ThePois-\nsonNoisemodel is not stationary, since the variance varies\nacross the image according to the different pixel ﬂuxes.\nThe CCDNoiseclass provides a good approximation to the\nnoise found in normal CCD images. The noise model has two\ncomponents: Poisson noise corresponding to the expected pho-\nton countsλi in each pixel (again with optional extra sky level)\nand stationary Gaussian read noiseN(0,σ2). It is also possi-\nble to specify a gain value in photons/ADU (analog-to-digital\nunits)29, in which case the Poisson noise applies to the photon\ncounts, but the image gets values in ADU.\nThe VariableGaussianNoiseclass implements a non-\nstationary Gaussian noise model, adding noise drawn from\nN(0,σ2\ni), using a different variance for each pixeliin the im-\nage.\nFinally, any random deviate from §7.1 can be used as the\nbasis for a simple GAL SIM noise model, using theDevi-\nateNoiseclass, which draws from the supplied random de-\nviate independently for each pixel to add noise to the image.\n29 Normally the gain is given in e-/ADU, but in GAL SIM we combine the\neffect of the gain with the quantum efﬁciency, given in e-/photon\n7.3. Correlated noise\nAstronomical images may contain noise that is spatially cor-\nrelated. This can occur at low levels due to detector crosstalk\n(e.g. Moore et al., 2004; Antilogus et al., 2014) or the use of\npixel-based corrections for charge transfer inefﬁciency (CTI,\nMassey et al. 2010), and it can be strikingly seen in images\nthat have been created through the coaddition of two or more\ndithered input images.\nDrizzled HST images (Fruchter & Hook, 2002;\nKoekemoer et al., 2003) often have correlated noise due\nto the assignment of ﬂux from single input pixels to more\nthan one output pixel. The drizzledHST COSMOS survey\nimages (see Koekemoer et al., 2007) used as the basis for\nempirical galaxy models described in §6.5 contain signiﬁcant\ninter-pixel noise correlations. For faint objects, such asthe\ngalaxies typically of interest for weak lensing, such noiseis\nwell approximated as a set of correlated Gaussian random\nvariables.\n7.3.1. Statistics of correlated Gaussian noise\nThe statistical properties of correlated Gaussian noise are\nfully described by a covariance matrix. If we denote a noise\nﬁeld asη, we may deﬁne a discrete pixel-noise autocorrelation\nfunction\nξnoise[n,m ]= ⟨η[i, j]η[i′, j′]⟩\ni′−i=n, j′−j=m , (66)\nwhere the angle brackets indicate the average over all pairsof\npixel locations [i, j] and [i′, j′] for whichi′−i= n and j′−j= m .\n(Here we use square brackets for functions with discrete, inte-\nger input variables.) Thereforen,m denote the integer separa-\ntion between pixels in the positivex and y directions, respec-\ntively. All physicalξnoise[n,m ] functions have two-fold rota-\ntional symmetry, so thatξnoise[−n,−m ] = ξnoise[n,m ], and are\npeaked atn = m = 0. If the noise is stationary, i.e. its variance\nand covariances do not depend upon location in the image, then\nξnoise[n,m ] fully determines the covariance matrix for all pairs\nof pixels in an image.\nFor any physical, discrete pixel-noise correlation function\nξnoise[n,m ] there is a positive, real-valued noise power spectrum\nPnoise[p,q] that is its Fourier counterpart (i.e. the two are related\nby a DFT). We usep,q to label array locations in Fourier space,\nand n,m in real space.\nThe functionPnoise[p,q] can be used to generate random\nnoise as a Gaussian ﬁeld. We may construct an array˜η[p,q]\nas\n˜η[p,q]=\n√\nPnoise[p,q]N\n2 {N(0,1)+iN(0,1)} (67)\nwhere samples from the standard Gaussian distributionN(0,1)\nare drawn independently at each locationp, q (subject to the\ncondition that˜η[p,q] is Hermitian, see below), andN is the to-\ntal array dimension in either direction (we assume square arrays\nfor simplicity). The inverse DFT, as deﬁned in equation (A.17),\nis then applied to generate a real-valued noise ﬁeld realization\nin real spaceη[n,m ]. The enforced Hermitian symmetry of\n˜η[p,q] is exploited to enable the use of efﬁcient inverse-real\nDFT algorithms. It can be seen that the resultantη[n,m ] will\nhave the required discrete correlation functionξnoise[n,m ].\n20\n7.3.2. Representing correlated Gaussian noise\nStationary correlated noise is modelled and generated in\nG AL SIM by theCorrelatedNoiseclass. Internally the\nnoise correlation functionξnoise[n,m ] is represented as a 2D\ndistribution using the same routines used to describe astro-\nnomical objects, described in §3. Using these to calculate\nthe noise power spectrum, and then applying the expression in\nequation (67) followed by an inverse DFT, theCorrelat-\nedNoiseclass can be used to generate a Gaussian random\nﬁeld realization with any physical power spectrum or correla-\ntion function.\nBecause theCorrelatedNoiseclass internally uses a\nregular GAL SIM surface brightness proﬁle to describe the cor-\nrelation function, it is easy to effect the transformation,as in\n§3.4, since the noise is transformed in the same manner. Simi-\nlarly, multiple noise ﬁelds may be summed (as will be required\nin §7.5), since the resultantξnoise is given by the sum of the\nindividual noise correlation functions.\nThe effect of convolution of a noise model by some kernel\nis not quite the same as what happens to surface brightness.\nInstead,ξnoiseshould be convolved by the autocorrelation of the\nkernel. The ability to describe transformations, combinations\nand convolutions of noise is valuable, as will be discussed in\n§7.5.\n7.3.3. Describing discrete correlation functions inR2\nThe description of the discrete correlation function\nξnoise[n,m ] as a distribution inR2 is worthy of some discus-\nsion. As will be seen in §7.5 it is important to be able to take\ninto account the ﬁnite size of pixels in images that may con-\ntain correlated noise, particularly when these images are being\nused to form galaxy models that will ultimately be rendered\nonto a pixel grid of a different scale. We therefore wish to rep-\nresentξnoise[n,m ] as a function of continuous spatial variables,\nξnoise(x,y) for which we require\nξnoise(ns,ms )= ξnoise[n,m ], (68)\nwhere s is the pixel scale.\nLet us consider an image containing noise. In the absence of\nany smoothing of the image, it is described mathematically as\nan array of delta function samples (located at the pixel centres)\nconvolved by the pixel response. This could also be considered\nthe formally correct model to use forξnoise(x,y): its values, like\nthose in an image, should change discontinuously across the\nboundaries between pixels as separation increases continuously.\nHowever, this description ofξnoise(x,y) presents difﬁculties\nwhen performing certain of the operations described in §7.3.2,\ne.g. convolutions, or transformations followed by a convolution.\nThe presence of sharp discontinuities at every pixel-associated\nboundary makes the necessary Fourier space representationof\nξnoise(x,y) extremely non-compact, and prohibitive in terms of\nmemory and computing resources.\nTherefore, to reduce the computational costs of handling\nGaussian correlated noise to tolerable levels, GAL SIM adopts\nbilinear interpolation between the sampled valuesξnoise(ns,ms )\nto deﬁne the continuous-valued functionξnoise(x,y) within the\nCorrelatedNoiseclass.\n−5 0 5\n∆x [pixels]\n−5\n0\n5\n∆y [pixels]\nCOSMOS F814W ACS-WFC log10[|ξnoise|/max|ξnoise|]\n−3.2\n−2.8\n−2.4\n−2.0\n−1.6\n−1.2\n−0.8\n−0.4\n'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0\nFigure 1: Illustration of the GAL SIM estimate of the discrete pixel noise cor-'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0\nFigure 1: Illustration of the GAL SIM estimate of the discrete pixel noise cor-\nrelation functionξnoise in the 0.03 arcsec/pixel, unrotated COSMOS F814W\nscience images of Leauthaud et al. (2007), made by averagingestimates from\nblank sky ﬁelds as described in §7.4. The plot depicts the logof the corre-\nlation function normalized so thatξnoise[0,0] = 1 for clarity, and shows only\nthe central region corresponding to small separations∆x,∆y, which dominate\ncovariances.\nIn practice, the impact of this efﬁciency-driven approxima-\ntion may often be small. The primary use case for the rep-\nresentation of correlated noise within GAL SIM is in handling\nnoise in models derived from direct observations of galaxies\n(see §6.5 and §7.5). In these applications, both the appliedPSF\nand the pixel scale on which the ﬁnal image will be rendered\nare typically signiﬁcantly larger than the pixel scale of the in-\nput images. The use of bilinear interpolation represents a small\nadditional convolution kernel in these cases.\n7.4. COSMOS noise\nThe HST COSMOS galaxy images made available for\ndownload with G AL SIM for use in the RealGalaxy\nclass (see Koekemoer et al., 2007; Leauthaud et al., 2007;\nMandelbaum et al., 2012) contain noise that is spatially cor-\nrelated due to drizzling. To construct a model for this cor-\nrelated noise, we estimated the discrete pixel noise correla-\ntion function in∼100 rectangular regions selected from empty\nsky in the public, unrotated, ACS-WFC F814W science im-\nages (0.03 arcsec/pixel) from COSMOS (described in detail by\nKoekemoer et al., 2007; Leauthaud et al., 2007).\nEach rectangular region varied in size and dimensions, being\nchosen so as not to include any detected objects, but were typ-\nically square regions∼50-200 pixels along a side. The mean\nnoise correlation function in these images (calculated by sum-\nming over each individual estimate, see §7.3.2) provides an\nestimate of the mean noise correlation function in COSMOS\nF814W galaxy images used by GAL SIM as the basis for galaxy\nmodels. The resulting estimate ofξnoiseis depicted in Fig. 1.\nThis model is included with the GAL SIM software for gen-\neral use in handling images that contain noise like those in the\nCOSMOS F814W images, and is accessible via thegetCOS-\nMOSNoise()convenience function.\n21\n7.5. Noise whitening\nAll images of galaxies from telescope observations will con-\ntain noise. As pointed out by Mandelbaum et al. (2012), this\nnoise will become sheared and correlated (in an anisotropic\nway) by the action of the reconvolution algorithm describedin\n§6.5, which can result in a signiﬁcant systematic offset in the re-\nsults from galaxy shear simulations. Mandelbaum et al. (2012)\nfound that the presence of correlated noise caused∼1% level er-\nrors in the determination of calibration biases for weak lensing\nshear for high-S/N galaxies; the effect is worse at lowerS/N ,\nand cannot be ignored for high-precision shear simulations.\nG AL SIM addresses the presence of correlated noise in sim-\nulated images, such as the sheared, convolved noise ﬁelds cre-\nated by the reconvolution algorithm, through a process referred\nto as “noise whitening”. This technique adds further noise to\nimages, with a correlation function chosen to make the combi-\nnation of the two noise ﬁelds approximately uncorrelated and\nstationary (aka “white”).\nWe consider an image containing correlated Gaussian noise\nthat we label asη. We assume⟨η⟩= 0 and we modelηas sta-\ntionary across the image so that its covariance matrix is fully\ndescribed by its correlation functionξnoise[n,m ] or power spec-\ntrum Pnoise[p,q]. We add additional whitening noise which we\nlabelηwhitening, giving a combined noise ﬁeld\nηtotal= η+ηwhitening. (69)\nThe statistics ofηwhiteningare also determined by its power spec-\ntrum,Pwhitening[p,q], andηwhiteningwill be physically realizable\nprovided that\nPwhitening[p,q]≥ 0 (70)\nfor allp,q. The power spectrum of the combined noise ﬁeld is\nsimply\nPtotal= Pnoise+ Pwhitening. (71)\nWe may choose Pwhiteningso thatηtotalis uncorrelated by re-\nquiringPtotalto be a constant (a ﬂat power spectrum corre-\nsponds to a delta function correlation function, which is white\nnoise). This, and the requirementPwhitening≥ 0, is satisﬁed by\nchoosing\nPwhitening[p,q]= max\np,q\n{Pnoise[p,q]}− Pnoise[p,q]. (72)\nIn practice, GAL SIM adds a small amount of additional vari-\nance so thatPwhitening>0, deﬁning\nPwhitening[p,q]= (1+ǫ)×max\np,q\n{Pnoise[p,q]}\n−Pnoise[p,q] (73)\nwhere ǫ = 0.05 by default. The whitening noiseηwhiteningcan\nthen be added following the prescription described in §7.3.1,\nusing the expression forPwhiteningabove. At a relatively small\nfractional cost in additional variance, the ‘headroom’ parameter\nǫ effectively guaranteesPwhitening[p,q] ≥ 0. Withoutǫ this im-\nportant condition might not be met, due to numerical rounding\nand approximations in the description ofξ[n,m ] (see §7.3.3).\n−3 −2 −1 0 1 2 3\nSeparation ∆x [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\n|ξnoise| / max|ξnoise|\nCOSMOS noise\n−3 −2 −1 0 1 2 3\nSeparation ∆x [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\nWhitened noise\n−3 −2 −1 0 1 2 3\nSeparation ∆y [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\n|ξnoise| / max|ξnoise|\n−3 −2 −1 0 1 2 3\nSeparation ∆y [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\nFigure 2: Left panels: cross section through the discrete pixel noise correlation\nfunctionξnoisefor the COSMOS F814W blank sky ﬁelds described in §7.4 and\nshown in Fig. 1, normalized to unit zero-lag variance; the upper left panel shows\nCOSMOS noise correlations in the direction∆y = 0, and the lower left panel\nshows COSMOS noise correlations in the direction∆x = 0. Right panels: cross\nsection through the normalized discrete pixel noise correlation functions for a\nsingle∼400 pixel× 300 pixel patch of blank sky, taken from COSMOS, to\nwhich further whitening noise has been added using the §7.4 model forξnoise,\nusing the procedure described in §7.5. As for the left panels, the upper right and\nlower right panels show correlations along the directions∆y = 0 and∆x = 0,\nrespectively. Unﬁlled bars represent negative correlation function values.\nFig. 2 shows cross sections throughξtotal[n,m ] from a sin-\ngle∼ 400 × 300 pixel patch of blank sky taken from COS-\nMOS F814W ACS-WFC images, to which further whitening\nnoise has been added.Pwhiteningwas calculated using the model\nforξnoise (and thusPnoise) described in §7.4 along with equa-\ntion (73). Here GAL SIM noise whitening has lowered inter-\npixel covariances to∼10−2–10−3 of the zero-lag variance in the\nwhitened image.\nWe have tested that applying this whitening procedure to\nCOSMOS noise ﬁelds that have been sheared and convolved\n(like those produced by the reconvolution algorithm of §6.5)\nsimilarly reduce the noise correlations by 2–3 orders of mag-\nnitude, making them statistically undetectable in all but the\nlargest simulated images.\nThe price paid for noise whitening is additional variance in\nthe output image. The noise added in equation (69) is an ad-\nditional stochastic degradation of an image. For the COSMOS\nF814W noise ﬁeld whitened in Fig. 2, the ﬁnal noise ﬁeld there-\nfore has a variance that is greater than the variance in the orig-\ninal images. However, the correlated noise in a COSMOS im-\nage itself results in a lower effectiveS/N for estimates of ob-\nject properties such as ﬂux, or shape, relative to the case ofan\nimage with the same variance but with pure white noise (for\na discussion of these effects, which depend on object size and\nthe properties of the correlated noise, see, e.g., Casertano et al.,\n2000; Leauthaud et al., 2007). The effect of additional whiten-\ning of the noise in such an image, therefore, reduces theS/N\nof estimates of object properties by less than implied by thera-\n22\ntio of pre- and post-whitening image variances. The amount\nof information lost in whitening will depend on the property\nin question, the object proﬁle, and the noise correlations in the\noriginal image.\nIn the case of noise ﬁelds that have been sheared, convolved\nby a PSF, and then rendered on an image with a larger pixel\nscale (as described in §6.5), the noise added in whitening de-\npends not only on the original noise correlation function, but\nalso on the applied shear, PSF, and ﬁnal pixel scale. Interest-\ningly, it is found to be typically substantially lower in overall\nvariance than in the case of whitening raw COSMOS noise\nat native resolution (the case described above and shown in\nFig. 2).\nOn investigation, this was found to be due to a combina-\ntion of effects. The shear and convolution both increase the\nnoise correlations at large scales. However, the ﬁnal image\nrendering typically has a pixel scales signiﬁcantly larger than\nthe 0.03 arcsec/pixel of the COSMOS images, which means\nthat the values of the correlation function at integer multiples\nof s in separation are often smaller than in the original COS-\nMOS image. Also, convolution with a broad PSF reduces the\noverall noise variance considerably, being essentially a smooth-\ning kernel. These effects combine fortuitously in practice:\nMandelbaum et al. (2014) found that only a relatively modest\namount of whitening noise is required to treat the sheared, cor-\nrelated noise in images generated by the reconvolution algo-\nrithm of §6.5 with a ground-based target PSF and pixel scale.\nIn GAL SIM theImageclass has a methodwhitenNoise\nthat applies the above whitening algorithm to a given im-\nage. This method also returns the theoretical estimate of\nthe noise variance in the ﬁnal whitened image (namely (1+\nǫ) maxp,q {Pnoise[p,q]}). In addition, there is a methodsym-\nmetrizeNoisethat imposesN -fold symmetry (for evenN ≥\n4) on the noise ﬁeld rather than making it entirely white. Typ-\nically far less noise must be added bysymmetrizeNoise\ncompared towhitenNoise, which makes it a useful option\nfor those applications that do not require fully white noise.\nThe RealGalaxyclass has an attributenoisethat keeps\ntrack of the estimated correlated noise in the proﬁle. When this\nobject is transformed or convolved, the new object will also\nhave anoiseattribute that has had the appropriate transforma-\ntion done to propagate the noise in the new proﬁle. This allows\nG AL SIM to automatically track the effect of transformations on\nnoise ﬁelds without much user input required. The ﬁnal pro-\nﬁle’snoiseattribute can then be used to whiten the rendered\nimage. Furthermore, users can add anoiseattribute them-\nselves to any object they create and get the same behaviour.\nIn a larger image with many scattered, possibly overlapping\ngalaxies, the correlated noise in the original images may differ,\nfurther complicating the task of getting uniform white noise in\nthe ﬁnal image. GAL SIM handles this by drawing each galaxy\non its own postage stamp image and whitening that individu-\nally. Still, the ﬁnal image has a complicated patchwork of noise\nwith different regions having different variances, but it is rela-\ntively straightforward in GAL SIM to keep track of these noise\nlevels: the conﬁguration ﬁle interface described in §2.3 allows\nthis to be handled automatically. Then theVariableGaus-\nsianNoiseclass can add a variable amount of noise to each\npixel to bring the noise up to a uniform value across the entire\nimage.\n8. Shear estimation\nG AL SIM includes routines for estimation of weighted mo-\nments of galaxy shapes and for estimation of PSF-corrected\nshears. The code for these routines was originally introduced\nby Hirata & Seljak (2003) (hereafter HS03), including an en-\ntirely new PSF correction method known as re-Gaussianization.\nThese routines were later tested, improved, and optimized in\nsubsequent work (Mandelbaum et al., 2005, 2012; Reyes et al.,\n2012). The code was developed as a free-standing C package\nnamedHSM , and was released publicly under an open source\nlicense simultaneously with its incorporation into GAL SIM .\nThe functionFindAdaptiveMomentsimplements the\n“adaptive moments” method described in §2.1 of HS03, based\non Bernstein & Jarvis (2002). It iteratively computes the mo-\nments of the best-ﬁtting elliptical Gaussian, using the ﬁtted el-\nliptical Gaussian as a weight function.\nThe functionEstimateShearimplements multiple meth-\nods that were tested in HS03:\n1. The PSF correction method described in Appendix C of\nBernstein & Jarvis (2002) tries to analytically account for\nthe effect of the kurtosis of the PSF (in addition to the\nsecond order moments) on the galaxy shapes.\n2. The “linear” method (described in Appendix B of HS03) is\na variant of the previous method that accounts for the ﬁrst-\norder departure of both the PSF and galaxy from Gaus-\nsianity.\n3. The “re-Gaussianization” PSF correction method de-\nscribed in §2.4 of HS03 models the PSF as a Gaussian\nplus a residual, and subtracts from the observed image\nan estimate of the residual convolved with the pre-seeing\ngalaxy. The resulting image has roughly a Gaussian PSF,\nfor which the methods described above can be used for the\nﬁnal PSF correction.\n4. A speciﬁc implementation of the KSB method\n(Kaiser et al., 1995; Luppino & Kaiser, 1997), as de-\nscribed in Appendix C of HS03, is also provided.\nThese routines work directly on GAL SIM images. The ﬁrst\nthree PSF correction methods output a measure of per-galaxy\nshape called a distortion, which for an ensemble of galaxies\ncan be converted to shear estimates via a responsivity factor\n(cf. Bernstein & Jarvis 2002). The outputs are clearly labeled\nas being distinct from per-galaxy shear estimates, such as those\noutput by the KSB routine.\nAs is typical for all shape measurement algorithms, there\nare several tunable parameters for the above methods and for\nmoment estimation overall (with adaptive moment estimation\nplaying a role in all but the KSB method of PSF estimation).\nG AL SIM therefore includes two ways of tuning these param-\neters. There is anHSMParamsstructure that allows users to\n23\nchange parameters that affect how the submodule works over-\nall. Other parameters are given as arguments to the speciﬁc\nfunctions.\nAside from the obvious utility of being able to operate di-\nrectly on images in memory, rather than ﬁles, the versions of\nthese routines in GAL SIM come with some improvements over\nthe free-standing C code. These include an intuitive and more\nﬂexible user interface; optimization of convolutions, theexp\nfunction (via reduction of the number of function calls), and\nFourier transforms (using theFFTW package, Frigo & Johnson,\n2005); a clean way of including masks within images that is\neasily extensible to variable weight maps; and a ﬁx for a bug\nthat caused the original C code to work incorrectly if the input\nPSF images were not square.\n9. Numerical validation\nIn this Section we describe the investigations that were un-\ndertaken to validate the accuracy of GAL SIM image simula-\ntions. Although an exhaustive validation of the rendering of\nevery combination of galaxy/PSF proﬁles and observing con-\nditions is impractical, certain key aspects of GAL SIM perfor-\nmance are shown here. Emphasis is placed on conﬁrming that\nG AL SIM meets the stringent requirements on image transfor-\nmations for lensing shear and magniﬁcation simulation.\nIn particular, our metric for validating that the rendered im-\nages are sufﬁciently accurate is based on measurements of the\nsize and ellipticity of the rendered proﬁles, calculated using the\nadaptive moment routines described in §8.\nWe deﬁne the following “STEP-like” (see Heymans et al.,\n2006) models for the errors in the estimates of object ellipticity\ng1 and g2 and sizeσ:\n∆gi = m igi +ci, (74)\n∆σ= m σσ+cσ, (75)\nwhere i = 1,2. The method of estimating the errors∆gi and\n∆σvaries for each of the validation tests described below, buta\ncommon component is adaptive moments estimates of rendered\nobject shapes from images (see §8). We will use the formulae\nabove when describing the nature of the errors in each test.\nAs discussed in Mandelbaum et al. (2014), a well-motivated\ntarget for simulations capable of testing weak lensing measure-\nment is to demonstrate consistency at a level well within the\noverall requirements for shear estimation systematics setby Eu-\nclid(e.g. Cropper et al., 2013; Massey et al., 2013):m i ≃ 2 ×\n10−3 and ci ≃ 2 ×10−4. Such values also place conservative re-\nquirements on galaxy size estimation, as the signal-to-noise ex-\npected for cosmological magniﬁcation measurements has been\nestimated as≲ 50% relative to shear (e.g. van Waerbeke, 2010;\nSchmidt et al., 2012; Duncan et al., 2014).\nOnly if these stringentEuclidconditions are met comfortably\nwill simulations be widely usable for testing weak lensing shear\nestimation, and other precision cosmological applications, in\nthe mid-term future. For each validation test we therefore re-\nquire that GAL SIM can produce images showing discrepancies\nthat are a factor of 10 or more below theEuclidrequirements,\ni.e.m x < 2 × 10−4, cx < 2 × 10−5, wherex = 1,2,σ corre-\nsponding tog1,g2 and σ, respectively. Our intention is to show\nthat rendering accuracy improves with more stringent rendering\nparameter settings, and can be raised to meet the requirement\nabove. GAL SIM default settings for these parameters, however,\nare chosen to reﬂect a balance between speed and accuracy for\ngeneral use. Although these defaults typically take valuesthat\nguarantee meeting 1/10thEuclidrequirements, this is not ex-\nclusively the case (see §9.3).\nFor our tests, we use comparisons of rendering methods us-\ning adaptive moments measurements. Although there are inac-\ncuracies inherent in such measurements in an individual sense,\nwe take care to construct our comparisons to be sensitive only\nto differences in the image rendering. For example, the tests\nalways compare noise-free orextremelylow noise images, with\nthe same underlying galaxy model. Noise bias and model bias\ntherefore affect each test subject in the same way, and differ-\nences are due solely to how the test images were rendered.\nThe tests in this Section were conducted over a period of ex-\ntended validation of the GAL SIM software between July 2013\nand the time of writing this paper. During this time period, cor-\nresponding approximately to versions 1.0 and 1.1 of GAL SIM ,\nthe routines for rendering objects did not change signiﬁcantly\n(except where modiﬁcations were found necessary to meet the\nvalidation criteria onm x and cx deﬁned above).\n9.1. Equivalence of DFT rendering and photon shooting\nOne of the principal advantages of the photon shooting\nmethod (see §6.3) is that the implementations of the various\ntransformations described in §3.4 are very simple. Photonsare\njust moved from their original position to a new position. Con-\nvolutions are similarly straightforward. On the other hand, DFT\nrendering (see §6.2) needs to deal with issues such as band lim-\niting and aliasing due to folding (cf. §6.2.1).\nThus a powerful test of the accuracy of our DFT implementa-\ntion is that the the two rendering methods give equivalent results\nin terms of measured sizes and shapes of the rendered objects.\nAn unlikely conspiracy of complementing errors on both sides\nwould be required for this test to yield false positive results.\nOf all the objects in Table 3, Sérsic proﬁles are the most nu-\nmerically challenging to render using Fourier methods. Espe-\ncially forn ≳ 3, the proﬁles are extremely cuspy in the cen-\ntre and have very broad wings, which means that they require\na large dynamic range ofk values when performing the DFT.\nThey therefore provide a good test of our choices for parame-\nters such asfolding_thresholdand maxk_threshold\n(see §6.4) as well as general validation of the DFT implemen-\ntation strategies.\nFor our test, we builtSersicobjects with Sérsic indices in\nthe range 1.5 ≤ n ≤ 6.2. The half-light radii and intrinsic el-\nlipticities|g(s)|were drawn from a distribution that matches ob-\nserved COSMOS galaxies, as described in Mandelbaum et al.\n(2014). The galaxies were then rotated to a random orienta-\ntion, convolved with a COSMOS-like PSF (a circularAiry\nproﬁle), and then rendered onto an image via both DFT and\nphoton shooting.\n24\nThe error estimates were taken to be the difference between\nthe adaptive moments shape and size estimates from the two\nimages:\n∆gi = gi,DFT −gi,phot (76)\n∆σ= σDFT −σphot (77)\nFor each galaxy model, we made multiple trial photon shoot-\ning images, each with very highS/N to avoid noise biases (107\nphotons shot per trial image). The mean and standard error of\n∆gi and ∆σfrom these trials were used to estimate values and\nuncertainties form x,DFT and cx,DFT using standard linear regres-\nsion.\nDifferences between shape and size estimates are illustrated\nin Fig. 3, forn = 1.5 andn = 6.2. Fig. 4 shows derived esti-\nmates ofm x,DFT for these and other Sérsic indices tested. Toler-\nances are met onm -type biases. It was found thatc-type addi-\ntive biases were consistent with zero for alln indices.\nFig. 5 shows results from a high-precision investigation of\nm x,DFT as a function ofGSParamsparameters (see §6.4), us-\ning a randomly selected sample of 270 galaxies from COS-\nMOS at each parameter value and large numbers of photons.\nEach galaxy was generated in an 8-fold ring test conﬁgura-\ntion (Nakajima & Bernstein, 2007) to further reduce statistical\nuncertainty. The plot in Fig. 5 shows the impact of increas-\ning thefolding_thresholdparameter: as expected, the\nrendering agreement decreases asfolding_thresholdin-\ncreases, and the representation of object size is most affected.\nAnalogous results were achieved for many of the parameters\ndiscussed in §6.4, and the defaultGSParamsparameters were\nfound to give conservatively good performance in all tests.\n9.2. Accuracy of transformed interpolated images\nInterpolated images pose unique challenges for DFT render-\ning. As we discussed in §6.2.4, details such as the choice of the\nFourier-space interpolant and how much padding to use around\nthe original image signiﬁcantly affect the accuracy of the ren-\ndering. We thus need to validate that these choices can be varied\nto produce sufﬁciently accurate results.\nFor this test, we randomly selected a sample 6000 Sérsic\nmodels from the catalogue COSMOS galaxy ﬁts described in\nMandelbaum et al. (2014). For each galaxy in the sample, we\nconstructed aSersicobject using the best-ﬁtting parameters\nin the catalogue, which was then convolved by a COSMOS-\nlike PSF (a circularAiryproﬁle). This proﬁle was drawn onto\nan image with 0.03 arcsec resolution (matching the COSMOS\nimages). That image was then used to construct anInterpo-\nlatedImageproﬁle.\nFor each object in the sample we therefore had the same pro-\nﬁle modelled both as an analytic convolution and as an interpo-\nlated image. Small shears were then applied to both models and\nthe resulting proﬁles were drawn onto images using the DFT\nrendering algorithm, although without including the integration\nby a pixel. Each proﬁle was convolved by a tiny Gaussian to\nforce GAL SIM to use the DFT rendering method (as direct ren-\ndering would otherwise be used when omitting the pixel convo-\nlution).\n−0.6 −0.4 −0.2 0.0 0.2 0.4 0.6\ng1  (DFT)\n−0.00010\n−0.00005\n0.00000\n0.00005\n0.00010\n∆g1  (DFT - photon)\nn = 1.5\nn = 6.2\n−0.6 −0.4 −0.2 0.0 0.2 0.4 0.6\ng2  (DFT)\n−0.00010\n−0.00005\n0.00000\n0.00005\n0.00010\n∆g2  (DFT - photon)\nn = 1.5\nn = 6.2\n0.1 0.2 0.3 0.4 0.5 0.6 0.7\nσ (DFT) [arcsec]\n−0.00001\n0.00000\n0.00001\n0.00002\n0.00003\n0.00004\n0.00005\n∆σ (DFT - Photon) [arcsec]\nn = 1.5\nn = 6.2\nFigure 3: Difference between measured shears (upper panel:g1; central panel:\ng2; lower panel:σ) for Sérsic proﬁles simulated using the photon-shooting and\nDFT rendering methods, plotted against the (shot noise free) shear and size\nmeasured from the DFT image. Results are shown for 30 galaxies with realistic\nsize and shape distribution, and Sérsic index valuesn = 1.5,6.2. (Note that\nthe ‘peakiness’ of the high-n proﬁles results in their lowσestimates. The two\nsamples share the same distributions of half light radii.) The best-ﬁtting lines\nare shown, and estimates of the slopesm x,DFT for these and other values ofn\nare plotted in Fig. 4.\n25\n1 2 3 4 5 6 7\nSersic index n\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope mDFT\ng1\ng2\nσ\nFigure 4: Estimates ofm 1,DFT ,m 2,DFT and m σ,DFT , corresponding to rendering-\ninduced discrepancies in ellipticityg1,g2 and sizeσ, respectively, as a func-\ntion of Sérsic indexn. These slope parameters are deﬁned by equations (74) &\n(75) for the differences between measurements from DFT and photon-shooting-\nrendered images of Sérsic proﬁles. The shaded region shows the target for\nG AL SIM based on not exceeding one tenth of weak lensing accuracy require-\nments for Stage IV surveys such asEuclid(see §9).\n10-3 10-2 10-1\nfolding_threshold\n−0.00030\n−0.00025\n−0.00020\n−0.00015\n−0.00010\n−0.00005\n0.00000\nMultiplicative slope mDFT\ng1\ng2\nσ\nFigure 5: Estimates ofm 1,DFT ,m 2,DFT and m σ,DFT , corresponding to rendering-\ninduced discrepancies in ellipticityg1,g2 and sizeσ, respectively, as a func-\ntion of theGSParamsparameterfolding_threshold. Each point shows\nthe average from the randomly-selected sample of 270 unmodiﬁed COS-\nMOS galaxy models described in §9.1. The rendering parameter fold-\ning_thresholdis described in §6.4 and takes a default value of 5× 10−3,\nindicated by the dotted line. As for Fig. 4 these parameters are deﬁned by the\nmodel of equations (74) & (75). The shaded region shows the target for GAL -\nSIM based on not exceeding one tenth of weak lensing accuracy requirements\nfor Stage IV surveys (see §9).\nAdaptive moments estimates of the change in ellipticity were\nseen to be consistent between the parametric model and inter-\npolated image at better than 1/10thEuclidrequirements, for all\nreal and Fourier space interpolants of higher order than bilinear.\nCrucially, both were consistent with the known applied shear.\nResults for changes in object size were similar. These testsvali-\ndated theInterpolatedImagehandling of transformations\nfor simple input images derived from parametric proﬁles (such\nas a Sérsic galaxy convolved with a COSMOS PSF).\nThe test was then extended to the more complicated case of\nRealGalaxyproﬁles. Once again, adaptive moments esti-\nmates of the object ellipticity were made before and after ap-\nplying a shear. This was compared to the expected shear, cal-\nculable given an adaptive moments estimate of the intrinsicel-\nlipticity prior to shearing, and the known applied shear. The\nRealGalaxyproﬁle was again convolved with a tiny Gaus-\nsian PSF prior to rendering (see above), but in this case addi-\ntional whitening noise was applied to verify that the presence of\nsheared, correlated noise in the output was being appropriately\nhandled.\nThis test was repeated for the same sample of 6000 COS-\nMOS galaxy images. Fig. 6 shows estimates ofm i,interpfor a\nrange of Fourier space interpolants, and for two values of the\npad_factorparameter, which speciﬁes how large a region\naround the original image to pad with zeroes. A larger value\nforpad_factorproduces more accurate results, as shown in\nFig. 6, but is accompanied by large increases in computation\ntime.\nWe performed many similar tests to this for a range of trans-\nformations (in various combinations) and input parameters. In\nall tests performed, settingpad_factor= 4 and using the\ntwo-dimensional quintic interpolant gave results that satisﬁed\nm i,interp< 2 × 10−4,ci,interp< 2 × 10−5. These results justify\nthe choice of these as the defaults in GAL SIM . Values ofci,interp\nwere found to be extremely small in general.\nIn addition to verifying direct shear response, we also\nchecked for leakage between shear components, i.e., that ap-\nplying shear in one component does not result in an incorrect\nlevel of shear in the other component. The leakage was found\nto be consistent with zero and comfortably within requirements\nforpad_factorvalues of 4 and 6, for all interpolants tested.\nThe onlyRealGalaxytest that did not pass our require-\nment was when we simultaneously simulated shears in both\ncomponents and a magniﬁcation. In this case we found\nmσ,interp∼ (4± 0.4)× 10−4, largely irrespective of the choice\nof interpolant. The source of this bias, which is larger thanthe\ntarget 2× 10−4, has not yet been identiﬁed. However, as mag-\nniﬁcation is a cosmological probe that is typically noisierthan\nshear, this degree of discrepancy is likely to be tolerable for\nsimulations of magniﬁcation in Stage IV survey data.\n9.3. Accuracy of reconvolution\nAs a ﬁnal demonstration of GAL SIM ’s high precision opera-\ntion, we tested that we can accurately apply the reconvolution\nalgorithm of §6.5 (Mandelbaum et al., 2012). The aim is to rep-\nresent the appearance of a test object following an applied shear\ngapplied, when viewed at lower resolution.\n26\n3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0\nInput pad_factor\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope m 1,interp\nk interpolants: slope of ∆g1  as a function of\napplied g1  [only g1  applied]\ncubic\nquintic\nlanczos3\nlanczos4\nlanczos5\nlanczos7\n3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0\nInput pad_factor\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope m 2,interp\nk interpolants: slope of ∆g2  as a function of\napplied g2  [only g2  applied]\ncubic\nquintic\nlanczos3\nlanczos4\nlanczos5\nlanczos7\nFigure 6: Multiplicative biasm i,interpin the relationship between an applied\nshear and an adaptive moments estimate of the observed shearforReal-\nGalaxyobjects, for various Fourier space interpolants, e.g. cubic, quintic etc.,\nand the padding factor (default = 4, indicated by the dotted line). These re-\nsults include the handling of correlated noise via the noisewhitening procedure\ndescribed in §7.5. The shaded region shows the target for GAL SIM based on\nnot exceeding one tenth of weak lensing accuracy requirements for Stage IV\nsurveys (see §9).\nThis test was carried out usingSersicproﬁles convolved\nby a known COSMOS-like PSF (a circularAiryproﬁle), ren-\ndered at high resolution (0.03 arcsec/pixel). These images,\nalong with images of the PSF, were then used as inputs to ini-\ntializeRealGalaxyobjects, mimicking the use of real COS-\nMOS galaxy images. In the usual manner these objects were\nsheared and reconvolved by a broader (ground-based or Stage\nIV space-based survey) PSF, then rendered at lower resolution.\nBecause of the use of an underlying parametric Sérsic proﬁle,\nthe rendering of which has been validated in §9.1, we can also\nrender the convolved, sheared objectdirectlyat lower resolution\nto provide a reference for comparison. We quantify any error\nin the effectively applied shear due to the reconvolution process\nasm i,reconvand ci,reconv, deﬁned according to equation (74).\nThe test was done for 200 proﬁles whose parameters were\nselected from the real COSMOS galaxy catalogue described in\nMandelbaum et al. (2014), using random galaxy rotations in an\n8-fold ring test conﬁguration (Nakajima & Bernstein, 2007).\nSince galaxies with different light proﬁles might be more or\nless difﬁcult to accurately render using reconvolution, wemust\nconsider not only the mean values ofm and c, but also investi-\ngate their ranges, which could identify galaxy types for which\nthe method fails to work sufﬁciently accurately even if it issuc-\ncessful for most galaxies.\nFig. 7 shows m i,reconv as a function of the fold-\ning_thresholdparameter described in §6.4. Near the\nG AL SIM default value of 5×10−3, our requirementm i,reconv <\n2 × 10−4 is met comfortably in the ensemble average.\nAcross the sample of 200 COSMOS galaxies a small frac-\ntion (3/200) exceeded our requirement for the defaultfold-\ning_thresholdvalue form 2,reconv. However, we do not be-\nlieve that this represents enough of a concern to change the de-\nfaultGSParamssettings. Provided that a representative train-\ning set of galaxy models (such as the COSMOS sample), of\nsufﬁcient size, is used, the variation inm i,reconv seen in Fig. 7\nshould not prevent simulations using the reconvolution algo-\nrithm from being accurate to Stage IV requirements for weak\nlensing.\nIf greater accuracy is required, users wishing to reduce the\nimpact of these effects can modify the values of theGSParams\naccording to their needs. In this case, reducingfold-\ning_thresholdby a factor of 10 bringsm 2,reconv within re-\nquirements for all 200 galaxies tested. Additive biasesci,reconv\nwere found to be extremely small (and consistent with zero) in\nall cases.\nThese results shows that the approximations inherent in the\nreconvolution process do not signiﬁcantly interfere with GAL -\nSIM ’s ability to render accurate images suitable for weak lens-\ning simulations, for a realistic range of galaxy proﬁles drawn\nfrom COSMOS.\n9.4. Limitations\nWhile results presented in this Section are encouraging, with\nthe default settings providing accuracy that comfortably ex-\nceeds our requirements by a factor of 5–10 in many cases, it\nmust be remembered that no set of tests presented in this arti-\n27\ncle could be sufﬁcient to positively validate GAL SIM ’s perfor-\nmance for all possible future applications. Users of GAL SIM\nare strongly advised to conduct their own tests, tailored totheir\nspeciﬁc requirements.\nOne speciﬁc caveat worthy of mention is the adoption of a\ncircular PSF for all tests presented. A circularAirywas cho-\nsen as a simple approximation to the PSF found in COSMOS\nand otherHST images. GAL SIM makes no distinction between\nthose objects describing PSFs and those describing galaxies\nwhen rendering convolutions of multiple proﬁles. However,it is\npossible that a subtle bug or genuine rendering issue might only\nbe activated for cases wherebothgalaxy and PSF break circular\nsymmetry. We stress again that no set of tests performed here\ncan cover all possible uses of the code. Where data properties\nsuch as the PSF are known we encourage GAL SIM users to per-\nform their own validation and adjust the rendering parameters\nas required for their particular use case.\nAnother caveat is that we only used a particular set of COS-\nMOS galaxies for the training sample. It is plausible that galaxy\nmodels drawn from a population with a different redshift dis-\ntribution to the COSMOS sample, or imaged in a ﬁlter other\nthan F814W, might have sufﬁciently different morphological\ncharacteristics to fail the rendering requirements adopted in this\nwork. In future it will be of value to understand the marginal,\nm σ,interp≃ 4 ×10−4 failure of galaxy size transformations in the\nRealGalaxytests when both shear and magniﬁcation were\napplied (see §9.2).\nIn many cases, therefore, users may ﬁnd it necessary to mod-\nify and reﬁne the tests presented here, especially where thein-\nputs and requirements of their analyses differ signiﬁcantly from\nthe assumptions adopted. Some of the tests in this Section will\nhopefully serve as a useful starting point for these investiga-\ntions.\n10. Performance\nWhile the paramount consideration in GAL SIM is the accu-\nracy of the renderings, especially with respect to the shapes,\nwe have also paid considerable attention to making the code as\nfast as possible. Code optimization is of course a wide ranging\ntopic, and we will not attempt to go into detail about all the op-\ntimizations included in the GAL SIM code. We just mention a\nfew optimizations that were particularly helpful and give some\nestimates of the timings for typical use cases.\n10.1. Optimizations\nThe most important performance decision was to use C++\nfor all time-critical operations. The Python layer provides a\nnice front-end user interface, but it is notoriously difﬁcult to\ndo serious coding optimization in Python. So for all signif-\nicant calculations, GAL SIM calls C++ functions from within\nPython, where we have used the normal kinds of optimization\ntechniques that are standard with C and C++ code: precomput-\ning values that will be used multiple times, having tight inner\nloops, using iterators to be more amenable to vectorizationby\nthe compiler, using lookup tables and LRU caches, etc.\n10-3 10-2 10-1\nfolding_threshold\n−0.0004\n−0.0002\n0.0000\n0.0002\n0.0004\nMultiplicative slope m reconv\ng1\ng2\nFigure 7: Multiplicative slopem i,reconvfor the reconvolution test of §9.3, forg1\nand g2, as a function of thefolding_thresholdparameter (cf. §6.4). The\nexterior error bars show the full range of values for the 200 models tested, and\nthe points and interior error bars show the mean and standarderror. The shaded\nregion shows the target for GAL SIM based on not exceeding one tenth of weak\nlensing accuracy requirements for Stage IV surveys (see §9). The default value\noffolding_thresholdis indicated by the dotted line.\nThe FFTs for computing convolutions in DFT rendering nor-\nmally constitute the bulk of the calculation time. For these, we\nuse the excellentFFTW package (Frigo & Johnson, 2005). The\ncalculations are fastest when the image size is either an exact\npower of 2, or 3 times a power of 2, so GAL SIM pads the im-\nages to meet this criterion before performing the FFT. Aside\nfrom this consideration, we only use as large an FFT image as\nis required to achieve the desired accuracy. This balance isone\nof the principal speed/accuracy tradeoffs discussed in §6.4.\nFor some DFT calculations, we can avoid the two-\ndimensional FFT entirely by turning it into a one-dimensional\nHankel transform. This is possible when the proﬁle being trans-\nformed is radially symmetric, as are many of the analytic pro-\nﬁles. Iff(r,θ) = f(r), then the Fourier transform is similarly\nradially symmetric:\n˜\nf(k)=\n∫∞\n0\nrdr\n∫2π\n0\nf(r,θ)eikrcos(θ) dθ (78)\n= 2π\n∫∞\n0\nf(r)J0(kr)rdr (79)\nThis optimization is particularly effective for Sérsic proﬁles.\nThe large dynamic range of these proﬁles, especially forn >3,\nmeans that a two-dimensional FFT would require a very large\nimage to achieve the appropriate accuracy. It is signiﬁcantly\nfaster to precompute the one-dimensional Hankel transform\n˜\nf(k), and use that to ﬁll in thek-space values.\nThe integration package in GAL SIM uses an efﬁcient, adap-\ntive Gauss-Kronrod-Patterson algorithm (Patterson, 1968). It\nstarts with the 10-point Gaussian quadrature abscissae andcon-\ntinues adding points at optimally spaced additional locations\n28\nuntil it either converges or reaches 175 points. If the integral\nhas not converged at that point, it splits the original region in\nhalf and tries again on each sub-region, continuing in this man-\nner until all regions have converged. This algorithm is usedin\nG AL SIM for Hankel transforms, real-space integration, cumu-\nlative probability integrals for photon shooting, calculating the\nhalf-light-radius of Sérsic proﬁles, and a few other placeswhere\nintegrations are required.\nMatrix calculations do not generally account for a large share\nof the running time, but to make these as efﬁcient as possible,\nwe use the TMV library30, which calls the system BLAS library\nwhen appropriate if such a system library is available (revert-\ning to native code otherwise). The matrix calculations are thus\nabout as efﬁcient as can be expected on a given platform.\nOne calculation required us to devise our own efﬁcient func-\ntion evaluation. For interpolated images using the Lanczosin-\nterpolant, Fourier-space calculations require evaluation of the\nSine integral:\nSi(x)=\n∫x\n0\nsint\nt dt (80)\nThe standard formulae from Abramowitz & Stegun (1964) §5.2\nfor computing this efﬁciently were only accurate to about 10−6.\nThis was not accurate enough for our needs, and we could\nnot ﬁnd any other source for a more accurate calculation. We\ntherefore developed our own formulae for efﬁciently evalu-\nating Si(x), accurate to 10−16. The formulae are given in\nAppendix B.\n10.2. Parallelization\nAnother important optimization happens in the Python layer.\nWhen running GAL SIM using a conﬁguration ﬁle, rather than\nwriting Python code, it is very easy to get the code to run using\nmultiple processes using the conﬁguration parameternproc.\nOf course, experienced Python programmers can also do this\nmanually, but multiprocessing in Python is not extremely user\nfriendly, so it can be convenient to take advantage of this paral-\nlelism already being implemented in GAL SIM ’s conﬁguration\nﬁle parser.\n10.3. Timings\nThe time it takes for GAL SIM to render an image depends\non many details of the proﬁles and the image on which they are\nbeing rendered. Some proﬁles tend to take longer than others,\nand the size of the object relative to the pixel scale of the ﬁnal\nimage also matters.\nFor most analytic proﬁles, if the image scale is not much\nsmaller than the Nyquist scale of the object, rendering using\nthe DFT method will generally take of order 0.01 seconds or\nless per object. For very many purposes, this kind of proﬁle is\nperfectly appropriate, and it can include a reasonable amount of\ncomplication including multiple components to the galaxy such\na bulge plus disk model, offsets of those components, multi-\ncomponent PSFs, etc.\n30https://code.google.com/p/tmv-cpp/\nModels that include interpolated images take longer. This\nincludes models with anOpticalPSFcomponent or aRe-\nalGalaxy. Such proﬁles typically take of order 0.1 seconds\nper object for typical sizes of the interpolated images, butthe\ntime is highly dependent on the size of the image being used to\ndeﬁne the proﬁle.\nThe running time for photon shooting of course scales lin-\nearly with the number of photons. The crossover point where\nphoton shooting is faster than DFT rendering depends on the\nproﬁle being rendered, but it is typically in the range of 103–\n104 photons. So for faint objects, it can be signiﬁcantly faster\nto use the photon-shooting method.\n10.4. Potential speed pitfalls\nThere are a number of potential pitfalls that can lead to\nslower than normal rendering, which are worth highlighting:\n• Whitening.Proﬁles that use aRealGalaxycan be par-\nticularly slow if the resulting image is whitened (cf. §7.5)\nto remove the correlated noise that is present in the origi-\nnalHST images (and gets exacerbated by the PSF convolu-\ntion). The whitening step can increase the time per object\nto about 1 second, although it varies depending on details\nsuch as the ﬁnal pixel scale, what kind of PSF is used, etc.\n• Pixel size. Using a DFT to render images with very\nsmall pixels relative to the size of the galaxy can be very\nslow. The time required to perform the FFTs scales as\nO(N 2 logN ) whereN is the number of pixels across for\nthe image, so a moderate increase in the size of the galaxy\nrelative to the pixel scale can make a big difference in the\nrunning time.\n• Sérsic proﬁles with varying index.Sérsic galaxies require\npre-computation of some integrals for each Sérsic index\nused. When simulating manyn = 3.3 galaxies, the setup\ntime will be amortized over many galaxies and is thus ir-\nrelevant. When using a different indexn for each galaxy\nthough, the setup must be done for each galaxy, potentially\ndominating the running time. Thus, it is better to selectn\nfrom a list of a ﬁnite number of values rather than letting\nit varying continuously within some range.\n• Variable optical PSF parameters.The OpticalPSF\nclass similarly has a large setup cost to compute the\nFourier transform of the wavefront in the pupil plane. If\nthere is a single PSF for the image, this setup cost is\namortized over all the objects, but for a spatially variable\nPSF (which is more realistic), each object will require a\nnew setup calculation. The variable PSF branches of the\nGREAT3 challenge (Mandelbaum et al., 2014) were the\nmost time-consuming to generate for this reason.\n• Complicated wavelength dependence.Drawing chromatic\nobjects with complex SEDs through non-trivial band-\npasses can take quite a long time. The surface brightness\nproﬁle needs to be integrated over the relevant range of\n29\nwavelengths. The more complicated the SED and band-\npass are, the more samples are required to perform the in-\ntegration. Thus, depending on the purpose of the images\nbeing rendered, it may be advisable to use simple SEDs\nand/or bandpasses, instead of more realistic ones. Opti-\nmizations to this process for non-trivial chromatic objects\nare being incorporated into future versions of GAL SIM .\n10.5. Example output\nFigure 8 shows a portion of an image that can be produced\nby GAL SIM . This particular image is from a simulation that is\nintended to approximate an LSST focal plane.\nThe simulation has an object density of 70 objects per square\narcminute. The galaxies are bulge plus disk models, and the\nPSF includes both atmospheric seeing and an optical compo-\nnent with the appropriate obscuration for the LSST telescope,\nstruts, and plausible aberrations. 20% of the objects are stars.\nThe ﬂuxes of both the galaxies and the stars follow a power law\ndistribution, as does the size distribution of the galaxies, and\nthere is an applied cosmological lensing ﬁeld including both\nshear and magniﬁcation. The noise model includes both Gaus-\nsian read noise and Poisson noise on the counts of the detected\nelectrons.\nThe conﬁguration ﬁle to build this image31 is remarkably\nshort (just 122 lines), especially considering how many real-\nistic data features are included. This example showcases why\nwe consider the conﬁguration mode to be one of the strengths\nof GAL SIM . Even for users who are already comfortable writ-\ning Python code, the conﬁguration ﬁles can be easier to set up\nand get running in many cases.\nEach 4K×4K chip in this simulation takes about 3 minutes to\nrender on a modern laptop using a single core. The simulation\nis set to use as many processors as are available, and with 8\ncores running at once, the whole ﬁeld of view (189 chips in all)\ncan be rendered in a bit more than an hour.\nCurrently GAL SIM is unable to simulate many of the features\nof real images including saturation, bleeding, vignetting, cos-\nmic rays, and the like (cf. §11), so those features are not shown\nhere. For this image, we also chose to cut off the size distribu-\ntion at 20 arcsec to avoid the rare objects that would requirean\nextremely large FFT.\nDespite these apparent shortcomings, this kind of image is\nstill very useful for studying image processing algorithms. In-\ndeed, it is often helpful to intentionally make these and other\nsimpliﬁcations to study the behavior of a particular algorithm.\nImages similar to the one shown in Figure 8 have been used\nto study the effects of blending, star-galaxy separation algo-\nrithms, and shear estimation. For these and many other inves-\ntigations, complete realism of the simulated images is not re-\nquired.\n11. Effects not in GAL SIM\nIt is worth mentioning some of the many physical effects in\noptical and near-infrared astronomical observations thatG AL -\n31 Available publicly athttp://ls.st/xj0.\nSIM cannot yet model. Many of these effects will be important\nto model and explore to help ensure that accurate measurements\nwill be possible from future extragalactic survey data:\n• Physical atmospheric PSF models.Examples of public\nsoftware that can be used to generate physically motivated,\nmulti-layer phase screen models of atmospheric PSFs in-\nclude ARROYO 32, and the LSST IM SIM 33 software (Pe-\nterson et al. in prep.). While the possibility of adding\nsuch an atmospheric PSF module to GAL SIM was investi-\ngated as part of preparatory work for the GREAT3 project\n(Mandelbaum et al., 2014), this functionality is still lack-\ning.\n• Non-linear detector effects. G AL SIM cannot yet model\npixel saturation or bleeding (e.g. Bertin, 2009), interpixel\ncapacitance (e.g. Moore et al., 2004) and other forms of\ncross-talk, all of which affect image ﬂux and shape deter-\nmination.\n• Image artifacts such as ghosts, detector persistence.\nThese effects (e.g. Wynne et al., 1984; Meng et al., 2013;\nLong et al., 2010; Barrick, Ward, & Cuillandre, 2012;\nAnderson et al., 2014) can be difﬁcult to model, or even\nclassify and remove, when measuring the properties of\nastronomical objects in an object-by-object fashion (the\ncurrent standard procedure34). Simulating observations\nwith these effects will therefore be important to be able\nto demonstrate reliable measurements in their presence.\n• Cosmic rays. Simulations of these effects (such as, e.g.,\nRolland et al., 2008) are likely to be an important consid-\neration for imaging in upcoming Stage IV surveys, par-\nticularly for space missions at the second Lagrange point\n(e.g. Barth, Isaacs, & Poivey, 2000).\n• Near ﬁeld contaminants such as satellite trails and mete-\nors.These effects, of relevance to ground-based imaging,\nare not currently supported by GAL SIM . Like cosmic rays\nand instrumental artifacts such as ghosts and persistence,\nthese effects will place stringent demands on object clas-\nsiﬁcation procedures for upcoming survey experiments.\n• Flexion. Although trivially described using a photon-\nshooting approach, simulations of non-afﬁne image trans-\nformations such as weak gravitational ﬂexion are incom-\npatible with the Fourier space rendering of individual pro-\nﬁles described in §6. Flexion is not currently implemented\nin GAL SIM . However, the GAL FLEX 35 package is a stan-\ndalone, open-source Python module that can be integrated\nwith GAL SIM via a NUM PY array interface.\n• Vignetting, variable quantum efﬁciency, and ﬂat ﬁelding\neffects.No variation in the efﬁciency of photon detection\n32http://cfao.ucolick.org/software/arroyo.php\n33http://lsst.astro.washington.edu/\n34Although seehttp://thetractor.org/\n35http://physics.drexel.edu/~jbird/galflex/\n30\nFigure 8: A portion of a GAL SIM simulation of an LSST focal plane. This section is about 5 arcminutes across with a number density of 70 objects per square\narcmin, of which 80% are galaxies and 20% are stars.\nas a function of position in the output image is currently\nincluded in GAL SIM , including variation within pixels. It\nwill be possible to address large scale effects in a relatively\nstraightforward post-processing step. However, signiﬁcant\nintra-pixel quantum efﬁciency variation may require care-\nful design to render efﬁciently.\n• Complicated WCS functions.Recent studies of the DE-\nCam and LSST detectors (Plazas et al., 2014; Rasmussen,\n2014) have revealed complicated astrometric shifts, in-\ncluding edge distortions and tree-rings. These are not cur-\nrently modeled by any existing WCS package, so it would\nrequire a custom implementation to include these effects\nin GAL SIM .\nMany further possibilities for expanding and improving\nG AL SIM capabilities can be found in already existing func-\ntionality. TheOpticalPSFclass described in §3.2.2 could\nbe extended to a more general treatment of optical wavefronts\nby allowing an arbitrary number of Zernike coefﬁcients to be\nspeciﬁed on input. Support for photon shooting ofShapelet\nobjects (see §3.3.2), although a considerable task, would also\nbe a valuable addition to GAL SIM . It is hoped that, through the\nopen and collaborative development pattern already established\nwithin the GAL SIM project, many of these capabilities will be\nadded to GAL SIM in the future.\n12. Conclusions\nWe have described GAL SIM : the modular galaxy image sim-\nulation toolkit. A primary motivation for the project was the de-\nsire for an open, transparent, and community-maintained stan-\ndard toolkit for high precision simulations of the deep extra-\ngalactic imaging expected in upcoming Stage III and Stage IV\nsurveys. We have described the range of physical models cho-\nsen as the basis for describing astronomical objects in GAL -\nSIM , and the support for their description in a range of world\ncoordinate systems. We have also described the mathematical\nprinciples used in the multiple strategies supported by GAL SIM\nfor rendering these models onto images, and for adding noise.\nA number of the techniques employed by GAL SIM are novel,\nincluding the photon shooting of a range of proﬁles includ-\ningInterpolatedImageobjects (see §6.3.3) and noise\nwhitening (§7.5). The consistent handling of astronomicalob-\nject transformation and rendering under a variety of WCS trans-\nformations, described in §5, is also new in the ﬁeld of astronom-\nical image simulation. GAL SIM is unique in bringing all these\nfeatures together under a simple, highly ﬂexible, class library\ninterface.\nAn important part of any software project is testing and val-\nidation. The provision of multiple parallel methods for ren-\ndering images (see §6), a capability unique to GAL SIM among\ncomparable simulation packages, played a vitally important\nrole in this process.\nIn §9 we showed results from a number of tests demonstrat-\ning that GAL SIM output can describe weak lensing transforma-\ntions such as shear and magniﬁcation at the level of accuracyre-\nquired for Stage IV surveys such asEuclid,LSST and WFIRST-\nAFTA . This was demonstrated for highly challenging analytic\nproﬁles (theSersicclass, see §9.1), for surface brightness\nproﬁles derived from images such as theInterpolatedIm-\nageand RealGalaxyclasses (see §9.2), and for the recon-\nvolution algorithm (see §9.3).\nThe accuracy of rendering results can be tuned using input\nparameters, and using theGSParamsstructure described in\n§6.4. Less stringent requirements will yield faster execution,\nbut at the cost of lowering rendering accuracy in output im-\nages. As no set of validation tests can completely cover all us-\n31\nage scenarios, the tests of §9 should be modiﬁed by users of the\nG AL SIM software to tailor them to each application’s speciﬁc\nrequirements.\nAs discussed in §11, there are a number of important effects\nthat GAL SIM cannot yet simulate, but that may signiﬁcantly\nimpact data analysis for upcoming surveys. Work is expected\nto continue in these interesting areas: while the development\nand support of GAL SIM began in early 2012, it is an ongoing\nproject that continues to build on increasing numbers of users\n(and developers).\nAs well as being used to generate the images for the GREAT3\nchallenge (Mandelbaum et al., 2014), GAL SIM now provides\na considerable open-source toolkit for the simulation of extra-\ngalactic survey images. Having been shown to meet demanding\ntolerances on rendering accuracy in a number of tests, GAL SIM\nsimulations can be used as a benchmark for development or\ncommon reference point for code comparison. It also provides\nan accessible, well-documented reference codebase. GAL SIM\nis easily extended, or can be used simply as a class library in\nthe development of further astronomical image analysis appli-\ncations. In these respects GAL SIM achieves its primary aims,\nand will become an increasingly powerful toolkit for astronom-\nical image simulation following development that is planned for\nthe near future.\nAcknowledgments\nWe wish to thank the two anonymous referees whose insight-\nful comments signiﬁcantly improved the paper. This project\nwas supported in part by NASA via the Strategic University\nResearch Partnership (SURP) Program of the Jet Propulsion\nLaboratory, California Institute of Technology. Part of BR’s\nwork was done at the Jet Propulsion Laboratory, California In-\nstitute of Technology, under contract with NASA. BR, JZ and\nTK acknowledge support from a European Research Council\nStarting Grant with number 240672. MJ acknowledges support\nfrom NSF award AST-1138729. RM was supported in part by\nprogram HST-AR-12857.01-A, provided by NASA through a\ngrant from the Space Telescope Science Institute, which is oper-\nated by the Association of Universities for Research in Astron-\nomy, Incorporated, under NASA contract NAS5-26555; and in\npart by a Sloan Fellowship. HM acknowledges support from\nJapan Society for the Promotion of Science (JSPS) Postdoc-\ntoral Fellowships for Research Abroad and JSPS Research Fel-\nlowships for Young Scientists. PM is supported by the U.S. De-\npartment of Energy under Contract No. DE- FG02-91ER40690.\nThe authors acknowledge the use of the UCL Legion High Per-\nformance Computing Facility (Legion@UCL), and associated\nsupport services, in the completion of this work. This work\nwas supported in part by the National Science Foundation un-\nder Grant No. PHYS-1066293 and the hospitality of the Aspen\nCenter for Physics.\n32\nAppendix A. Conventions in the lensing engine\nAppendix A.1. Grid parameters\nAll calculations in the GAL SIM lensing engine (see §4) approximate real continuous functions using a discrete, ﬁnite grid. The\nreal-space grid is deﬁned by\nL = length of grid along one dimension (angular units) (A.1)\nd = spacing between grid points (angular units) (A.2)\nN = number of grid points along one dimension= L/d. (A.3)\nThere is a comparable grid in Fourier-space (i.e., sameN ). Given the parameters of the real-space grid, thekmin along one dimension\nis 2π/L, so we can think of this quantity as the grid spacing in Fourier space, i.e.,kmin = ∆k. This value ofkmin corresponds to a\nFourier mode that exactly ﬁts inside of our square grid (in one dimension). Thek range, again in one dimension, is fromk1 = −π/d\ntoπ/d, i.e.,|k1| < kmax = π/d. This corresponds to a mode that is sampled exactly twice (the minimum possible) given our choice\nof grid spacing. For the two-dimensional grid, the maximum value of|k| is then\n√\n2π/d.\nAppendix A.2. Fourier transform properties\nThe convention for the Fourier transform deﬁned by equations (34) & (35) is adopted throughout, as this is the form typically\nused for describing the statistics of cosmological shear and matter ﬁelds. Unlike the convention typically used in computing and\nsignals processing, and in the standard deﬁnition of the Discrete Fourier Transform (DFT), this convention is non-unitary and uses\nan angular (rather than normal) frequency in the exponent36. This introduces some additional factors of 2πinto standard results,\nand so here we re-express these results using the non-unitary, angular frequency convention.\nIt can be readily shown that if we deﬁneg(xL)≡ f(x), the following well-known identity holds:\nF{g(xL)} = 1\nL˜g\n( k\nL\n)\n. (A.4)\nIf we further deﬁnes(h + x)≡ g(x) then it is straightforward to show that\nF{s(h + x)} = eikh˜s(k). (A.5)\nThere is an additional factor of 2πin the exponent when this property of Fourier transforms is expressed using the normal (rather\nthan angular) frequency convention.\nThe most important result for approximating continuous functions using DFTs is the Poisson summation formula, which under\nthe conventions of equations (34) & (35) may be stated as\n∞∑\nn=−∞\nf(n)=\n∞∑\nq=−∞\n˜f(2πq) (A.6)\nfor integersn and q. It should be noted that in the normal frequency, unitary transform convention form of the Poisson summation\nformula the 2πwithin˜\nf(2πq) is absent. Using equations (A.4) & (A.5) we arrive at the following useful expression of the Poisson\nsummation formula:\n∞∑\nn=−∞\nf(nL + x)= 1L\n∞∑\nq=−∞\n˜\nf\n( 2πqL\n)\nei2πxq/L . (A.7)\nBy substituting∆k ≡ kmin = 2π/L we write this as\n∞∑\nn=−∞\nf\n( 2πn\n∆k + x\n)\n=\n( ∆k\n2π\n) ∞∑\nq=−∞\n˜f(q∆k)eix∆kq. (A.8)\n36For a discussion of transform conventions seehttp://en.wikipedia.org/wiki/Fourier_transform#Other_conventions\n33\nAppendix A.3. Fourier transform of discrete samples of the power spectrum\nLet us deﬁne the following dimensionless function, which takes samples from a power spectrum:\nP∆k[q,p]≡ (∆k)2P(q∆k,p∆k). (A.9)\nWe will use square brackets to denote functions with discrete, integer input variables, as here. We will also usen,m for integer\nindices in real space summations, andq,p in Fourier space. It can then be shown that\nF−1\n\uf8f1\n\uf8f4\n\uf8f4\n\uf8f2\n\uf8f4\n\uf8f4\n\uf8f3\n∞∑\nq,p=−∞\nδ(k1 −q∆k)δ(k2 − p∆k)P∆k[q,p]\n\uf8fc\n\uf8f4\n\uf8f4\n\uf8fd\n\uf8f4\n\uf8f4\n\uf8fe=\n∞∑\nn,m =−∞\nξ+\n(\nθ1 − 2πn\n∆k ,θ2 − 2πm\n∆k\n)\n, (A.10)\nwhere we have used the Fourier series expression for the Dirac comb function, and the convolution theorem. We note that this\nexpression is still continuous, but describes an inﬁnite, periodic summation (of periodL = 2π/∆k) of copies of the correlation\nfunctionξ+. For sufﬁciently small∆k, these copies may be spaced sufﬁciently widely in the real domain to be able to learn much\naboutξ+(θ1,θ2) in the non-overlapping regions. We therefore deﬁne this function as\nξ2π\n∆k\n(θ1,θ2)≡\n∞∑\nn=−∞\nξ+\n(\nθ1 − 2πn\n∆k ,θ2 − 2πm\n∆k\n)\n. (A.11)\nUsing the expression of the Poisson summation formula in equation (A.8), we can also write\nξ2π\n∆k\n(θ1,θ2)=\n∞∑\nq,p=−∞\n( ∆k\n2π\n) 2\nP(q∆k,p∆k)ei∆k(θ1q+θ2 p) = 1\n(2π)2\n∞∑\nq,p=−∞\nP∆k[q,p]ei∆k(θ1q+θ2 p), (A.12)\nThis is in fact an expression for the inverse of the Discrete Time Fourier Transform (DTFT), although this result is normally derived\nusing unitary conventions for the transform pair.\nThe expression in equation (A.12) is periodic with period 2π/∆k = L. All of the information it contains aboutξ+(θ1,θ2) is\ntherefore also contained in one period of the function only.For approximating this information discretely, as desiredin numerical\nanalysis, we can imagine takingN equally spaced samples of the function in equation (A.12) along a single periodL in each\ndimension. These samples are therefore separated by∆θ= 2π/∆kN = d in real space, and we deﬁne the sampled function itself as\nξ∆θ[n,m ]≡ ξ2π\n∆k\n(n∆θ,m ∆θ)= 1\n(2π)2\n∞∑\nq,p=−∞\nP∆k[q,p]ei2π(qn+pm )/N , (A.13)\nfor the integer indicesn,m = 0,1,..., N −1, by substitution into equation (A.12). Using the periodicity of the exponential term in\nthe expression above, this may be written as\nξ∆θ[n,m ]= 1\n(2π)2\nN −1∑\nq,p=0\nP N [q,p]ei2π(qn+pm )/N (A.14)\nwhere we have deﬁned\nP N [q,p]≡\n∞∑\ni,j=−∞\nP∆k[q −iN,p − jN]. (A.15)\nNeedless to say, in order to be able to calculate the values ofP N [q,p] in practice we must also truncate theP∆k sequence to be ﬁnite\nin length. Averycommon choice is to use the same numberN of samples in both real and Fourier space. Choosing to use only N\nsamples fromP∆k then gives\nξ∆θ[n,m ]= 1\n(2π)2\nN −1∑\nq,p=0\nP∆k[q,p]ei2π(qn+pm )/N\n= 1\nN 2 (∆θ)2\nN −1∑\nq,p=0\nP(q∆k,p∆k)ei2π(qn+pm )/N . (A.16)\nFor greater detail regarding this calculation, please see the lensing engine document in the GAL SIM repository.37\n37https://github.com/GalSim-developers/GalSim/blob/master/devel/modules/lensing_engine.pdf\n34\nThe relationship in equation (A.16) is in fact the inverse Discrete Fourier Transform for our non-unitary convention. The more\nusual deﬁnition of the inverse DFT, and that adopted by many DFT implementations (including the NUM PY package in Python), is\nf[n,m ]= numpy.fft.ifft2\n( ˜\nf[p,q]\n)\n≡ 1N 2\nN −1∑\nq,p=0\n˜\nf[q,p]ei2π(qn+pm )/N (N UM PY convention). (A.17)\n(The factor of 1/N 2 here is often found in conventions for the inverse DFT, and ensures that the DFT followed by the inverse DFT\nyields the original, input array.) The Fast Fourier Transform algorithm allows the DFT to be calculated very efﬁciently.\nAppendix A.4. Generating Gaussian ﬁelds\nUsing equation (A.16) we see how to construct a realization of a Gaussian random lensing ﬁeld on a grid, with an ensemble\naverage power spectrum that is approximatelyP(k). We create the following complex, 2D array of dimensionN in Fourier space:\n˜κ[p,q]=˜κE [p,q]+i˜κB [p,q], (A.18)\nwhere˜κE is deﬁned in terms of the desired E-mode power spectrumP E as\n˜κE [p,q]= 1N ∆θ\n√\nP E (p∆k,q∆k)\n2 {N(0,1)+iN(0,1)}, (A.19)\nand likewise for˜κB . HereN(0,1) denotes a standard Gaussian random deviate drawn independently at each [p,q] array location.\nThis complex-valued Fourier-space convergence can be usedto construct the Fourier-space shear ﬁeld via38\n˜g = e2iψ˜κ, (A.20)\nwhere e2iψ is the phase of thek vector deﬁned ask = ∆k(p +iq). It can be seen that⟨˜g[p,q]˜g∗[p′,q′]⟩= δp′\np δq′\nq P(|k|)/(N ∆θ)2 where\n|k| = ∆k\n√\np2 +q2. Taking the inverse DFT of˜g provides the realization of the Gaussian lensing ﬁeldg[n,m ] on a grid in real space,\nwhere the real (imaginary) parts ofg[n,m ] correspond to the ﬁrst (second) shear components. From equation (A.16),g[n,m ] will\nbe correctly scaled to have discrete correlation functionξ∆θ[n,m ] by construction.\nAppendix B. Efﬁcient evaluation of the Sine and Cosine integrals\nThe trigonometric integrals are deﬁned as\nSi(x)=\n∫x\n0\nsint\nt dt= π\n2 −\n∫∞\nx\nsint\nt dt (B.1)\nCi(x)= γ+lnx +\n∫x\n0\ncost−1\nt dt= −\n∫∞\nx\ncost\nt dt (B.2)\nwhere γis the Euler-Mascheroni constant. In GAL SIM , calculations involving Lanczos interpolants require an efﬁcient calculation\nof Si(x). As we were unable to ﬁnd a source for an efﬁcient calculation that was suitably accurate, we developed our own, which\nwe present here. We do not use Ci(x) anywhere in the code, but for completeness, we provide a similarly efﬁcient and accurate\ncalculation of it as well.\nFor small arguments, we use Padé approximants of the convergent Taylor series\nSi(x)=\n∞∑\nn=0\n(−1)nx2n+1\n(2n +1)(2n +1)! (B.3)\nCi(x)= γ+lnx +\n∞∑\nn=1\n(−1)nx2n\n2n(2n)! (B.4)\n38See, for example, Kaiser & Squires (1993), but note that there is a sign error in equation 2.1.12 in that paper that is corrected in equation 2.1.15.\n35\nUsing the Maple software package39, we derived the following formulae, which are accurate to better than 10−16 for 0≤ x ≤ 4:\nSi(x)= x ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 −4.54393409816329991 ·10−2 · x2 +1.15457225751016682 ·10−3 · x4\n−1.41018536821330254 ·10−5 · x6 +9.43280809438713025 ·10−8 · x8\n−3.53201978997168357 ·10−10 · x10 +7.08240282274875911 ·10−13 · x12\n−6.05338212010422477 ·10−16 · x14\n1 +1.01162145739225565 ·10−2 · x2 +4.99175116169755106 ·10−5 · x4\n+1.55654986308745614 ·10−7 · x6 +3.28067571055789734 ·10−10 · x8\n+4.5049097575386581 ·10−13 · x10 +3.21107051193712168 ·10−16 · x12\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.5)\nCi(x)= γ+ln(x)+\nx2 ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n−0.25 +7.51851524438898291 ·10−3 · x2 −1.27528342240267686 ·10−4 · x4\n+1.05297363846239184 ·10−6 · x6 −4.68889508144848019 ·10−9 · x8\n+1.06480802891189243 ·10−11 · x10 −9.93728488857585407 ·10−15 · x12\n1 +1.1592605689110735 ·10−2 · x2 +6.72126800814254432 ·10−5 · x4\n+2.55533277086129636 ·10−7 · x6 +6.97071295760958946 ·10−10 · x8\n+1.38536352772778619 ·10−12 · x10 +1.89106054713059759 ·10−15 · x12\n+1.39759616731376855 ·10−18 · x14\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.6)\nFor x >4, one can use the helper functions:\nf(x)≡\n∫∞\n0\nsin(t)\nt+ x dt=\n∫∞\n0\ne−xt\nt2 +1 dt= Ci(x) sin(x)+\n( π\n2 −Si(x)\n)\ncos(x) (B.7)\ng(x)≡\n∫∞\n0\ncos(t)\nt+ x dt=\n∫∞\n0\nt e−xt\nt2 +1dt= −Ci(x) cos(x)+\n( π\n2 −Si(x)\n)\nsin(x) (B.8)\nusing which, the trigonometric integrals may be expressed as\nSi(x)= π\n2 − f(x) cos(x)−g(x) sin(x) (B.9)\nCi(x)= f(x) sin(x)−g(x) cos(x) (B.10)\nIn the limit asx → ∞, f(x) → 1/x and g(x) → 1/x2. Thus, we can use Chebyshev-Padé expansions of1√y f\n(\n1√y\n)\nand 1\ny g\n(\n1√y\n)\nin the interval 0..1\n42 to obtain the following approximants, good to better than 10−16 forx ≥ 4:\nf(x)= 1\nx ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 +7.44437068161936700618 ·102 · x−2 +1.96396372895146869801 ·105 · x−4\n+2.37750310125431834034 ·107 · x−6 +1.43073403821274636888 ·109 · x−8\n+4.33736238870432522765 ·1010 · x−10 +6.40533830574022022911 ·1011 · x−12\n+4.20968180571076940208 ·1012 · x−14 +1.00795182980368574617 ·1013 · x−16\n+4.94816688199951963482 ·1012 · x−18 −4.94701168645415959931 ·1011 · x−20\n1 +7.46437068161927678031 ·102 · x−2 +1.97865247031583951450 ·105 · x−4\n+2.41535670165126845144 ·107 · x−6 +1.47478952192985464958 ·109 · x−8\n+4.58595115847765779830 ·1010 · x−10 +7.08501308149515401563 ·1011 · x−12\n+5.06084464593475076774 ·1012 · x−14 +1.43468549171581016479 ·1013 · x−16\n+1.11535493509914254097 ·1013 · x−18\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.11)\ng(x)= 1\nx2 ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 +8.1359520115168615 ·102 · x−2 +2.35239181626478200 ·105 · x−4\n+3.12557570795778731 ·107 · x−6 +2.06297595146763354 ·109 · x−8\n+6.83052205423625007 ·1010 · x−10 +1.09049528450362786 ·1012 · x−12\n+7.57664583257834349 ·1012 · x−14 +1.81004487464664575 ·1013 · x−16\n+6.43291613143049485 ·1012 · x−18 −1.36517137670871689 ·1012 · x−20\n1 +8.19595201151451564 ·102 · x−2 +2.40036752835578777 ·105 · x−4\n+3.26026661647090822 ·107 · x−6 +2.23355543278099360 ·109 · x−8\n+7.87465017341829930 ·1010 · x−10 +1.39866710696414565 ·1012 · x−12\n+1.17164723371736605 ·1013 · x−14 +4.01839087307656620 ·1013 · x−16\n+3.99653257887490811 ·1013 · x−18\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.12)\n39http://www.maplesoft.com/\n36\nThus we can calculate Si(x) to double precision accuracy for any value ofx. In GAL SIM , all of the above polynomials are\nimplemented using Horner’s rule, so they are very efﬁcient to evaluate.\nReferences\nAbazajian, K. N., Adelman-McCarthy, J. K., Agüeros, M. A., et al. 2009, ApJS, 182, 543\nAbramowitz, M., & Stegun, I. 1964, Handbook of MathematicalFunctions, 5th edn. (New York: Dover)\nAiry, G. B. 1835, Transactions of the Cambridge Philosophical Society, 5, 283\nAlbrecht, A., Bernstein, G., Cahn, R., et al. 2006, ArXiv Astrophysics e-prints, astro-ph/0609591\nAmara, A., & Réfrégier, A. 2008, MNRAS, 391, 228\nAnderson, R. E., Regan, M., Valenti, J., & Bergeron, E. 2014,ArXiv e-prints, arXiv:1402.4181\nAntilogus, P., Astier, P., Doherty, P., Guyonnet, A., & Regnault, N. 2014, Journal of Instrumentation, 9, C3048\nBacon, D. J., Goldberg, D. M., Rowe, B. T. P., & Taylor, A. N. 2006, MNRAS, 365, 414\nBarrick, G. A., Ward, J., & Cuillandre, J.-C. 2012, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 8453, High Energy,\nOptical, and Infrared Detectors for Astronomy V , article id. 84531K, 8 pp.\nBartelmann, M. 1996, A&A, 313, 697\n—. 2010, Classical and Quantum Gravity, 27, 233001\nBarth, J., Isaacs, J., & Poivey, C. 2000, The Radiation Environment for the Next Generation Space Telescope, Tech. rep.\nBecker, M. R. 2013, MNRAS, 435, 115\nBernstein, G. M. 2010, MNRAS, 406, 2793\nBernstein, G. M., & Armstrong, R. 2014, MNRAS, 438, 1880\nBernstein, G. M., & Gruen, D. 2014, PASP, 126, 287\nBernstein, G. M., & Jarvis, M. 2002, AJ, 123, 583\nBertin, E. 2009, Mem. Societa Astronomica Italiana, 80, 422\nBorn, M., & Wolf, E. 1999, Principles of Optics\nBridle, S., Shawe-Taylor, J., Amara, A., et al. 2009, Annalsof Applied Statistics, 3, 6\nBridle, S., Balan, S. T., Bethge, M., et al. 2010, MNRAS, 405,2044\nCalabretta, M. R., & Greisen, E. W. 2002, A&A, 395, 1077\nCasertano, S., de Mello, D., Dickinson, M., et al. 2000, AJ, 120, 2747\nCiotti, L., & Bertin, G. 1999, A&A, 352, 447\nCropper, M., Hoekstra, H., Kitching, T., et al. 2013, MNRAS,431, 3103\nCypriano, E. S., Amara, A., V oigt, L. M., et al. 2010, MNRAS, 405, 494\nde Jong, J. T. A., Verdoes Kleijn, G. A., Kuijken, K. H., & Valentijn, E. A. 2013, Experimental Astronomy, 35, 25\nde Vaucouleurs, G. 1948, Annales d’Astrophysique, 11, 247\n—. 1959, AJ, 64, 397\nDuncan, C. A. J., Joachimi, B., Heavens, A. F., Heymans, C., &Hildebrandt, H. 2014, MNRAS, 437, 2471\nFried, D. L. 1966, Journal of the Optical Society of America (1917-1983), 56, 1372\nFrigo, M., & Johnson, S. G. 2005, Proceedings of the IEEE, 93,216, special issue on “Program Generation, Optimization, and Platform Adaptation”\nFruchter, A. S., & Hook, R. N. 2002, PASP, 114, 144\nGoldberg, D. M., & Bacon, D. J. 2005, ApJ, 619, 741\nHeymans, C., Van Waerbeke, L., Bacon, D., et al. 2006, MNRAS,368, 1323\nHeymans, C., Van Waerbeke, L., Miller, L., et al. 2012, MNRAS, 427, 146\nHirata, C., & Seljak, U. 2003, MNRAS, 343, 459\nHirata, C. M., Mandelbaum, R., Seljak, U., et al. 2004, MNRAS, 353, 529\nHogg, D. W., & Lang, D. 2013, PASP, 125, 719\nHuterer, D. 2010, General Relativity and Gravitation, 42, 2177\nHuterer, D., Takada, M., Bernstein, G., & Jain, B. 2006, MNRAS, 366, 101\nIrwin, J., & Shmakova, M. 2005, New Astron. Rev., 49, 83\nJohnson, N., Kemp, A., & Kotz, S. 2005, Univariate Discrete Distributions, Wiley Series in Probability and Statistics (Hoboken, New Jersey: John Wiley & Sons)\nKacprzak, T., Bridle, S., Rowe, B., et al. 2014, MNRAS, 441, 2528\nKacprzak, T., Zuntz, J., Rowe, B., et al. 2012, MNRAS, 427, 2711\nKaiser, N. 2000, ApJ, 537, 555\nKaiser, N., & Squires, G. 1993, ApJ, 404, 441\nKaiser, N., Squires, G., & Broadhurst, T. 1995, ApJ, 449, 460\nKitching, T. D., Balan, S. T., Bridle, S., et al. 2012, MNRAS,423, 3163\nKitching, T. D., Rowe, B., Gill, M., et al. 2013, ApJS, 205, 12\nKoekemoer, A. M., Fruchter, A. S., Hook, R. N., & Hack, W. 2003, in HST Calibration Workshop : Hubble after the Installation of the ACS and the NICMOS\nCooling System, ed. S. Arribas, A. Koekemoer, & B. Whitmore,337\nKoekemoer, A. M., Aussel, H., Calzetti, D., et al. 2007, ApJS, 172, 196\nLackner, C. N., & Gunn, J. E. 2012, MNRAS, 421, 2277\nLauer, T. R. 1999, PASP, 111, 227\nLaureijs, R., Amiaux, J., Arduini, S., et al. 2011, ArXiv e-prints, arXiv:1110.3193\nLeauthaud, A., Massey, R., Kneib, J.-P., et al. 2007, ApJS, 172, 219\nLong, K. S., Bagett, S. M., Deustua, S., & Riess, A. 2010, in 2010 Space Telescope Science Institute Calibration Workshop- Hubble after SM4.\nPreparing JWST, held 21-23 July 2010 at Space Telescope Science Institute. Edited by Susana Deustua and Cristina Oliveira. Published online at\nhttp://www.stsci.edu/institute/conference/cal10/proceedings, p.26\nLuppino, G. A., & Kaiser, N. 1997, ApJ, 475, 20\nMakinson, D. 2012, Sets, Logic and Maths for Computing, Undergraduate Topics in Computer Science (London: Springer-Verlag)\nMandelbaum, R., Hirata, C. M., Leauthaud, A., Massey, R. J.,& Rhodes, J. 2012, MNRAS, 420, 1518\nMandelbaum, R., Hirata, C. M., Seljak, U., et al. 2005, MNRAS, 361, 1287\n37\nMandelbaum, R., Rowe, B., Bosch, J., et al. 2014, ApJS, 212, 5\nMassey, R., & Refregier, A. 2005, MNRAS, 363, 197\nMassey, R., Stoughton, C., Leauthaud, A., et al. 2010, MNRAS, 401, 371\nMassey, R., Heymans, C., Bergé, J., et al. 2007, MNRAS, 376, 13\nMassey, R., Hoekstra, H., Kitching, T., et al. 2013, MNRAS, 429, 661\nMelchior, P., Böhnert, A., Lombardi, M., & Bartelmann, M. 2010, A&A, 510, A75\nMelchior, P., & Viola, M. 2012, MNRAS, 424, 2757\nMeng, Z., Zhou, X., Zhang, H., et al. 2013, PASP, 125, 1015\nMeyers, J. E., & Burchat, P. R. 2014, Journal of Instrumentation, 9, C3037\nMiyazaki, S., Komiyama, Y ., Nakaya, H., et al. 2012, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 8446, Society of\nPhoto-Optical Instrumentation Engineers (SPIE) Conference Series\nMoffat, A. F. J. 1969, A&A, 3, 455\nMoore, A. C., Ninkov, Z., & Forrest, W. J. 2004, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 5167, Focal Plane Arrays\nfor Space Telescopes, ed. T. J. Grycewicz & C. R. McCreight, 204–215\nNakajima, R., & Bernstein, G. 2007, AJ, 133, 1763\nNavarro, J. F., Frenk, C. S., & White, S. D. M. 1996, ApJ, 462, 563\nNoll, R. J. 1976, Journal of the Optical Society of America (1917-1983), 66, 207\nPatterson, F. S. 1940, Harvard College Observatory Bulletin, 914, 9\nPatterson, T. 1968, Mathematics of Computation, 22, 847\nPeacock, J. A., Schneider, P., Efstathiou, G., et al. 2006, ESA-ESO Working Group on “Fundamental Cosmology”, Tech. rep., arXiv:0610906\nPence, W. D., Chiappetti, L., Page, C. G., Shaw, R. A., & Stobie, E. 2010, A&A, 524, A42\nPlazas, A. A., & Bernstein, G. 2012, PASP, 124, 1113\nPlazas, A. A., Bernstein, G. M., & Sheldon, E. S. 2014, Journal of Instrumentation, 9, C4001\nPress, W. H., Teukolsky, S. A., Vetterling, W. T., & Flannery, B. P. 1992, Numerical recipes in C: The art of scientiﬁc computing, 2nd ed. (Cambridge: Cambridge\nUniversity Press)\nRacine, R. 1996, PASP, 108, 699\nRasmussen, A. 2014, Journal of Instrumentation, 9, C4027\nRefregier, A. 2003, MNRAS, 338, 35\nRefregier, A., Kacprzak, T., Amara, A., Bridle, S., & Rowe, B. 2012, MNRAS, 425, 1951\nReyes, R., Mandelbaum, R., Gunn, J. E., et al. 2012, MNRAS, 425, 2610\nRhodes, J., Leauthaud, A., Stoughton, C., et al. 2010, PASP,122, 439\nRolland, G., Pinheiro da Silva, L., Inguimbert, C., et al. 2008, Nuclear Science, IEEE Transactions on, 55, 2070\nRowe, B., Bacon, D., Massey, R., et al. 2013, MNRAS, 435, 822\nSánchez, E., et al. 2010, Journal of Physics Conference Series, 259, 012080\nSchmidt, F., Leauthaud, A., Massey, R., et al. 2012, ApJL, 744, L22\nSchneider, P. 2006, in Saas-Fee Advanced Course 33: Gravitational Lensing: Strong, Weak and Micro, ed. G. Meylan, P. Jetzer, P. North, P. Schneider, C. S.\nKochanek, & J. Wambsganss (Berlin: Springer), 269\nSchneider, P., van Waerbeke, L., & Mellier, Y . 2002, A&A, 389, 729\nScoville, N., Aussel, H., Brusa, M., et al. 2007, ApJS, 172, 1\nSemboloni, E., Hoekstra, H., Huang, Z., et al. 2013, MNRAS, 432, 2385\nSérsic, J. L. 1963, Boletin de la Asociacion Argentina de Astronomia La Plata Argentina, 6, 41\nSeshadri, S., Shapiro, C., Goodsall, T., et al. 2013, PASP, 125, 1065\nSheldon, E. S. 2014, MNRAS, 444, L25\nvan Waerbeke, L. 2010, MNRAS, 401, 2093\nVelander, M., Kuijken, K., & Schrabback, T. 2011, MNRAS, 412, 2665\nV oigt, L. M., & Bridle, S. L. 2010, MNRAS, 404, 458\nV oigt, L. M., Bridle, S. L., Amara, A., et al. 2012, MNRAS, 421, 1385\nWright, C. O., & Brainerd, T. G. 2000, ApJ, 534, 34\nWynne, C. G., Worswick, S. P., Lowne, C. M., & Jorden, P. R. 1984, The Observatory, 104, 23\nZernike, F. 1934, MNRAS, 94, 377\n38'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00010\n∆g1  (DFT - photon)'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00010\n∆g2  (DFT - photon)'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.1 0.2 0.3 0.4 0.5 0.6 0.7'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00002\n0.00003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00004\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\nMultiplicative slope mDFT'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0002'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0004\nMultiplicative slope m reconv')], 'output_text': '# 项目技术概述文档\n\n## 1. 技术方法\n- **核心技术**：GAL SIM软件用于天文图像模拟，能够处理噪声和图像变换。\n- **算法**：采用噪声白化技术和傅里叶变换进行高精度图像渲染。\n\n## 2. 架构设计\n- **整体架构**：项目由多个类和方法组成，主要包括RealGalaxy类、Image类、以及用于噪声处理的whitenNoise和symmetrizeNoise方法。\n- **模块间关系**：各模块协同工作以实现图像的生成、变换和高精度渲染。\n\n## 3. 功能模块\n- **RealGalaxy类**：负责模拟真实的银河图像。\n- **Image类**：用于图像的创建和操作。\n- **whitenNoise方法**：用于处理图像中的相关噪声。\n- **symmetrizeNoise方法**：进一步优化噪声处理效果。\n\n## 4. 实现细节\n- **噪声处理**：通过噪声白化技术有效减少图像中的相关噪声，提高图像质量。\n- **图像渲染**：使用傅里叶变换技术实现高精度的图像渲染，满足天文学研究的需求。\n\n## 5. 应用场景\n- **天文学研究**：适用于高精度的天文图像模拟，特别是弱引力透镜效应的研究。\n- **算法测试**：为图像处理算法的开发和测试提供可靠的模拟数据。\n- **数据集支持**：适用于当前数据集以及未来的Stage IV暗能量调查。\n\n## 6. 优势特点\n- **高精度**：满足弱引力透镜等高精度图像分析的严格要求。\n- **开源工具**：作为开源软件，便于天文学社区的广泛使用和持续改进。\n- **高效处理**：能够高效地进行图像变换和操作，支持大规模数据处理。'}
---------- user ----------
请根据文档说明项目使用的主要技术方法。
---------- project_assistant ----------
[MemoryContent(content={'input_documents': [Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='arXiv:1407.7676v3  [astro-ph.IM]  15 Feb 2015\nG AL SIM : The modular galaxy image simulation toolkit\nBarnaby Rowea,b,c,∗, Mike Jarvisd,∗, Rachel Mandelbaume,∗, Gary M. Bernsteind, James Boschf, Melanie Simete,\nJoshua E. Meyersg, Tomasz Kacprzaka,h, Reiko Nakajimai, Joe Zuntzh, Hironao Miyatakef,j, Jörg P. Dietrichk,l, Robert Armstrongf,\nPeter Melchiorm , Mandeep S. S. Gilln\naDepartment of Physics & Astronomy, University College London, Gower Street, London, WC1E 6BT, United Kingdom\nbJet Propulsion Laboratory, California Institute of Technology, 4800 Oak Grove Drive, Pasadena, CA 91109, United States of America\ncCalifornia Institute of Technology, 1200 East California Boulevard, Pasadena, CA 91106, United States of America\ndDepartment of Physics & Astronomy, University of Pennsylvania, Philadelphia, PA 19104, United States of America\neMcWilliams Center for Cosmology, Department of Physics, Carnegie Mellon University, 5000 Forbes Ave., Pittsburgh, PA15213, United States of America\nfDepartment of Astrophysical Sciences, Princeton University, Peyton Hall, Princeton, NJ 08544, United States of America\ngKavli Institute for Particle Astrophysics and Cosmology, Department of Physics, Stanford University, Stanford, CA 94305, United States of America\nhJodrell Bank Centre for Astrophysics, University of Manchester, Manchester, M13 9PL, United Kingdom\niArgelander-Institut für Astronomie, Universität Bonn, Auf dem Hügel 71, D-53121 Bonn, Germany\njKavli Institute for the Physics and Mathematics of the Universe (Kavli IPMU, WPI), The University of Tokyo, Kashiwa, Chiba 277-8582, Japan\nkUniversitäts-Sternwarte München, Scheinerstr. 1, 81679 München, Germany\nlExcellence Cluster Universe, 85748 Garching b. München, Germany\nm Center for Cosmology and Astro-Particle Physics and Department of Physics, The Ohio State University, Columbus, OH 43210, United States of America\nnKavli Institute for Particle Astrophysics and Cosmology, SLAC National Accelerator Laboratory, Menlo Park, CA 94025-7015, United States of America\nAbstract\nG AL SIM is a collaborative, open-source project aimed at providingan image simulation tool of enduring beneﬁt to the astronomical\ncommunity. It provides a software library for generating images of astronomical objects such as stars and galaxies in a variety of\nways, efﬁciently handling image transformations and operations such as convolution and rendering at high precision. We describe\nthe GAL SIM software and its capabilities, including necessary theoretical background. We demonstrate that the performance of\nG AL SIM meets the stringent requirements of high precision image analysis applications such as weak gravitational lensing, for\ncurrent datasets and for the Stage IV dark energy surveys of the Large Synoptic Survey Telescope, ESA’sEuclidmission, and\nNASA’s WFIRST-AFTA mission. The GAL SIM project repository is public and includes the full code history, all open and closed\nissues, installation instructions, documentation, and wiki pages (including a Frequently Asked Questions section).The G AL SIM\nrepository can be found athttps://github.com/GalSim-developers/GalSim.\nKeywords: methods: data analysis, techniques: image processing, gravitational lensing, cosmology: observations\n1. Introduction\nRapid advances in instrumentation and telescope technology\nare forcing changes in the techniques used to analyse astronom-\nical data. As data volumes increase, and statistical uncertainties\ndecrease correspondingly, systematic biases resulting from im-\nperfect or approximate inference must be reduced to ensure full\nreturn on investments made into increasingly large projects.\nAn area of research where technology and data volumes\nare placing increasingly stringent requirements on data anal-\nysis methodology is observational cosmology. Recent years\nhave seen a number of wide area, long exposure imaging sur-\nveys of the extragalactic sky from both ground-based tele-\nscopes (e.g. SDSS1, CFHTLS 2,3: see Abazajian et al., 2009;\n∗Corresponding author\nEmail addresses:browe@star.ucl.ac.uk(Barnaby Rowe),\nmichael@jarvis.net(Mike Jarvis),rmandelb@andrew.cmu.edu\n(Rachel Mandelbaum)\n1http://www.sdss.org/\n2http://www.cfht.hawaii.edu/Science/CFHTLS/\n3http://www.cfhtlens.org/\nHeymans et al., 2012, respectively) and space (COSMOS4: see\nScoville et al., 2007). Data from these projects continue tobe\nexploited for their rich scientiﬁc content.\nMore ambitious ground-based projects are already un-\nderway, including the Dark Energy Survey5 (DES: see\ne.g. Sánchez et al., 2010), Hyper Suprime-Cam6 (HSC: see\nMiyazaki et al., 2012) and the Kilo Degree Survey7 (KiDS: see\nde Jong et al., 2013). By most measures these upcoming sur-\nveys of the deep extragalactic sky will bring an order of mag-\nnitude more imaging data than their recent predecessors. In\nthe 2020s, the ground-based Large Synoptic Survey Telescope\n(LSST 8), and the ESAEuclid9 and NASA WFIRST-AFTA 10\nspace missions, will be taking extragalactic imaging data in\n4http://cosmos.astro.caltech.edu/\n5http://www.darkenergysurvey.org/\n6http://www.naoj.org/Projects/HSC/\n7http://kids.strw.leidenuniv.nl/\n8http://www.lsst.org/lsst/\n9http://sci.esa.int/euclid/, http://www.euclid-ec.\norg\n10http://wfirst.gsfc.nasa.gov/\nPreprint submitted to Elsevier February 17, 2015\nvast quantities. These successive generations of projectsare\nexamples of “Stage III” and “Stage IV” dark energy surveys\n(Albrecht et al., 2006).\nThe increasing data volumes in these planned surveys are\ndue to increases in survey area and, to a somewhat lesser ex-\ntent, depth, as motivated by their science goals (Albrecht et al.,\n2006; Peacock et al., 2006). Increasing area and depth brings\na greater number of galaxy objects, and thus a decrease in the\nstatistical uncertainties on ﬁnal measurements. However,this\nmeans that the tolerablesystematicerror in the inferred prop-\nerties of each galaxy needs to be reduced commensurately. As\nsurveys become larger, the accurate estimation of galaxy prop-\nerties from noisy images becomes increasingly important. In\nthis context the GAL SIM project was conceived, aiming to pro-\nvide a common image simulation tool for use across multiple\nsurveys and to aid comparison between measurement methods.\nWeak gravitational lensing (for reviews see, e.g., Schneider,\n2006; Bartelmann, 2010; Huterer, 2010) is a prime example ofa\nscientiﬁc application that relies on reliable inference regarding\nthe properties of astrophysical objects from imperfect images.\nHere theshape of the galaxy (typically some property related\nto its ellipticity) is used to construct a noisy estimate of gravi-\ntationalshear, which can be related to second derivatives of the\nprojected gravitational potential and is thus sensitive toall mat-\nter (including dark matter). Weak lensing can be used to con-\nstrain both cosmic expansion and the growth of matter structure\nover time, and is thus valuable as a test of dark energy and mod-\niﬁed gravity models (e.g. Albrecht et al., 2006; Peacock et al.,\n2006).\nTo achieve this potential as a probe of cosmology,\nhowever, the weak lensing community must control ad-\nditive and multiplicative systematic biases in shear esti-\nmates to∼ 2 × 10−4 and 2 × 10−3, respectively (e.g.\nHuterer et al., 2006; Amara & Réfrégier, 2008; Massey et al.,\n2013; Mandelbaum et al., 2014). This accuracy must be\nachieved in the presence of detector imperfections, telescope\nblurring and distortion, atmospheric effects (for ground-based\nsurveys), and noise (galaxies used for lensing typically have a\nsignal-to-noise ratio of the ﬂux as low as 10). Weak lensing\ninference for cosmology presents a signiﬁcant technical chal-\nlenge.\nSimulations of astronomical imaging data will play an\nimportant part in meeting this challenge. For example,\nweak lensing estimators typically invoke non-linear com-\nbinations of image pixels, and can be shown to suf-\nfer from generic systematic biases when applied to noisy\ngalaxy images (e.g. Kaiser, 2000; Bernstein & Jarvis, 2002;\nHirata et al., 2004; Refregier et al., 2012; Melchior & Viola,\n2012) unless constructed extremely carefully (Kaiser, 2000;\nBernstein & Armstrong, 2014). Simulations of weak lensing\nsurvey data in the GREAT08 (GRavitational lEnsing Accuracy\nTesting 2008) challenge (Bridle et al., 2010) clearly showed\nthe impact of noise in a blind comparison of shear estima-\ntion methods. This helped reinvigorate activity aimed at bet-\nter characterizing these “noise biases” (Refregier et al.,2012;\nMelchior & Viola, 2012; Kacprzak et al., 2012) or eliminating\nthem (Bernstein & Armstrong, 2014).\nAnother type of bias arises when true galaxy surface bright-\nness proﬁles do not match the models being ﬁt, often referred\nto as model bias or underﬁtting bias (e.g. V oigt & Bridle, 2010;\nBernstein, 2010; Melchior et al., 2010; Kacprzak et al., 2014).\nOne of the goals of GREAT3 (Mandelbaum et al., 2014), the\nthird challenge in the GREAT series, is to explore the im-\npact of model bias across a range of shear measurement meth-\nods. For one of its “experiments”, it takes real galaxy images\nfrom theHubble Space Telescope(HST ) as the underlying sur-\nface brightness proﬁles of the galaxies, and draws sheared ver-\nsions of these proﬁles using a method derived from that of\nMandelbaum et al., 2012: see §6.5 in this article. GREAT3\nalso involved controlled tests of the impact of multiepoch (i.e.\nmultiple exposure) imaging and realistic uncertainty about the\npoint spread function (PSF) in survey data (Mandelbaum et al.,\n2014). The initial imperative for developing GAL SIM was\nspeciﬁcally to enable the creation of the required images for\nthe GREAT3 challenge.\nBut there are other issues in both space and ground-\nbased data that are still to be fully addressed for preci-\nsion photometry and shape estimation. These include ob-\nject confusion (or deblending), PSF-object colour mismatch-\ning (Cypriano et al., 2010), differential atmospheric chromatic\nrefraction (Meyers & Burchat, 2014), galaxy colour gradients\n(V oigt et al., 2012; Semboloni et al., 2013), and non-linearde-\ntector effects (e.g. Rhodes et al., 2010; Seshadri et al., 2013;\nAntilogus et al., 2014). Simulation investigations into the many\ndifferent aspects of the shear measurement problem will con-\ntinue to improve our understanding of how to meet these chal-\nlenges for upcoming surveys.\nSystematic biases are likely to be present, to some degree, in\nallpracticalestimators of shear, and thus simulations of weak\nlensing observations will berequiredfor precision cosmology:\neither to estimate (and thus calibrate) biases for a given sur-\nvey, or (ideally) to demonstrate that they have been controlled\nto tolerable levels. The same is also true of the many applica-\ntions that rely on highly accurate photometry and astrometry.\nThese measurements often require steps such as the classiﬁ-\ncation and removal of outliers, the application of calibration\ncorrections, and the ﬁtting of models to data; simulated tests\nof these techniques are typically necessary. Those who study\ngalaxy properties by ﬁtting parametric models in order to learn\nsomething about galaxy evolution also beneﬁt from controlled\nsimulations with which to test their analysis methods. Moti-\nvated by these requirements, the GAL SIM project has drawn\ncontributions from members of multiple Stage III and Stage\nIV survey collaborations, aimed at producing an open-source,\ncommunity-vetted toolkit for building these indispensable im-\nage simulations.\nThe structure of this paper is as follows. In §2 we provide an\noverview of the GAL SIM software toolkit, and describe the mo-\ntivation and structure of the different component parts of GAL -\nSIM . In §2.3 we provide references to where these component\nparts are described, in greater detail, in the rest of the paper.\nIn §3 we describe the types of astronomical objects that\nG AL SIM can currently represent. In §4 we describe the GAL -\nSIM “lensing engine”, which generates cosmologically moti-\n2\nvated shear ﬁelds. In §5 we describe how transformations be-\ntween coordinate systems are represented, including between\nimage pixel coordinates and “world coordinate systems” (which\nmay use either celestial coordinates or a Euclidean tangent\nplane approximation). In §6 we describe how GAL SIM objects\nare rendered to form images, and §7 describes the noise models\nthat can be invoked to add noise to images. In §8 we describe\nsome of the shear estimation routines that come as part of GAL -\nSIM .\nIn §9 we describe the numerical validation of GAL SIM via\nseries of tests and comparisons, and §10 discusses performance.\nIn §11 we highlight some important effects in real data that\nG AL SIM does not currently include, and we end with a sum-\nmary and conclusions in §12.\n2. Software overview\nThe design and characteristics of GAL SIM arose through the\nneed to meet goals and requirements that were set down early in\nthe life of the project. We describe these, along with some as-\npects of the collaborative development process, and show how\nthey led to the current state of the GAL SIM software. All of\nthe code described in this paper can be found in version 1.2 of\nG AL SIM .\n2.1. Science requirements\nThe basic capabilities of GAL SIM were driven by the need\nto meet the following requirements for simulating astronomical\nimages:\n1. The ability to ﬂexibly represent and render a broad range\nof models for astronomical objects in imaging data, in-\ncluding observationally-motivated PSF and galaxy pro-\nﬁles.\n2. Handling of coordinate transformations such as shear, di-\nlation and rotation for all objects being rendered, moti-\nvated by the need to simulate weak lensing effects at high\nprecision.\n3. Representation of the convolution of two or more objects,\nto describe the convolution of galaxy surface brightness\nproﬁles with PSFs.\n4. Accuracy in object transformation, convolution and ren-\ndering at the level required for Stage IV surveys.\n5. Flexibility in specifying image pixel noise models and data\nconﬁgurations (e.g. overlapping objects), so as to allow\nthe importance of these data properties to be evaluated in\ncontrolled tests.\n6. The ability to do all the above for galaxy or PSF models\ngenerated from an input image, e.g. from theHST , so as\nto be able to compare results against those obtained from\nsimpler parametric prescriptions for galaxies and PSF pro-\nﬁles.\nAs can be seen, many of these requirements are driven by the\nneed to simulate weak lensing observations. Precision sim-\nulation of astrometry and photometry places similar require-\nments.11 Software which meets the above requirements is there-\nfore of great value for simulations that require accurate photom-\netry (e.g. for photometric redshift estimation).\n2.2. Software design requirements\nIn addition to the scientiﬁc goals for the GAL SIM project, an\nemphasis was also placed on software design and implementa-\ntion considerations. GAL SIM was conceived to be freely avail-\nable under an open-source (BSD-style) license, and writtenin\nnon-proprietary programming languages, making it available to\nall. This aim is satisﬁed by the choice of Python in combination\nwith C++.\nG AL SIM was also designed to bemodular, i.e. separated into\nvarious functional components, and thus easily extensible. En-\nforcing modularity allows parts of the code to be written and\nmaintained independently by multiple individuals. This design\nfeature was important in allowing GAL SIM to be developed col-\nlaboratively. Within a modular program design there is scope\nfor different modules (with a common interface) to be used in-\nterchangeably, and this property was crucial in providing the\nﬂexibility demanded by GAL SIM ’s science goals (§2.1: item\n1). Future extensions to the project also occur naturally within\nthis framework as additional modules.\nTo ensure that the learning curve for GAL SIM users is as easy\nas possible, we require clear documentation on all new features\nbefore they are deployed, and major features are demonstrated\nin heavily-commented example scripts that amount to a kind of\ntutorial for how to use GalSim. Writing these example scripts\nhas been very useful as a design tool to help determine what\nuser interface is most natural for realistic applications.\nSimilarly, all new code also requires an accompanying test\nsuite before being merged into the main code base. While we\nhave not tried to impose the precepts of test-driven development\nwithin the collaboration, we do take seriously the requirement\nthat all code be tested as comprehensively as possible. In addi-\ntion to checking the general validity of new code, the extensive\nunit tests have proved extremely valuable for dealing with is-\nsues of cross-platform portability: we regularly run the tests on\na wide variety of systems with various idiosyncrasies.\nFinally, we require all new code to undergo extensive code\nreview by the rest of the development team, including reviewof\nthe code, the documentation, and the unit tests. This reviewpro-\ncess is facilitated by the “Pull Request” feature of GITH UB 12,\nwhere the code is hosted. The other members of the collabora-\ntion team can easily see the set of changes being proposed and\neven comment on individual lines of code. While bugs are in-\nevitable at some level no matter how much care is taken to avoid\nthem, these steps have been quite effective at catching bugsand\ndocumentation errors before code is deployed.\n2.3. The structure ofG AL SIM\nGiven the emphasis on modularity, and the desire to make the\nsoftware easily useable for as many scientiﬁc projects and ap-\nplications as possible, GAL SIM was conceived from the outset\n11For example, see http://www.lsst.org/files/docs/SRD.\npdf.\n12https://github.com\n3\nto be a toolkit of library routines rather than as a “monolithic”\npackage. From the user’s perspective GAL SIM is fundamen-\ntally a Pythonclass library, providing a number of objects that\ncan be employed for astronomical image simulation in almost\nany combination speciﬁed by the calling code.\nIn addition, for users who may be more comfortable using\nconﬁguration ﬁles than writing Python code, we also provide\na stand-alone executable that reads relatively simple conﬁgura-\ntion ﬁles, which can carry out most of the important GAL SIM\nfunctionality. In particular, each of the tutorial examplescripts\nhave a corresponding conﬁguration ﬁle that produces the same\noutput ﬁles13. Information about the conﬁguration ﬁle interface\ncan be found on the GAL SIM wiki14.\nThe classes and functions in the GAL SIM toolkit can be\nseparated into the following broad categories by functionality.\nThese are (with references to relevant Sections of this article):\n• Representing astronomical objects, including any transfor-\nmations, distortions, and convolutions (see §3).\n• Generating gravitational lensing distortions to be applied\nto astronomical objects (see §4).\n• Characterizing the connection between image coordinates\nand world coordinates (see §5).\n• Rendering the proﬁles into images (see §6).\n• Generating random numbers, and using these to apply\nnoise to images according to physically-motivated models\n(see §7).\n• Estimating the shapes of objects once these have been ren-\ndered into images (useful for testing, see §8).\nFor information about the practical use of these tools, we refer\nthe reader to the online documentation available at the GAL SIM\nproject page15. Further information and a forum for questions\nregarding the structure or usage of the GAL SIM software can\nbe found in the repository Issues pages, or via thegalsimtag\non the StackOverﬂow web site16.\nWhile Python serves as the principal user interface to GAL -\nSIM , many of the numerical calculations are actually imple-\nmented in C++. However, this should be considered a mere\nimplementation detail; the structure of GAL SIM is intended to\nprevent the user from needing to interface with the C++ layer\ndirectly.\nIn this paper, we will focus on a scientiﬁc, theoretical de-\nscription of the output generated by GAL SIM ’s classes and\nfunctions, and the validation of those outputs to ensure they\nmeet our accuracy requirements.\n13 Actually, as of version 1.2, the chromatic functionality has yet to be\nported over to the conﬁguration interface, so the example script for that\n(demo12) does not yet have a corresponding conﬁguration ﬁle. We plan to\nadd this functionality in the near future.\n14 https://github.com/GalSim-developers/GalSim/\nwiki/Config-Documentation\n15See https://github.com/GalSim-developers/GalSim.\nThe example scripts and Quick Reference Guide provide a goodstarting point\nfor documentation, in addition to the Python docstrings forindividual functions\nand class methods.\n16http://stackoverflow.com/tags/galsim/info\n3. Surface brightness proﬁles\nIn this section we describe the kinds of surface brightness\nproﬁles that are available in GAL SIM . We include their analytic\nformulae where appropriate, and the physical and observational\nmotivations for the models.\n3.1. Galaxy models\n3.1.1. The exponential disk proﬁle\nFirst identiﬁed in M33 by Patterson (1940), and observed\nsystematically by de Vaucouleurs (1959) as a characteristic\ncomponent of the light proﬁle in a sample of the brightest\nnearby galaxies, the exponential disk proﬁle provides a good\ndescription of the outer, star-forming regions of spiral galaxies\n(e.g. Lackner & Gunn, 2012).\nThe surface brightness of an exponential disk proﬁle varies\nas\nI(r)= F\n2πr2\n0\ne−r/r0 (1)\n= F\n2.23057r2e\ne−1.67835r/re, (2)\nwhere F is the total ﬂux,r0 is the scale radius, andre =\n1.67835r0 is the half-light radius, the radius that encloses half\nof the total ﬂux.\nIt is represented in GAL SIM by theExponentialclass,\nand the size can be speciﬁed using eitherr0 or the half-light\nradius.\n3.1.2. The de Vaucouleurs proﬁle\nThis proﬁle (ﬁrst used by de Vaucouleurs, 1948) is found to\ngive a good ﬁt to the light proﬁles of both elliptical galaxies\nand the central bulge regions of galaxies that are still actively\nstar-forming (e.g. Lackner & Gunn, 2012).\nThe surface brightness of a de Vaucouleurs proﬁle varies as\nI(r)= F\n7!·8πr2\n0\ne−(r/r0)1/4\n(3)\n= F\n0.010584r2e\ne−7.66925(r/re)1/4\n, (4)\nwhere F is the total ﬂux,r0 is the scale radius, andre is the\nhalf-light radius.\nDe Vaucouleurs proﬁles are notorious for having both very\ncuspy cores and also very broad wings. The cusp occurs around\nthe size of the scale radiusr0, but because of the broad wings,\nthe half-light radius is several orders of magnitude larger17. As\nsuch, the second formula is more often used in practice.\nIt is represented in GAL SIM by theDeVaucouleursclass,\nand the size can be speciﬁed using eitherr0 or the half-light\nradius.\nBecause de Vaucouleurs proﬁles have such broad wings, it\nis sometimes desirable to truncate the proﬁle at some radius,\nrather than allow it extend to inﬁnity. Thus, GAL SIM provides\nthe option of specifying a truncation radius beyond which to\nhave the surface brightness drop to zero.\n17 More precisely,re ≃ 3459.485r0\n4\n3.1.3. The Sérsic proﬁle\nThis proﬁle, developed by Sérsic (1963), is a generalization\nof both the exponential and de Vaucouleurs proﬁles. The sur-\nface brightness of a Sérsic proﬁle proﬁle varies as\nI(r)= F\n2nπΓ(2n)r2\n0\ne−(r/r0)1/n\n(5)\n= F\na(n)r2e\ne−b(n)(r/re)1/n\n, (6)\nwhere F is the total ﬂux,r0 is the scale radius,re is the half-\nlight radius, anda(n) andb(n) are known functions with nu-\nmerical solutions. Note that the indexn need not be an integer.\nFlux normalization determinesa(n). To calculateb(n) in GAL -\nSIM we start with the approximation given by Ciotti & Bertin\n(1999), then perform a small number of iterations of a numeri-\ncal, non-linear root solver to increase accuracy.\nAs with the de Vaucouleurs proﬁle, it is standard practice to\nuse the second formula using the half-light radius, since that\nsize more closely matches the apparent size of the galaxy, par-\nticularly for largern values (n ≳ 2.5).\nThe Sérsic proﬁle is represented in GAL SIM by theSer-\nsicclass, and the size can be speciﬁed using eitherr0 or the\nhalf-light radius. Then parameter is allowed to range from\nn = 0.3, below which there are serious numerical problems,\nton = 6.2, above which rendering inaccuracy may exceed the\nrequirements set for GAL SIM (see §9.1).\nAs withDeVaucouleurs, it is also possible to specify a\ntruncation radius for the proﬁle, rather than allow it to extend\nindeﬁnitely.\n3.1.4. Galaxy proﬁles from direct observations\nObservations made using theHST provide high resolu-\ntion images of individual galaxies that can be used as di-\nrect models of light proﬁles for simulations (Kaiser, 2000;\nMandelbaum et al., 2012). These proﬁles naturally include re-\nalistic morphological variation and irregular galaxies, acontri-\nbution of increasing importance to the galaxy population athigh\nredshift.\nThe details of the implementation of such galaxy proﬁles are\ncovered in two later Sections: §3.3.3, which describes how ob-\njects are represented via two-dimensional lookup tables, and\n§6.5, which discusses the speciﬁcs of howHST galaxy images\nand their PSFs are handled by GAL SIM . However, it is worth\nstating here that such a model, based on direct observationsof\na large sample of individual galaxies, is available in GAL SIM .\nIt is represented in GAL SIM by theRealGalaxyclass.\n3.2. Stellar & PSF models\n3.2.1. The Airy & obscured Airy proﬁle\nThe ﬁnite circular aperture of a telescope gives rise to a\ndiffraction pattern for the light passing through the aperture, an\neffect ﬁrst explained by Airy (1835). The resulting image has a\ncentral peak surrounded by a series of rings.\nThe theoretical intensity distribution for a perfectly circular\naperture is given by\nI(r)=\n[ J1(ν)\nν\n] 2\n, (7)\nν≡ πrD /λ, (8)\nwhere D is the diameter of the telescope,λ is the wavelength\nof the light (see, e.g., Born & Wolf, 1999), andJ1 is the Bessel\nfunction of the ﬁrst kind of order one.\nIn many telescopes, the light is additionally diffracted bya\ncentral circular obscuration – either a secondary mirror ora\nprime focus camera. The diffraction pattern in this case is also\nanalytic:\nI(r)=\n[ J1(ν)−ǫJ1(ǫν)\nν\n] 2\n, (9)\nwhere ǫis the fraction of the pupil radius (as a linear dimension,\nnot by area) that is obscured.\nIt is represented in GAL SIM by theAiryclass, and the size\nis speciﬁed in terms ofλ/D , which dimensionally gives a size\nin radians, but which is typically converted to arcsec in practice.\n3.2.2. The Zernike aberration model\nComplex, aberrated wavefronts incident on a circular pupil\ncan often be well approximated by a sum of Zernike polyno-\nmials (Zernike, 1934). These functions form an orthogonal set\nover a circle of unit radius.\nIn GAL SIM the convention of Noll (1976) is adopted, which\nlabels these polynomials by an integerj. It is also useful to\ndeﬁne the polynomials in terms ofn and m , which are functions\nof jsatisfying|m | ≤ n withn −|m |being even18. The integersn\nand m specify the Zernike polynomials in polar coordinates as\nZeven j =\n√\n2(n +1)Rm\nn(r) cos(m θ) (10)\nZodd j =\n√\n2(n +1)Rm\nn(r) sin(m θ) (11)\nfor integerm /nequal0 and integern, and\nZ j =\n√\nn +1R0\nn(r), (12)\nform = 0, where\nRm\nn(r)=\n(n−m )/2∑\ns=0\nr(n−2s) (−1)s(n−s)!\ns!\n[ n+m\n2 −s\n]\n!\n[ n−m\n2 −s\n]\n!\n. (13)\nThe low order Zernike polynomials map to the low order\naberrations commonly found in telescopes, such as defocus (j=\n4), astigmatism (j = 5,6), coma (j = 7,8), trefoil (j = 9,10)\netc. In practice, Zernike polynomials have been found to pro-\nvide a convenient, and compact, approximate model for tele-\nscope aberrations.\nGiven such a model for the wavefront incident at the pupil,\nthe PSF is also determined at a given image plane location. In\n18 Speciﬁcally, the rule is that the Noll indicesjare in order of increasing\nn, and then increasing|m |, and negativem values have oddj(Noll, 1976).\n5\nthe Fraunhofer diffraction limit, the PSF is calculated as the\nFourier transform of the autocorrelation of the pupil wavefront.\nThe resulting proﬁle is represented in GAL SIM by theOp-\nticalPSFclass. The size is speciﬁed in terms ofλ/D , just as\nforAiry. There are also options for specifying a circular cen-\ntral obscuration as well as rectangular support struts. In GAL -\nSIM versions through 1.1, aberrations up to Noll indexj = 11\n(spherical aberration) can be included, but there are plansto\nallow for Zernike terms to arbitrary order.\nBecause the proﬁle is not analytic in either real or Fourier\nspace, the implementation of this class in GAL SIM involves\ncreating an image of the PSF in real space by Discrete Fourier\nTransform, and then using theInterpolatedImageclass\nto handle the interpolation across this image. Therefore, the\ntechniques that we will describe in §6 for interpolated images\nalso apply toOpticalPSF.\n3.2.3. The Moffat proﬁle\nMoffat (1969) investigated the hypothesis that stellar PSFs\ncould be modelled as a Gaussian seeing kernel convolved by\nan obstructed Airy diffraction pattern. He discovered thatthe\nGaussian was not a viable model for the seeing component.\nInstead, he developed an analytic model for stellar PSFs with\nbroader wings that provides a better ﬁt to observations, a model\nwhich now bears his name.\nThe surface brightness of a Moffat proﬁle varies as\nI(r)= F (β−1)\nπr2\n0\n[\n1 +(r/r0)2] −β\n(14)\nwhere F is the total ﬂux,r0 is the scale radius, andβtypically\nranges from 2 to 5. In the limitβ→ ∞, the Moffat proﬁle tends\ntowards a Gaussian.\nIt is represented in GAL SIM by theMoffatclass, and the\nsize can be speciﬁed usingr0, the full-width at half-maximum\n(FWHM), or the half-light radius. It is also possible to specify\na truncation radius for the Moffat proﬁle, rather than allowit to\nextend indeﬁnitely.\n3.2.4. The Kolmogorov proﬁle\nIn a long ground-based exposure, the PSF is predicted to fol-\nlow a particular functional form due to the Kolmogorov spec-\ntrum of turbulence in the atmosphere. Racine (1996) showed\nthat this prediction was indeed a better ﬁt to the observations of\nstars in long exposures than a Moffat proﬁle.\nThe surface brightness of a Kolmogorov proﬁle is deﬁned in\nFourier space as\n˜I(k)= F e−(k/k0)5/3\n, (15)\nwhere F is the total ﬂux,k0 = Aλ/r0,A ≃ 2.99 is a constant\ngiven by Fried (1966), and herer0 is the Fried parameter (to\nbe distinguished from the use ofr0 to denote the scale radius in\nother proﬁles). Typical values for the Fried parameter are on the\norder of 10 cm for most observatories and up to 20 cm for ex-\ncellent sites. The values are usually quoted atλ= 500 nm, and\nthe Fried parameterr0 depends on wavelength asr0 ∝ λ−6/5.\nThis proﬁle is represented in GAL SIM by theKolmogorov\nclass, and the size can be speciﬁed usingλ/r0, the FWHM, or\nthe half-light radius.\n3.3. Generic models\n3.3.1. The Gaussian proﬁle\nThe Gaussian proﬁle has convenient properties: it is rel-\natively compact and analytic in both real space and Fourier\nspace, and convolutions of Gaussian proﬁles can themselvesbe\nwritten as a new Gaussian proﬁle. Observational propertiesof\nGaussian proﬁles, such as their second moments, are also typi-\ncally analytic.\nFor this reason the Gaussian proﬁle is often used to represent\ngalaxies and PSFs in simple simulations where speed is valued\nabove realism. And thanks to its analytic properties, it hasgreat\nvalue for testing purposes. Furthermore, while a single Gaus-\nsian proﬁle is generally a poor approximation to both real PSFs\nand real galaxies, linear superpositions of Gaussian proﬁles can\nbe used to approximate realistic proﬁles with much greater ac-\ncuracy (e.g. Hogg & Lang, 2013; Sheldon, 2014).\nThe surface brightness of a Gaussian proﬁle varies as\nI(r)= F\n2πσ2 e−r2/2σ2\n, (16)\nwhere F is the total ﬂux andσis the usual Gaussian scale pa-\nrameter.\nIt is represented in GAL SIM by theGaussianclass, and\nthe size can be speciﬁed usingσ, the FWHM, or the half-light\nradius.\n3.3.2. Shapelet proﬁles\nShapelets were developed independently by\nBernstein & Jarvis (2002) and Refregier (2003) as an ef-\nfective means of characterizing compact surface brightness\nproﬁles such as galaxies or stars. The shapelets basis set\nconsists of two-dimensional Gaussian proﬁles multiplied by\npolynomials, and they have a number of useful properties. For\nexample, they constitute a complete basis set, so in theory any\nimage can be decomposed into a shapelet vector; however,\nproﬁles that are not well matched to the size of the Gaussian\nwill require very high order shapelet terms, such that the\ndecomposition is unfeasible in practice (e.g. Melchior et al.,\n2010).\nFor images that are relatively well approximated by a Gaus-\nsian, they provide a compact representation of the object, since\nmost of the information in the image is described by low order\ncorrections to the Gaussian, which is what the shapelet decom-\nposition provides.\nThe Shapeletclass in GAL SIM follows the notation\nof Bernstein & Jarvis (2002), although it is also similar to\nwhat has been called “polar shapelets” by Massey & Refregier\n(2005). The shapelet expansion is indexed by two numbers,p\nand q19:\nI(r,θ)=\n∑\np,q≥0\nbpqψσ\npq(r,θ) (17)\n19 The shapelet functions happen to be eigenfunctions of the 2Dquantum\nharmonic oscillator. In that framework,p and q count the number of quanta\nwith positive and negative angular momentum, respectively. N = p + q is the\ntotal energy andm = p −q is the net angular momentum.\n6\nψσ\npq(r,θ)= (−1)q\n√πσ2\n√\nq!\np!\n( r\nσ\n) m\neim θe−r2/2σ2\n×L(m )\nq (r2/σ2) ( p ≥ q) (18)\nψσ\nqp(r,θ)=\nψσpq(r,θ) (19)\nm ≡ p −q. (20)\nL(m )\nq (x) are the Laguerre polynomials, which satisfy the recur-\nrence relation:\nL(m )\n0 (x)= 1 (21)\nL(m )\n1 (x)= (m +1)− x (22)\n(q +1)L(m )\nq+1(x)= [(2q +m +1)− x]L(m )\nq (x)\n−(q +m )L(m )\nq−1(x). (23)\nThe functions may also be indexed byN = p + q and m =\np − q, which is sometimes more convenient. Both indexing\nconventions are implemented in GAL SIM .\nOne of the handy features of shapelets is that their Fourier\ntransforms are also shapelets:\n˜ψσ\npq(k,φ)= (−i)m\n√π\n√\nq!\np!(kσ)m eim φe−k2σ2/2\n×L(m )\nq (k2σ2) ( p ≥ q). (24)\nThis means convolving shapelets in Fourier space is very efﬁ-\ncient.\n3.3.3. Interpolated images\nIn some cases, it is useful to be able to take a given image\nand treat it as a surface brightness proﬁle. This requires deﬁning\nhow to interpolate between the pixel values at which the surface\nbrightness is sampled.\nOne application for this is the use of direct observations of\nindividual galaxies (e.g., fromHST ) as the models for further\nsimulations, already mentioned in §3.1.4. See §6.5 for more\nabout this possibility.\nAnother application was also mentioned above in §3.2.2. The\ngeneral aberrated optical PSF is too complicated to model ana-\nlytically, so theOpticalPSFclass is internally evaluated by\ninterpolation over a ﬁnite grid of samples of the surface bright-\nness proﬁle.\nThe InterpolatedImageclass converts an arbitraryn×n\nimage array with elementsIi jon pixels of sizes into a continu-\nous surface brightness distribution\nI(x,y)=\n∑\ni,j\nIi jκ(x/s−i,y/s−j), (25)\nwhere κ is a real-space kernel chosen from those listed in Ta-\nble 1. Each interpolant usesK ×K input pixel values around the\ngiven (x,y) to render a sample at that location. Rendering an\nM × M output image hence requiresK 2 M 2 operations, and the\nfootprint of theInterpolatedImageis extended byKs /2\nbeyond the original input image.\nThe delta-function kernel yields inﬁnite (or zero) values in\ndirect rendering and is hence a highly ill-advised choice for\nan InterpolatedImagethat is to be rendered without fur-\nther convolutions. The sinc kernel has inﬁnite extent and hence\nuses allN ×N input samples to reconstruct each output sample,\nleading toN 2 M 2 operations in a direct-space rendering. In a\nhigh-volume simulation this will also be ill-advised. Approxi-\nmations to the sinc kernel that provide ﬁnite support are often\nfound to give a good compromise. Examples include the kernel\nthat represents cubic and quintic (i.e. 3rd and 5th order) poly-\nnomial interpolation, and the Lanczos kernel (see Table 1, also\nBernstein & Gruen, 2014). As will be demonstrated in §9.2\nand §9.3, these higher-order interpolation kernels meet strin-\ngent performance requirements for the representation of galaxy\nimages.\n3.4. Transformations\nMany of the proﬁles we have described so far are circularly\nsymmetric and centred on the coordinate origin. GAL SIM can,\nhowever, use these proﬁles to represent (for example) ellipti-\ncal, off-centred surface brightness proﬁles. Various transforma-\ntions can be applied to a GAL SIM object representing a surface\nbrightness distributionI(x), to return a new object representing\nI′(x).\nThe overall amplitude of the proﬁle can be rescaled by some\nfactor simply by using the*operator. It is also possible to get\na rescaled proﬁle with a speciﬁed value for the new total ﬂux.\nEither way, the new proﬁle isI′(x)= cI(x) for some constantc.\nAny one-to-one transformationT of the plane deﬁnes an im-\nage transformation via\nI′(x)= I\n[\nT −1(x)\n]\n. (26)\nThe G AL SIM operationtransformimplements local linear\ntransformations deﬁned by a transformation matrixA as\nT (x)= Ax . (27)\nThis can account for any arbitrary distortion, rotation, parity ﬂip\nor expansion of the coordinate system. The user can specifyA\ndirectly; alternatively the GAL SIM operationsrotate, ex-\npand, magnify, shear,and lensimplement restricted\nversions of the transformation that are often convenient inprac-\ntice.\nThere is also a command calleddilatethat combines an\nexpansion of the linear size (i.e.A being a multiple of the iden-\ntity matrix) with an amplitude scale factor to keep the overall\nﬂux of the resulting proﬁle unchanged. This is merely a con-\nvenience function, but it is handy, since this operation is fairly\ncommon.\nFinally, theshiftfunction can translate the entire proﬁle\nby some amountx0. This corresponds to the transformation\nT (x)= x +x0. (28)\nTogether,shiftand transformenable any arbitrary afﬁne\ntransformation.\n7\nTable 1: Properties of interpolants\nName Formula Notes a No. of pointsK\nDelta δ(x) Cannot be rendered in x domain; extreme aliasing∝ 1. 0,1\nNearest 1, |x| <1/2 Aliasing ∝ k−1 1\nLinear 1 −| x|, |x| <1 Aliasing ∝ k−2 2\nCubic piecewise cubicb Common choice forK 4\nQuintic piecewise quinticb Optimized choice forK k (cf. §6.2.4) 6\nLanczos sincx sinc(x/n), |x| <n Common choice forK withn = 3–5 2n\nSincInterpolantsincx Perfect band-limited interpolation; slowest ∞\naCoordinate distance from the origin in Fourier space is denotedk.\nbFormulae forCubicand Quinticinterpolants are given in the Appendix to Bernstein & Gruen (2014).\nAll of these operations are implemented in GAL SIM via a\nwrapper object that exists independently of, and interfaces with,\nthe original proﬁle. This means the code for implementing\nthese transformations (e.g. the effect in Fourier space, orthe de-\nﬂections to apply for photon shooting, see §6.3) exists in a sin-\ngle place, which helps minimize unnecessary duplication and\nensure the reliability of the transformation routines.\nFor reasons discussed in §6, GAL SIM does not currently han-\ndle non-afﬁne transformations acting on a single proﬁle (asre-\nquired by simulations of ﬂexion such as Velander et al., 2011;\nRowe et al., 2013), but see §5 for how to handle such coordi-\nnate transformation across a full image, using the appropriate\nlocally linear approximation at the location of each object.\n3.5. Compositions\nTwo or more individual surface brightness proﬁles may be\nadded together using the+operator to obtain a proﬁle with\nI′(x)= I1(x)+I2(x)+... .\nThe convolution of two or more objectsI1,I2 is deﬁned as\nusual via\nI′(x)= (I1 ◦I2)(x)=\n∫\nI1(x′)I2(x −x′) d2x′. (29)\nThis is implemented in GAL SIM with theConvolvefunction,\nwhich takes a list of two or more objects to be convolved to-\ngether.\nThere are also two special functions that can afford some\nmodest efﬁciency gains if they apply.AutoConvolveper-\nforms a convolution of an object with itself, i.e. withI2(x) =\nI1(x) in equation (29).AutoCorrelateperforms a con-\nvolution of an object with a 180◦ rotation of itself, i.e. with\nI2(x)= I1(−x).\nFinally, GAL SIM can implement a deconvolution as well.\nThis lets users solve for the solutionI′ to the equationI1 =\nI′ ◦I2, which in Fourier space is simply\n˜I′(k)= ˜I1(k)/˜I2(k) (30)\nThe functionDeconvolveimplements the inverse of a proﬁle\n(e.g.I2 above) in Fourier space, which is a deconvolution in\nreal space. The returned object is not something that can be\nrendered directly. It must be convolved by some other proﬁleto\nproduce something renderable (I1 in this example).\nOne common use case for this is to deconvolve an observed\nimage (represented by anInterpolatedImageobject) by\nits original PSF and pixel response, producing an object that\nwould then be reconvolved by some other PSF corresponding to\na different telescope and rendered on an image with a new pixel\nscale. This is the functionality at the heart of GAL SIM ’s imple-\nmentation of the reconvolution algorithm described in §6.5and\nused by theRealGalaxyclass (§3.1.4). As will be discussed\nin §6.5, the latter PSF must be band-limited at a lower spatial\nfrequency than the original (deconvolved) PSF to avoid serious\nartifacts in the ﬁnal image.\n3.6. Chromatic objects\nReal astronomical stars and galaxies have wavelength-\ndependent intensity distributions. To model this, it is possible in\nG AL SIM to deﬁne objects whose surface brightness is a func-\ntion not only of position, but also of wavelength. These objects\ncan then be rendered as seen through a particular bandpass (the\nthroughput as a function of wavelength).\nThe simplest of the wavelength-dependent classes is the\nChromaticclass, which is constructed from an achromatic\nproﬁle (i.e. any of the proﬁles described above) and a Spec-\ntral Energy Distribution (SED). The SED deﬁnes a wavelength-\ndependent ﬂux for the object.\nChromatic objects can be transformed, added, and convolved\nusing precisely the same syntax as for achromatic objects. The\naddition of multiple chromatic objects provides a simple way to\ncreating galaxies with non-trivial wavelength-dependentmor-\nphologies. A bulge and a disk can have different SEDs; star\nforming regions or HII regions can also be added in with their\nown SEDs.\nIn addition, the various transformations can take functions of\nwavelength for their arguments. For example, differentialchro-\nmatic refraction is implemented by a wavelength-dependent\nshift, and the effects of chromatic variation in Kolmogorov\nturbulence can be approximately modelled with a wavelength-\ndependent dilation. GAL SIM provides the helper function\nChromaticAtmosphere, which encapsulates both of these\neffects for an atmospheric PSF.\nA more detailed discussion of this recent addition to\nthe G AL SIM toolkit is reserved for future work, but it\nprovides a valuable resource for simulating a number of\nimportant wavelength-dependent effects in cosmology (e.g.\n8\nCypriano et al., 2010; V oigt et al., 2012; Plazas & Bernstein,\n2012; Semboloni et al., 2013; Meyers & Burchat, 2014).\n4. Lensing shear and magniﬁcation\nA primary purpose of GAL SIM is to make simulated images\nthat can be used to test weak gravitational lensing data analy-\nsis algorithms, which means that a framework for simulating\nlensing shear and convergence (see, e.g., Schneider, 2006,for\na review) is critical. In the weak gravitational lensing limit, the\ntransformation between unlensed coordinates (xu,yu; with the\norigin taken to be at the center of a distant galaxy light source)\nand the lensed coordinates in which we observe galaxies (xl,yl;\nwith the origin at the center of the observed image) is linear:\n( xu\nyu\n)\n=\n( 1 −γ1 −κ −γ2\n−γ2 1 +γ1 −κ\n)( xl\nyl\n)\n. (31)\nHere we have introduced the two components of lensing shear\nγ1 and γ2, and the lensing convergenceκ. The shear describes\nthe anisotropic stretching of galaxy images in weak lensing.\nThe convergenceκ describes an isotropic change in apparent\nobject size: areas of the sky for whichκ is non-zero have ap-\nparent changes in area (at ﬁxed surface brightness). Lensing\nmagniﬁcation is produced from a combination of the shear and\nconvergence.\nIt is worth noting that even whenκ = 0 the transformation\nmatrix in equation (31) will not have a unit determinant in gen-\neral. Object area (and thus ﬂux when conserving surface bright-\nness) is therefore not conserved by weak lensing shear, an effect\nwhich is not always desired when simulating images. For con-\nvenience, GAL SIM implements a unit determinant shear trans-\nformation that conserves object area, while also implement-\ning the non-area conserving shear deﬁned by the weak lensing\ntransformation of equation (31).\nIn the simplest use case, GAL SIM will take single values for\nthe lensing shear and convergence and apply them to objects.In\naddition, however, GAL SIM is able to generate ﬁelds of coher-\nent shear and convergence values corresponding to two physical\nscenarios described below: cosmological weak lensing ﬁelds\nwith some power spectrum, and the weak lensing that arises\nfrom a spherical NFW halo (Navarro, Frenk, & White, 1996).\n4.1. Cosmological lensing ﬁelds\nG AL SIM provides routines to simulate a Gaussian random\nﬁeld approximation to a cosmological lensing signal, charac-\nterized wholly by its power spectrum. In reality, shear and con-\nvergence ﬁelds show signiﬁcant non-Gaussianity. The inten-\ntion, therefore, is not highly cosmologically accurate shear and\nconvergence ﬁelds, such as would be suitable for an end-to-end\ntest of cosmological parameter determination. The intention is\nrather to provide basic functionality for making semi-realistic,\nspatially varying lensing ﬁelds so as to be able to test measure-\nment algorithms that ﬁnd such regimes challenging in general.\nThere is nothing to prevent any user from using outputs\nfrom a more realistic cosmological ray-tracing simulation(e.g.\nBecker, 2013) to create an observed galaxy shape catalog that\nincludes a realistic shear and convergence ﬁeld. If realismis\nrequired, this procedure should be followed.\n4.1.1. Basic capabilities\nAny shear ﬁeld can be projected into orthogonalE - andB-\nmode components, named for their similarity to the electromag-\nnetic vector ﬁelds with zero curl and zero divergence, respec-\ntively (see, e.g. Schneider, 2006; Mandelbaum et al., 2014).\nG AL SIM is capable of taking inputE - andB-mode shear power\nspectra as user supplied functions, and generating random re-\nalizations of shear and convergence ﬁelds drawn from those\npower spectra. The basic functionality is carried out by the\nPowerSpectrumclass. Shears are generated on a grid of\npositions, but GAL SIM can interpolate to arbitrary positions\nwithin the bounds of the grid using the interpolants discussed\nin §6.2.\nObservable quantities such as the shear correlation functions\nare deﬁned using the vectors connecting pairs of galaxies atsep-\narationθ,\nξ±(θ)= ξ++(θ)±ξ××(θ) (32)\n=\n∫∞\n0\n1\n2π[P E (k)±P B (k)]J0/4(kθ)k dk (33)\nwhere J0/4 denotes the 0th and 4th Bessel function of the\nﬁrst kind, as is appropriate forξ+ and ξ−, respectively. See\nSchneider et al. (2002) for more details about relating the cor-\nrelation functions to theE - andB-modes of the ﬂat-sky power\nspectra20.\nFor cosmological shear correlationsP B ≃ 0 to a very good\napproximation, although higher order effects (e.g. sourcered-\nshift clustering) can introduce physical B-modes (see, e.g.,\nSchneider, 2006). It is useful to includeP B when generating\nshears for other purposes, such as when drawing atmospheric\nPSF anisotropies according to some power spectrum (which\ntypically requires similar amounts ofE and B power). Here\nP E (k) andP B (k) have dimensions of angle2; GAL SIM can ac-\ncept the power spectra in various formats and sets of units.\nThese deﬁnitions of observables rely on continuous Fourier\ntransforms, but in practice we implement the calculations us-\ning discrete Fourier Transforms (DFT), and we must be care-\nful about the DFT conventions. We assume we have a grid\nwith lengthL along one dimension and spacingd between grid\npoints. Given a Fourier-space grid of size consistent with that\nof the input real-space grid, the minimum and maximum one-\ndimensional wavenumbers|k| on the grid arekmin = 2π/L and\nkmax = π/d. The lensing engine ﬁnds the powerP(k) according\nto the value ofk =\n√\nk2\n1 +k2\n2 on the grid, draws random ampli-\ntudes from a Rayleigh distribution based on√P(k) and random\nphases from a uniform distribution, and transforms back to our\nreal-space grid to get the real-space shear ﬁeld, with periodic\nboundary conditions. The standard deﬁnition of the correlation\nfunction (Eq. 33) uses the angular frequency, non-unitary deﬁ-\nnition of the 1D Fourier transform:\n˜f(k)=\n∫∞\n−∞\nf(x)e−ikx dx ≡ F{ f(x)}; (34)\n20Many standard references regarding lensing power spectra work in terms\nof the spherical harmonicsℓ, with the power spectrum denotedC ℓ. In the ﬂat-\nsky limit we can simply swapℓwith wavenumberk and C ℓ withP(k).\n9\nf(x)= 1\n2π\n∫∞\n−∞\n˜f(k)eikx dk ≡ F −1{˜\nf(k)}. (35)\nIf we trace through the impact of this convention on the discrete,\nﬁnitely-sampled power spectrum, then our use of the NUM PY 21\npackage for Fourier transforms (with the more common unitary\ndeﬁnition of the DFT) necessitates various normalization fac-\ntors related to the input grid conﬁguration. For further details,\nsee Appendix A.\n4.1.2. Implementation details\nAny DFT-based algorithm to generate shears according to\na power spectrum is subject to limitations due to the implicit\nchoice of a ﬁnite range in wavenumber and the difference be-\ntween a discrete and continuous Fourier transform. GAL SIM\nincludes options to ameliorate these limitations:\n• G AL SIM can optionally decrease (increase) the minimum\n(maximum) value ofk by internally expanding (contract-\ning) the real-space grid before generating shears. This\nhelps avoid problems with missing shear power on vari-\nous scales; in the case of cosmological power spectra it is\nparticularly recommended for those who wish to properly\nreproduce the large-scale shear correlation function (on\nscales comparable to∼ 1/4 the total grid extent). There\nis an important tradeoff implicit in the use of these op-\ntions: the power spectra that result from using internally\nenlarged grids is not strictly the same as the input one, and\nthere can beE and B mode leakage as a result of using\nthese options.\n• G AL SIM has a utility to predict the shear correlation func-\ntion resulting from the use of a limitedk range when gen-\nerating shears. While the output is not exactly what will be\ngenerated in reality since the algorithm does not account\nfor the use of a DFT, it permits users to assess in advance\nwhether their grid choices permit them to roughly repro-\nduce shear correlations on the scales they want.\n• A natural consequence of the limitedk range is that alias-\ning can occur if users supply a power spectrum with power\nbelow the grid Nyquist scale. GAL SIM shear generation\nroutines can optionally band-limit the input power spec-\ntrum by applying a hard or soft cutoff at the Nyquist scale\nto avoid aliasing.\n4.1.3. Interpolation to non-gridded positions\nAfter building a grid of shears and convergences, users can\ninterpolate them to arbitrary positions within the grid. However,\nwhen using this functionality, some care must be employed to\nprevent the interpolation procedure from spuriously modifying\nthe shear power spectrum or correlation function at scales of\ninterest.\nThe key effect of interpolation is to multiply the shear power\nspectrum by a quantity proportional to the square of the Fourier\n21http://www.numpy.org/\ntransform of the interpolant. As a result, we found that all inter-\npolants modify the shear 2-point functions in a signiﬁcant way\n(>10% but sometimes much more) for scales below 3 times the\noriginal grid spacing. Thus, when interpolating shears to ran-\ndom points, the grid spacing should be chosen with care, keep-\ning in mind the minimum scale above which the shear two-point\nfunctions should be preserved. Edge effects can also be impor-\ntant depending on the intended use for the resulting interpolated\nshears and the choice of interpolant (see Table 1; §3.3.3).\n4.2. Lensing by individual dark matter halos\nThe NFWHaloclass can produce shears and convergences\ncorresponding to a dark matter halo following a spherical NFW\n(Navarro et al., 1996) proﬁle, using analytic formulae from\nBartelmann (1996) and Wright & Brainerd (2000). The formu-\nlae depend on the cosmology being assumed, which in GAL SIM\nis allowed to be an arbitraryΛCDM cosmology. It would not\nbe difﬁcult to extend this to more sophisticated cosmological\nmodels.\nThe NFW lensing halo is deﬁned in terms of its mass, con-\ncentration, redshift, and position in the image. Then for any\ngiven position and redshift of the source galaxy to be lensed, the\nappropriate lensing quantities can be computed analytically. It\nis, however, important to note that the implementation in GAL -\nSIM adopts the coordinate frame of the observed galaxies, i.e.\nno deﬂection angles are calculated or applied to galaxy posi-\ntions. As a consequence the density of galaxies behind NFW\nhalos is not altered as would happen in nature. If needed, e.g.\nfor studies of magniﬁcation from galaxy clusters, this effect\nshould be taken into account.\n5. World coordinate systems\nThe galaxy models described above are generally deﬁned in\nterms of angular units on the sky. For example, a Sérsic proﬁle\nmight be constructed to have a half-light radius of 1.6 arcsec.\nBefore rendering this object onto an image, one must specify\nhow the image pixel coordinates relate to sky coordinates (also\nknown as world coordinates).\nThe simplest such relationship is to assign a pixel scale to the\nimage, typically in units of arcsec/pixel. However, this isnot\nthe only possible such relationship; in general, the “worldcoor-\ndinates” on the sky can be rather complicated functions of the\nimage coordinates. GAL SIM allows for a variety of “world co-\nordinate systems” (WCS) ranging from a simple pixel scale to\nthe kinds of WCS functions typically found in the FITS (Flex-\nible Image Transport System, see e.g. Pence et al., 2010) head-\ners of real data images.\n5.1. Types of WCS functions\nThe WCS classes used by GAL SIM can be broken into two\nbasic types: celestial and euclidean coordinate systems.\nCelestial coordinate systems are deﬁned in terms of right as-\ncension (RA) and declination (Dec). In GAL SIM this kind of\nWCS is represented by subclasses ofCelestialWCS. This\n10\nincludesRaDecFunction, which can represent any arbi-\ntrary function the user supplies for RA(x,y) and Dec(x,y), and\nFitsWCS, which reads in the WCS information from a FITS\nheader.\nEuclidean coordinate systems are deﬁned relative to a tangent\nplane projection of the sky. Taking the sky coordinates to be\non an actual sphere with a particular radius, the tangent plane\nwould be tangent to that sphere. We use the labels (u,v) for the\ncoordinates in this system, where+v points north and+u points\nwest22.\nIn GAL SIM this kind of WCS is represented by subclasses of\nEuclideanWCS. The most general isUVFunction, which\ncan represent any arbitrary function the user supplies foru(x,y)\nand v(x,y).AffineTransformis the most generaluniform\ncoordinate transformation where all pixels have the same size\nand shape, but that shape is an arbitrary parallelogram.\nOther classes representing restricted specializations of\nAffineTransformare available. The simplest one,Pix-\nelScale, describes uniform square pixels. To date, this\nis what has been used in simulations testing shear mea-\nsurement methods, including the most recent GREAT3 chal-\nlenge (Mandelbaum et al., 2014), as well as all previous shear\ntesting projects (Heymans et al., 2006; Massey et al., 2007;\nBridle et al., 2010; Kitching et al., 2012, 2013). GAL SIM there-\nfore makes it easy to ignore all of the WCS options and just use\na pixel scale instead. Any function that can take a WCS param-\neter, can also take a pixel scale parameter, which is interpreted\nas aPixelScaleWCS.\n5.2. Converting proﬁles\nIt is relatively straightforward to convert a surface brightness\nproﬁle from the sky coordinates in which it is deﬁned to image\ncoordinates. We only need to assume that the ﬁrst derivatives\nof the WCS functions are approximately constant over the size\nof the object being modelled, which is generally a safe assump-\ntion. That is, we use the local linear approximation of the WCS\ntransformation at the location of the object. Currently, GAL SIM\ncannot accurately handle transformations that vary signiﬁcantly\nover the size of the proﬁle being rendered; in fact this opera-\ntion would be very similar to what is required for implementing\nﬂexion, and would most simply be incorporated in the context\nof photon shooting (see §6.3).\nThe ﬁrst step if we are dealing with a celestial coordinate\nsystem is to do a local tangent projection at the position of the\nobject. Speciﬁcally, we use the TAN projection described by\nCalabretta & Greisen (2002), but it is likely that any of the tan-\ngent plane projections discussed in that work would providean\nequivalent conversion to a local Euclidean coordinate system.\nThe next step is to calculate the Jacobian of the WCS at the\nlocation of the object:\nJ =\n( du/dx du/dy\ndv/dx dv/dy\n)\n(36)\n22This can be counterintuitive to some, but it matches the viewfrom Earth.\nWhen looking up into the sky, if north is up, then west is to theright.\nThis Jacobian deﬁnes the local afﬁne approximation of the\nWCS at the location of the object, which we assume we can\ntake as uniform over the extent of the proﬁle we need to con-\nvert.\nApplying a general Jacobian transformation in GAL SIM was\ndescribed above in §3.4. Here, we are transforming from (u,v)\nto (x,y), which means the transformation to be applied is really\nJ−1. To preserve the total ﬂux of the proﬁle, we also need to\nmultiply the resulting proﬁle by|detJ|.\nThe G AL SIM WCS classes have functionstoImageand\ntoWorldthat effect the conversion in either direction, using\nwhatever subset of the above steps are required for the given\nWCS. If the WCS transformation is not uniform (so it matters\nwhere the object is in the image), then the position of the object\n(in either coordinate system) must be speciﬁed.\n5.3. Integrating over pixels\nWhile the galaxy proﬁles are naturally deﬁned in world co-\nordinates, the pixel response is most naturally deﬁned in image\ncoordinates, where it can typically be modelled as a unit square\ntop hat proﬁle. The PSF proﬁle may be more naturally consid-\nered in either coordinate system depending on where the model\nis coming from. Thus, careful attention is required to handle all\nof these correctly when using a complicated WCS.\nWe start by ignoring the PSF to show how to properly han-\ndle a galaxy drawn onto uniform square pixels of dimension\ns in an image (corresponding to aPixelScaleWCS). Let\nthe galaxy surface brightness be given in world coordinatesas\nIw (u,v). According to the methods in the previous section, the\ncorresponding proﬁle in image coordinates would be\nIi(x,y)= s2Iw (xs,ys) (37)\nwhere s2 is the|detJ| factor mentioned above, which ensures\nthat the integral of each version of the proﬁle gives the same\ntotal ﬂux.\nThe pixel response in the two coordinate systems is given by\na 2-dimensional top hat function with unit ﬂux:\nPw (u,v)= T s(u,v)≡\n\uf8f1\n\uf8f4\n\uf8f4\n\uf8f2\n\uf8f4\n\uf8f4\n\uf8f3\n1\ns2 |u|<s/2,|v|<s/2\n0 otherwise (38)\nPi(x,y)= T1(x,y) (39)\nin world and image coordinates respectively, where in the latter\nthe pixel size is, by deﬁnition, equal to 1.\nWhen observed on an image, the galaxy’s surface brightness\nproﬁle is integrated over the area of the pixel. In a particular\npixel (i, j), the integrated ﬂuxIi jis\nIi j=\n∫is+s/2\nis−s/2\n∫ js+s/2\njs−s/2\nIw (u,v) du dv (40)\n=\n∫+∞\n−∞\n∫+∞\n−∞\ns2Iw (u,v)Pw (is−u, js−v) du dv (41)\n= s2(Iw ◦Pw )(is, js) (42)\n=\n∫+∞\n−∞\n∫+∞\n−∞\nIi(x,y)Pi(i−x, j−y) dxdy (43)\n11\n= (Ii ◦Pi)(i, j) (44)\nWe thus ﬁnd thatIi jis the convolution of the galaxy proﬁle with\nthe pixel response evaluated at the centre of the pixel, and then\nmultiplied by the pixel area. Furthermore, this calculation can\nbe done in either coordinate system. This well-known result\n(e.g. Lauer, 1999) is the basis of how GAL SIM implements the\nintegration of a surface brightness proﬁle over the pixel area.\nFor more complicated WCS functions, we can still apply the\nsame procedure. We either convert the galaxy proﬁle to image\ncoordinates and convolve by a unit square pixel, or convert the\nunit square pixel to world coordinates and do the convolution\nthere. In GAL SIM thedrawImagemethod that performs the\nrendering has access to the WCS of the image, and this convolu-\ntion is handled automatically. The pattern adopted in the code is\nto transform the galaxy proﬁle into image coordinates and then\nconvolve by a unit square pixel, but the converse would have\nbeen equally valid.\nFor the PSF, when using a non-trivial WCS, some care is re-\nquired regarding the coordinate system in which the PSF proﬁle\nis deﬁned. The processes that cause the image coordinates to\nbecome distorted from a square pixel are related to the causes\nof the PSF, namely the atmosphere and the optics of the tele-\nscope. Therefore, when choosing to apply a distorted WCS,\ncare is needed about whether the PSF is deﬁned in world or im-\nage coordinates. If it is deﬁned in image coordinates, then it\nshould be converted to world coordinates (as described in §5.2)\nprior to convolution by the galaxy proﬁle.\nFinally, if a PSF is measured from an image, such as a real\ndata image of a star, then it already includes a convolution by\na pixel response23. To apply this consistently to simulated data\nusing the same WCS and pixel scale, an additional convolution\nby a pixel should not be applied, since that would effectively\nconvolve by the pixel response twice. This kind of rendering\nwithout the extra pixel convolution is possible in GAL SIM using\ntheno_pixeloption ofdrawImage.\n6. Image rendering\nA given object can be rendered onto an image (“drawn”)\nthrough three methods in GAL SIM : direct drawing in real\nspace; drawing via discrete Fourier transform (DFT); or draw-\ning via “photon shooting,” whereby the surface brightness pro-\nﬁle is treated as a probability distribution, and a ﬁnite number\nof “photons” sampled from this distribution are “shot” ontothe\nimage.\nIn principle all three rendering methods should be equivalent,\napart from the shot noise that is inherent to the photon-shooting\nmethod. However, there is one additional difference that is\nworth noting. The photon-shooting method bins the photons\naccording to the pixels they fall into and hence automatically\n23 It is possible to remove the pixel response from the PSF imagewith the\nDeconvolveoperator in GAL SIM which deconvolves by the original pixel.\nThis will only be numerically viable if the resulting objectis drawn onto an\nimage with pixels that are either the same size or (preferably) larger.\nintegrates the proﬁle over the pixels. Thus, theno_pixelop-\ntion ofdrawImagementioned above in §5.3 will always use\neither direct rendering or DFT as appropriate.\nThere are in practice also further minor differences between\nthe rendered output of the different methods that are due to ap-\nproximations inherent to each technique. These we highlight\nbelow.\nNot all objects can be rendered with all three methods. In par-\nticular, convolution in real space is only implemented for con-\nvolution of two proﬁles, one of which is typically the pixel re-\nsponse (cf. §6.1.5). Deconvolution (see §3.5; §6.5) is onlypos-\nsible with the DFT method. Non-afﬁne transformations such\nas ﬂexion (Goldberg & Bacon, 2005; Irwin & Shmakova, 2005;\nBacon et al., 2006) cannot be done in Fourier space; ﬂexion is\nnot currently implemented in GAL SIM for this reason. Table 2\nsummarizes the advantages and disadvantages of each render-\ning method.\n6.1. Direct rendering\nThe default way to draw an object in GAL SIM is to integrate\nits surface brightness over the pixel response by convolving the\nobject’s proﬁle with a square pixel (cf. §5.3). This means the\nobject that is actually being drawn will really be a convolution,\nwhich is normally rendered using the DFT method (§6.2).\nHowever, it is possible to tell GAL SIM not to convolve by\nthe pixel and instead draw the proﬁle directly by sampling the\nsurface brightness at the centre of each pixel. This is the easiest\nrendering method to understand, so we describe it ﬁrst. But\nof course, it does not directly correspond to a real image, so\nthe sum of the pixel values may not match the input ﬂux, for\ninstance.\n6.1.1. Analytic objects\nIf an analytic surface brightness proﬁle is drawn without con-\nvolving by the pixel response, GAL SIM will use direct render-\ning, which just involves calculatingI(x,y) at the location of\neach output pixel. The formulae forI(x,y) for our various an-\nalytic objects were given in §3, and they are summarized in\nTable 3.\nMany objects have an analytic formula in real space, so\nthe direct rendering is straightforward. However, theKol-\nmogorovproﬁle is only analytic in Fourier space, so the im-\nplementation ofI(r) in real space uses a cubic spline lookup\ntable for the Hankel transform of˜I(k). This calculation is done\nthe ﬁrst time aKolmogorovobject is instantiated and saved\nfor any further instantiations, so the setup cost is only required\nonce.\nFor the radially symmetric proﬁles, we can take advantage\nof the known symmetry to speed up the calculation. There are\nalso usually vectorization techniques that lead to furtherim-\nprovements in efﬁciency.\n6.1.2. Shapelet proﬁles\nThe shapelet functions are not radially symmetric, but the\ncode to directly renderShapeletobjects uses fast recurrence\nrelations for the shapelet functions given in Bernstein & Jarvis\n12\nTable 2: Characteristics of different rendering methods\nCharacteristic Direct real-space Fourier Photon shooting\nOperations for setupa 0 O (N 2 logN ) O (N 2 logN )\nOperations for renderinga O (N 2) O (N 2 logN ) O (N γ logN )\nOperations for additiona O (N 2) O (N 2) O (N γ)\nOperations for convolutiona O (N 4)b O (N 2) O (N γ)\nOperations for deconvolutiona impossible O (N 2) impossible\nEasy to apply afﬁne transformations? yes yes yes\nEasy to apply non-afﬁne transformations? yes no yes\nInaccuracies - band-limiting, folding shot noise, truncation\nFastest for analytic objects high S/N low S/N\naFor operation counts,N is the typical linear size of an input or output image, andN γ is the number of photons traced during photon shooting.\nbDirect rendering can only handle convolution of two proﬁles.\nTable 3: Analytic GAL SIM objects\nClass name Real-space formula a Fourier-space formulaa Photon-shooting methodb\nExponential e−r/rs\n(\n1 +k2r2\ns\n) −3/2\nInterval\nDeVaucouleurse−7.669(r/re)1/4\nLUT Interval\nSersic e−b(n)(r/re)1/n\nLUT Interval\nAiry\n[ J1(ν)−ǫJ1(ǫν)\nν\n] 2\n, ν = πrD /λ Analyticc Interval\nMoffat\n(\n1 + r2\nr2\n0\n) −β\nLUT d Analytic\nKolmogorov LUT e−(k/k0)5/3\nInterval\nGaussian e−r2/2σ2\ne−k2σ2/2 Analytic\nShapelet See §3.3.2 See §3.3.2 Not implemented\nPixel 1,|x| < s/2,|y| < s/2 sinc( skx) sinc(sky) Analytic\naNormalization factors have been omitted from the given formulae for brevity; the integral of the real-space proﬁle and the k = 0 value in Fourier space should both\nequal the ﬂuxF of the object. “LUT” means that the function requires integrations that are precomputed and stored in a cubic-spline look-up table.\nbThe photon-shooting methods are the following: “Analytic”means that photon locations are derived from a remapping of one or more uniform deviates intox;\n“Interval” involves a combination of weighting and rejection sampling, as described in Section 6.3; “Not implemented”means that GAL SIM cannot currently\nrender this with photon shooting.\ncFourier representation of the Airy function with obscuration is analytic but too complex for the table.\ndFor genericβvalues, a lookup table is used. However, some particular values ofβhave analytic Fourier-space formulae, which GAL SIM uses in these cases.\n13\n(2002), which vectorize conveniently when applied to the pixels\nin the image. They are thus also relatively efﬁcient to draw.\n6.1.3. Interpolated images\nInterpolatedImageobjects are usually the slowest to\ndirectly render, since equation (25) involves a sum over a num-\nber of the original pixels for each output pixel value, the exact\nnumber depending on the interpolant being used (see Table 1).\n6.1.4. Transformations\nAll of the transformations described in §3.4 are very simple\nto apply when directly rendering. The value of the transformed\nproﬁle, including all three kinds of effects, is simply\nI′(x)= c I\n[\nA −1(x −x0)\n]\n. (45)\nwhere I(x) is the original proﬁle.\n6.1.5. Compositions\nDirectly rendering a sum of proﬁles is trivial, since each pro-\nﬁle can be rendered individually, adding the ﬂux to whatever\nhas already been rendered.\nThe rendering of a convolution is almost always done via\nDFT or photon-shooting methods. However, when convolving\ntwo objects that are both known to have high-frequency con-\ntent, such that an unaliased DFT is impractical, GAL SIM may\nelect to render it directly through a Gauss-Kronrod-Patterson\nevaluation of the convolution integral, equation (29).\nGenerally such circumstances do not represent any physi-\ncally realizable image, since real telescopes and detectors lead\nto band-limited images. However, in simulated images, it can\nhappen if two objects being convolved both have hard edges.\nHere, a “hard edge” means a place where the surface brightness\nabruptly drops from some ﬁnite value to zero. For example a\nPixelconvolved with a truncatedMoffatproﬁle would by\ndefault be convolved using direct integration. In this and simi-\nlar cases, the direct integration is generally both faster and more\naccurate.\n6.2. Discrete Fourier transform rendering\nWhen rendering images that include convolution by a pixel\nresponse (and often other proﬁles such as a PSF), GAL SIM uses\nDFTs by default.\n6.2.1. Band limiting and folding\nTo sample a surface brightness proﬁleI(x) onto anM × M\ngrid with sample pitch∆x via DFT, we will need to know its\nFourier transform˜I(k) at all points withkx,ky being multiples\nof∆k = 2π/(M ∆x). If any frequency modes are present in˜I(k)\nbeyond the Nyquist frequencyπ/∆x of the output grid these\nwill be aliased in the output image, as required for the correct\nrendering of undersampled data.\nThe input to the DFT will be theM × M Hermitian array of\nFourier coefﬁcients summed over all aliases:\n˜ai j=\n∑\np,q\n˜I[ (i+ pM )∆k,(j+qM )∆k)] ,\n− M /2 ≤ i, j< M /2. (46)\nThese sums must be truncated at some ﬁnite (p,q) range. We\nmust select a spatial frequencykmax such that we approximate\n˜I(kx,ky) = 0 for|kx| > kmax or |ky| > kmax . Any real telescope\nproduces bandlimited images, transmitting zero power beyond\na wave vector ofkmax = 2πD /λ, whereD is the maximum en-\ntrance aperture dimension andλis the wavelength of observa-\ntion. For space-based observations we are typically creating im-\nages sampled near the Nyquist scale ofλ/2D for this frequency,\nand we can run the sum (46) over all physically realizable fre-\nquencies without approximation.\nFor ground-based observations, the PSF is typically much\nlarger than the diffraction limit, and the pixel scale has Nyquist\nfrequency well below the physicalkmax . To render images\nwith acceptable speed it is often necessary to approximate the\nFourier transform˜I(k) as being identically zero beyond a cho-\nsen kmax . This is called band-limiting the image. Common\nidealizations of PSFs, such as the Gaussian, Moffat, and Kol-\nmogorov functions, are unbounded ink, and therefore we must\nselect akmax which yields an acceptable approximation.\nEvery kind of surface brightness proﬁle in GAL SIM is able\nto calculate and return itskmax , which we take to be the value\nofk where the Fourier-domain proﬁle drops below a threshold\nof 10−3 of the peak. See §6.4 for more detail about the param-\neter (maxk_threshold) that controls this value. For some\nproﬁleskmax can be calculated analytically; where this is not\npossiblekmax is determined numerically using an appropriate\nmethod for each proﬁle.\nAnother characteristic of the DFT is that each output value\nIi j= I(i∆x, j∆x) is actually the true function folded at the pe-\nriodP = M ∆x = 2π/∆k:\nIi j=\n∑\np,q\nI(i∆x + pP, j∆x +qP ). (47)\nSince it is impossible forI(x) to be compact after being band-\nlimited, this leads to some degree of inaccuracy due to folding\nof the image. We can limit the aliasing errors by ensuring that\nevery DFT is done with a sufﬁciently large period. Every sur-\nface brightness proﬁle in GAL SIM also knows whatkstepvalue\nshould be used for the DFT (cf.folding_thresholdin\n§6.4). The DFT is executed with periodP ≥ 2π/kstep, implying\n∆k ≤ kstepand M ≥ 1/kstep∆x.\nIf the user has requested rendering of an image that does not\nmeet this criterion, GAL SIM will execute the DFT on a grid of\nlargerM that does, and then extract the output image from the\nresult of this larger DFT. If the user does not specify an image\nsize, GAL SIM will select a value that satisﬁes this bound.\nThe DFT image must have dimensionM ≥ 2kmax /kstep. Some\nof the GAL SIM proﬁles contain sharp features that cause this\nminimum M to exceed the maximum allowed DFT size, in par-\nticular thePixelclass and theSersicclass with higher in-\ndices, including theDeVaucouleursclass. GAL SIM will\nraise an error if one attempts to render such an object via DFT\nwithout ﬁrst convolving by another object that attenuates the\nhigh-frequency information. This should not be an issue for\nrendering of realistic images, in which convolution with the\n14\nPSF and pixel response will typically limit the bandwidth of\nthe image to a manageable value.\n6.2.2. Analytic objects\nTable 3 lists the proﬁles for which GAL SIM calculates\nFourier-domain values analytically.\nFor those radial proﬁles without fast analytic formulae in\nFourier domain, we tabulate numerical transforms into a lookup\ntable and use cubic spline interpolation to return˜I(k). The ini-\ntial setup of these tables can take some time, but they are cached\nso that later Fourier-domain evaluations of the same type ofpro-\nﬁle are accomplished in constant time.\nAt small values ofk = |k| we generally replace the spline\ninterpolation with an analytic quadratic (or higher) orderTay-\nlor expansion of˜I(k), because the behaviour of˜I(k) near the\norigin has a strong effect on the appearance of poorly-resolved\nobjects. In particular the second derivative of˜I(k) determines\nthe second central moments that are critical for measurement\nof weak gravitational lensing, and the spline interpolation can\nproduce incorrect derivatives at the origin.\n6.2.3. Shapelet proﬁles\nSince shapelets are their own Fourier transforms (cf. equa-\ntion (24)), the code to draw aShapeletobject in Fourier\nspace is essentially identical to the code to directly render it. It\nuses fast recurrence relations, which are efﬁcient when applied\nto the pixels in the Fourier image.\n6.2.4. Interpolated images\nGiven anN ×N array of samples at pitch∆x, we can perform\na DFT to yield samples of the Fourier transform at a grid of val-\nues ki j= (i/N ∆x, j/N ∆x). To render this function back onto a\ndifferentx-domain grid, or to execute transformations, we need\nto evaluate˜I(k) at arbitraryk between the grid of DFT values.\nThis requires somek-space interpolation scheme.\nFurthermore we need to account for the facts that (a) the in-\nterpolated image is ﬁnite in extent, while the DFT will yieldthe\ntransform of a periodic function, and (b) it represents a contin-\nuous, interpolated version of the input sample grid. Thus two\ndistinct interpolants are required: thex-domain interpolantK x\nis chosen by the user and is part of the deﬁnition ofI(x); thek-\ndomain interpolantK k is used to generate˜I(k) by interpolating\nover the DFT of the input image and the Fourier transform of\nK x.\nCorrect evaluation of the interpolated function ink-space is\nnot trivial. Bernstein & Gruen (2014) present a detailed de-\nscription of the steps required, and we summarize their results\nhere. First, they ﬁnd that the rigorously correct form ofK k is\na sinc function wrapped at the extent of thex → k DFT. Since\nthis interpolant spans the entire plane, it means that the inter-\npolation of˜I(k) to all theM × M points needed for the DFT\nrequiresN 2 M 2 operations, which can be prohibitively slow. As\na consequence we normally elect to approximate this using a\ncompact interpolant forK k.\nBernstein & Gruen (2014) demonstrate that the conse-\nquences of this interpolation are a slight multiplicative scaling\nof the image, plus the generation of 4 “ghost images” displaced\nby N ∆x along each axis. They ﬁnd that these artifacts can be\nreduced below 0.001 of the input ﬂux by a combination of zero-\npadding the input image by 4× in each direction before con-\nducting thex → k DFT, producing a denser set of samples in\nk space, and then using a custom-designed, 6-point piecewise\nquintic polynomial interpolant forK k. This recipe is the default\nfor Fourier-domain rendering of theInterpolatedImage\nin GAL SIM . Users can override the default 4-fold zero-padding\nfactor and/or the choice of theQuinticinterpolant when in-\ntializing anInterpolatedImageobject.\nThe value ofkstep for an interpolated image of input sizeN\nand pitch∆x would naively be set at 2π/(N ∆x) to reﬂect the\nbounded size of the input image. We must recall, however, that\nthe interpolation of the input image by the kernelK x will ex-\ntend the support of the object and slightly lower the desiredkstep\n(with the sinc interpolant extending the footprint of the image\nenormously).\nThe value ofkmax for a raw sampled image is inﬁnite be-\ncause it is composed ofδ functions. However the application\nof the interpolantK x to the samples will cause˜I(k) to roll off\nyieldingkmax = cπ/∆x, wherec is a constant characteristic to\nthe chosenK x. In this respect the band-limited sinc interpolant,\nwithc = 1, is ideal, but the Lanczos interpolants withn = 3–\n5 offer much more compact support with 2< c < 3 sufﬁcing\nto contain all aliases with amplitude> 0.001. See Table 1 in\nBernstein & Gruen (2014) for the relevant characteristics of the\ninterpolants.\n6.2.5. Transformations\nTransformations of functions have well-known correspon-\ndents in Fourier domain, which we quickly review here.\nA shiftI′(x) = I(x − x0) has Fourier-domain equivalent\n˜I′(k)= eik·x0 ˜I(k). A shift leaveskmax and kstepunchanged.\nLinear transformations of the plane, such thatI′(x) =\nI(A −1x),are equivalent to˜I′(k)=˜I(A T k).We identify the max-\nimum and minimum eigenvaluesλ+ and λ− ofA , and set\nkmax → λ−1\n− kmax (48)\nkstep→ λ−1\n+ kstep (49)\n6.2.6. Compositions\nThe Fourier transform is linear, so that ifI(x) = aIA (x) +\nbIB (x), we also have˜I(k) = a˜IA (k) + b˜IB (k). When we are\ndealing with a sum of multiple componentsIi, we set\nkmax = max i(kmax ,i) (50)\nkstep= mini(kstep,i) (51)\nThe convolutionI(x) = (IA ◦ IB )(x) is equivalent to˜I(k) =\n˜IA (k)˜IB (k). Under a convolution of multiple elements, we set\nkmax = mini(kmax ,i) (52)\nkstep=\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n∑\ni\nk−2\nstep,i\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n−1/2\n(53)\n15\nWhile the propagation of the band limitkmax is rigorously cor-\nrect for convolution, the propagation ofkstepin equation (53) is\nmerely heuristic. It is based on the exact statement that thecen-\ntral second moments of objects sum in quadrature under con-\nvolution. But there is no general rule for the propagation of\nthe radius enclosing some chosen fraction of the total object\nﬂux, so our heuristic is known to be correct only for Gaussian\nobjects. For strictly compact functions such as aPixel, the\nmaximum nonzero elementxmax actually adds linearly, not in\nquadrature, under convolution. GAL SIM provides the option to\nmanually increase the size of DFTs if one is worried that the\nkstepheuristic will lead to excessive aliasing.\nFinally, aDeconvolveoperation applied to some image\nIA (x) yields 1/˜IA (k) in the Fourier domain. We leavekmax and\nkstep unaltered, because the deconvolved object is usually ill-\ndeﬁned unless it is later re-convolved with an object that has a\nsmallerkmax value.\n6.3. Photon shooting\n“Photon shooting” was used successfully by Bridle et al.\n(2009, 2010) and Kitching et al. (2012, 2013) to generate the\nsimulated images for the GREAT08 and GREAT10 weak lens-\ning challenges. The objects were convolutions of elliptical\nSérsic-proﬁle galaxies with Moffat-proﬁle PSFs. GAL SIM ex-\ntends this technique to enable photon shooting for nearly all of\nits possible objects, except for deconvolutions.\nWhen we “shoot” a GAL SIM object,N γ photons are created\nwith weightsw i and positionsxi. The total weight within any\nregion has an expectation value of the ﬂux in that region, and\nthe total weights in any two regions are uncorrelated24.\nWe allow for non-uniform weights primarily so that we can\nrepresent negative values of surface brightness. This is neces-\nsary to realize interpolation with kernels that have negative re-\ngions (as will any interpolant that approximates band-limited\nbehaviour), and to correctly render interpolated images that\nhave negative pixel values, such as might arise from using em-\npirical, noisy galaxy images.\nFor photon shooting to be possible on a GAL SIM object, it\nmust be able to reportfpos and fneg, the absolute values of the\nﬂux in regions withI(x) > 0 andI(x) < 0, respectively. When\nN γ photons are requested, we draw their positions from the dis-\ntribution deﬁned by|I(x)|and then assign weights\nw i = fabs\nN γ\nsign [I(xi)]= fpos + fneg\nN γ\nsign [I(xi)]. (54)\nShot noise in the fraction of photons that end up in the\nnegative-brightness regions will lead to variations in thetotal\nﬂux of the photons. GAL SIM mostly accounts for this effect\nautomatically by selecting an appropriate number of photons to\nget the noise correct (cf. §6.3.6). However, the partial cancel-\nlations between positive- and negative-ﬂux photons means that\n24 This will not be true if you turn off the Poisson variation in the total ﬂux,\nwhich is optional but turned on by default, since then the ﬁxed total ﬂux will\nlead to some correlation in the pixel values.\nthe resulting noise will not actually be distributed precisely ac-\ncording to a Poisson distribution for the given ﬂux; only the\nvariance of the noise will be approximately accurate. For ob-\njects constructed purely from positive-ﬂux proﬁles, this effect\nis absent, and the noise is indeed Poisson.\nWe will see below that in some cases,|w i|is allowed to depart\nslightly from the constantfabs/N γ value, which also alters the\nnoise properties slightly.\n6.3.1. Analytic objects\nPhoton shooting a surface-brightness functionI(x) is sim-\nplest when there is a known transformation from the unit square\nor circle to the plane whose Jacobian determinant is∝ I.\nPixelis the simplest such case, since it is just a scaling of\nthe unit square.\nMany other proﬁles are circularly symmetric functions with\na cumulative radial distribution function\nC (r)=\n∫r\n0 I(r′)r′ dr′\n∫∞\n0 I(r′)r′ dr′\n. (55)\nIfu is a uniform deviate between 0 and 1,C −1(u) will be dis-\ntributed asrI(r), the distribution of ﬂux with radius. A second\nuniform deviate can determine the azimuthal angle of each pho-\nton.\nG AL SIM uses fast analyticC −1(u) functions for theGaus-\nsian(e.g. Press et al., 1992) andMoffatclasses.\nFor the other circularly symmetric proﬁles we use the follow-\ning algorithm to convert a uniform deviate into the radial ﬂux\ndistribution of|I|. The algorithm is provided with the function\nI(r) and with a ﬁnite set of points{R0,R1,R2,..., R M } with the\nguarantee that each interval (Ri,Ri+1) contains no sign changes\nand at most one extremum ofI(r). The absolute ﬂux|fi|in each\nannulus is obtained with standard numerical integration tech-\nniques.\nNote that this algorithm requires a maximum radius, so the\nphoton shooting rendering requires truncation of unbounded\nproﬁles. The fraction of excluded ﬂux due to this truncationis\ngiven by theshoot_accuracyparameter described in §6.4.\nThe algorithm proceeds as follows:\n1. The code ﬁrst inserts additional nodes into theRi series at\nthe locations of any extrema.\n2. The radial intervals are recursively bisected until either\nthe absolute ﬂux in the interval is small, or the ratio\nmax|I|/min |I| over the interval is below a chosen thresh-\nold.\n3. The integralfi of the absolute ﬂux is calculated for each\nannular interval along with the probabilitypi = fi/∑\ni fi of\na photon being shot into the interval. We can also calcu-\nlate the cumulative probabilityPi = ∑\nj<i pj of the photon\nbeing interior to the annulus.\n4. For each photon we draw a uniform deviateu. It is mapped\nto a radiusr by ﬁnding the intervalisuch thatPi ≤ u <\nPi+1 and then assigning\nr2 = R2\ni+ u −Pi\npi\n(\nR2\ni+1 −R2\ni\n)\n. (56)\n16\nIn other words we drawr from a ﬂux distribution that ap-\nproximates|I(r)| as a “wedding cake” of constant-valued\nannuli.\n5. (a) Ifr is in an interval that has a narrow range of bright-\nness variation, we re-weight the photon by a factor equal\nto the brightness atr relative to the mean brightness in the\nannulus:\nw = fabs\nN γ\nI(r)π\n(\nR2\ni+1 −R2\ni\n)\nfi\n. (57)\n(b) If the range of variation ofI in the annulus is large,\nwhich can happen when the annulus is near a zero cross-\ning, we implement rejection sampling by drawing an-\nother uniform deviateu′, and keeping the photonr if\n|I(r)|/max |I| > u′. If the photon is rejected, we use an-\nother uniform deviateu to select a new trial radius within\nthe interval:\nr2 = R2\ni+u\n(\nR2\ni+1 −R2\ni\n)\n. (58)\nThe rejection test is repeated, and the process is iterated\nuntil a photon radius is accepted. This photon is given the\nnominal weight (54).\n6. The azimuthal angle of the photon is selected with a uni-\nform deviate.\nThis procedure yieldsN γ photon locations and weights, em-\nploying 2N γ(1+ǫ) uniform deviates andN γ(1+ǫ) evaluations of\nI(r), whereǫ is the fraction of photons rejected in step 5b. We\nnote that the ﬁnite widths of the annuli must be small for the\napproximation to be good: the close correspondence of photon\nshooting and DFT rendering results in §9.1 demonstrates that\nthis is achieved in GAL SIM .\nIn practice we re-order the intervals into a binary tree (see,\ne.g., Makinson, 2012) to optimize the selection of an interval\nwith the initial uniform deviate. With this tree structure the\nmean number of operations to select an interval approaches the\noptimal−∑pilogpi < logM , whereM is the ﬁnal number of\nradius intervals.\nThe Sersic,Exponential,DeVaucouleurs,Airy,\nand Kolmogorovclasses use this interval-based photon\nshooting algorithm. The construction of the interval structure\nand ﬂux integrals are done only once for theExponential\nand DeVaucouleursproﬁles and once for each distinct Sér-\nsic indexn forSersicproﬁles or distinct central obscuration\nforAiry. These results are cached for use by future instances\nof the classes in each case.\n6.3.2. Shapelets\nBecause shapelet proﬁles are not radially symmetric, imple-\nmenting photon shooting for such objects represents a signif-\nicant challenge (although it is far from impossible). As of\nG AL SIM version 1.1, we have not attempted to support photon\nshooting forShapeletobjects.\n6.3.3. Interpolated images\nPhoton shooting anInterpolatedImageobject requires\ntwo steps: ﬁrst we distribute the photons among the grid points\n(i∆x, j∆x) with probabilitiespi j= |ai j|/∑|ai j|. We select an\nordering for these probabilities and create the cumulativeprob-\nabilitiesPi j. For each photon, we draw a uniform deviateu, and\nassign an (i, j) value as the last one in the ordering withPi j<u.\nThe weight is given the sign ofai j. As we did with the radial\nfunction intervals above, we create a tree structure which re-\nduces the selection of each (i, j) toO (logN ) for anN ×N input\nimage.\nThe second step in photon shooting theInterpolated-\nImageis to convolve the gridded samples with the interpola-\ntion kernelK x by adding to each photon’s location a displace-\nment drawn from the kernel. Since our 2D interpolants are all\nseparable into 1D functions, we can draw anx and y displace-\nment from the 1D functions. Theδ-function interpolant can\nof course skip this step, and the nearest-neighbour and linear\ninterpolants are trivially generated from uniform deviates. Pho-\nton shooting is implemented for the other interpolants using the\nsame algorithm described for the radial analytic functions, with\nthe replacement ofr2 → x in equations (56) & (57) because of\nthe linear instead of circular geometry.\nAttempts to shoot photons through an image with a sinc in-\nterpolant will throw an exception. The long oscillating tail of\nthe sinc function means thatfabs is divergent.\nPhoton shooting anInterpolatedImagethus requires\n3N γ(1+ǫ) random deviates plus, for most interpolants, 2N γ(1+\nǫ) evaluations of the 1D kernel function.\n6.3.4. Transformations\nAll the transformations described in §3.4 are very simply im-\nplemented in photon shooting. Flux rescaling is simply a rescal-\ning of thew i. Any transformation of the plane can be executed\nby xi → T (xi).\n6.3.5. Compositions\nTo shootN γ photons from a sum ofM proﬁles, we draw\nthe number of photons per summand{n1,n2,..., nM } from\na multinomial distribution with expectation value⟨nj⟩ =\nN γfabs,j/∑\nj fabs,j. Then we concatenate the lists ofni photons\ngenerated by shooting the individual summands.\nConvolution is similarly straightforward: to shootN γ pho-\ntons throughIA ◦ IB , we drawN γ photons each fromIA and IB ,\nset the output weights tow i = w i,A w i,B , and sum the positions to\ngetxi = xi,A +xi,B .To ensure that there is no correlation between\nthe photon positions ofA and B in the sequence, GAL SIM ran-\ndomizes the order of theB photons. This procedure generalizes\nstraightforwardly to the case of convolving more than two pro-\nﬁles together.\nWe are not aware of a practical means of implementing de-\nconvolution via photon shooting, so GAL SIM cannot use pho-\nton shooting for any proﬁle that involves a deconvolution.\n6.3.6. Selecting an appropriate number of photons\nOne of the main advantages of using the photon-shooting\nmethod for rendering images is that for objects with low signal-\nto-noise (S/N ), it can be much faster to shoot a relatively\nsmall number of photons compared to performing one or more\nFourier transforms. However, for this to be effective, one must\n17\nknow how many photons to shoot so as to achieve the desired\nﬁnalS/N value.\nThe simplest case is when there are no components that re-\nquire negative-ﬂux photons. Then the ﬂuxf of the object given\nin photons25 is exactly equal to the number of photons that\nwould be detected by the CCD. In such a case, the ﬂux itself\nprovides the number of photons to shoot.\nThis simple procedure is complicated by a number of con-\nsiderations. The ﬁrst is that the ﬂux itself is a random variable.\nSo by default, GAL SIM will vary the total number of photons\naccording to Poisson statistics, which is the natural behaviour\nfor real photons. This means that the actual realized ﬂux of the\nobject varies according to a Poisson distribution with the given\nmean value. This feature can also be turned off if desired, since\nfor simulations, users may want a speciﬁc ﬂux value, rather than\njust something with the right expectation value.\nA more serious complication happens when there are com-\nponents that require negative-ﬂux photons to be shot, such as\nthose involving interpolants (cf. §6.3.3). We need more pho-\ntons to get the right total ﬂux, since some of them have negative\nﬂux, but then the increased count leads to more noise than we\nwant. The solution we adopt to address this is to have each\nphoton carry somewhat less ﬂux and use even more photons.\nLet us deﬁneηto be the fraction of photons being shot that\nhave negative ﬂux, and let each photon carry a ﬂux of±g. We\nwant both the total ﬂux shot and its variance to equal the desired\nﬂux, f:\nf = N photons(1−2η)g (59)\nVar(f)= N photonsg2 (60)\nSetting these equal, we obtain\ng = 1 −2η (61)\nN photons = f/(1−2η)2 (62)\nG AL SIM ’s functiondrawImageautomatically does the\nabove calculation by default when photon shooting, although\nusers can override it and set a different number of photons tobe\nshot if they prefer.\nNote that the above calculation assumes thatη is a constant\nover the extent of the proﬁle being shot. In reality, it is notcon-\nstant, which leads to correlations between different regions of a\nphoton-shot image using photons of mixed sign. The resulting\nnoise pattern will roughly resemble the noise of a real photon\nimage, but one should not rely on the noise being either sta-\ntionary or uncorrelated in this case. Nor will the noise in any\npixel follow Poisson statistics. These inaccuracies gets more\npronounced asηnears 0.5.\nThere is one additional feature, which can be useful for ob-\njects with moderately high ﬂux, but which are still dominated\n25 Technically, in GAL SIM the ﬂux is deﬁned in so-called analog-to-digital\nunits, ADU. These are the units of the numbers on astronomical images. We\nallow againparameter, given in photons/ADU, to convert between these units\nand the actual number of photons, combining both the normal gain in e-/ADU\nand the quantum efﬁciency in e-/photon. The default behaviour is to ignore all\nthese issues and use a gain of 1.\nby sky background light (a relatively common use case). It may\ntake many photons to get the noise level correct, a computa-\ntional cost which is wasted if a larger amount of noise is then\nadded from the sky background. The same ﬁnalS/N can be ob-\ntained (to a very good approximation) by shooting fewer pho-\ntons, each with ﬂux larger than the normal choice ofg = 1 −2η.\nTo address this, GAL SIM has an option to allow the pho-\nton shooting process to add an additional noise per pixel over\nthe Poisson noise expected for each pixel. Each pixel may be\nallowed to haveν excess variance. The brightest pixel in the\nimage, with ﬂuxImax , can then have a variance of up toImax +ν.\nThus the number of photons can be reduced by as much as\nImax /(Imax + ν). The ﬂux carried by each photon is increased\nto keep the total ﬂux equal to the target value,f:\nN photons ≥ Imax f\n(Imax +ν)(1−2η)2 (63)\ng = f\nN photons(1−2η) (64)\nClearly, this is only helpful ifν≫ Imax , which is indeed the case\nwhen the image is sky noise dominated. This is a common use\ncase in realistic simulations, particularly ones that are meant to\nsimulate ground-based observations.\nUsers of this behaviour in GAL SIM must explicitly indicate\nhow much extra noise per pixel,ν, is tolerable. Typically this\nwill be something like 1% of the sky noise per pixel. This isnot\nthe default behaviour, because at the time of rendering the im-\nage, the code does not know how much (or whether) sky noise\nwill be added.\nAn additional complication with the above prescription is\nthat the code does not know the value ofImax a priori. So the ac-\ntual algorithm starts by shooting enough photons to get a decent\nestimate forImax . Then it continues shooting until it reaches the\nvalue given by equation (63), while periodically updating the\nestimatedImax . At the end of this process, it rescales the ﬂux of\nall the photons according to equation (64) using the ﬁnal value\nofN photons.\n6.4. Setting tolerances on rendering accuracy\nSome of the algorithms involved in rendering images involve\ntradeoffs between speed and accuracy. In general, we have\nset accuracy targets appropriate for the weak lensing require-\nments of Stage IV surveys such as LSST,Euclid(Laureijs et al.,\n2011), andWFIRST (cf. §9). However, users may prefer faster\ncode that is slightly less accurate for some purposes, or more ac-\ncurate but slower for others. This is possible in GAL SIM using\na structure calledGSParams, which includes many parameters\npertaining to the speed versus accuracy tradeoff, some of which\nare described below:\n• folding_threshold26 sets a maximum permitted\namount of real space image folding due to the periodic\n26In earlier versions of G AL SIM this parameter was named\nalias_threshold. It was renamed for clarity and to avoid confusion with\nthe phenomenon of aliasing in undersampled data.\n18\nnature of DFTs, as described in §6.2.1. It is the critical pa-\nrameter for deﬁning the appropriate step sizekstep. Addi-\ntionally, it is relevant when letting GAL SIM choose output\nimage sizes: the image will be large enough that at most a\nfractionfolding_thresholdof the total ﬂux falls off\nthe edge of the image. The default is5.e-3.\n• maxk_thresholdsets the maximum amplitude of the\nhigh frequency modes in Fourier space that are ex-\ncluded by truncating the DFT at some maximum value\nkmax . As described in §6.2.1, this truncation is required\nfor proﬁles that are not formally band-limited. Reduc-\ningmaxk_thresholdcan help minimize the effect of\n“ringing” in images for which this consideration applies.\nThe default is1.e-3.\n• xvalue_accuracyand kvalue_accuracyset the\naccuracies of values in real and Fourier space respectively.\nWhen an approximation must be made for some calcula-\ntion, such as when to transition to Taylor approximation as\nsmallr ork, the error in the approximation is constrained\nto be no more than one of these values times the total ﬂux.\nThe default for each is1.e-5.\n• realspace_relerrand realspace_abserrset\nthe relative and absolute error tolerances for real-space\nconvolution. The estimated integration error for the ﬂux\nvalue in each pixel is constrained to be less than ei-\ntherrealspace_relerrtimes its own ﬂux orre-\nalspace_abserrtimes the object’s total ﬂux. The de-\nfault values are1.e-4and 1.e-6respectively.\n• shoot_accuracysets the relative accuracy on the\ntotal ﬂux when photon shooting. When the photon-\nshooting algorithm needs to make approximations, such\nas how high in radius it must sample the radial pro-\nﬁle, the resulting fractional error in the ﬂux is limited to\nshoot_accuracy. The default value is1.e-5.\nThere are several less important parameters that can also be\nset similarly, but the above parameters are the most relevant for\nmost use cases. All the GAL SIM objects described in §3 have\nan optional parametergsparamsthat can set any number of\nthese parameters to a non-default value when initializing the\nobject.\n6.5. Representing realistic galaxies\nG AL SIM can carry out a process (‘reconvolution’) to render\nan image of a real galaxy observed at high resolution (with the\nHST ),removing theHST PSF, with an applied lensing shear\nand/or magniﬁcation, as it would be observed with a lower-\nresolution telescope. Reconvolution was mentioned in Kaiser\n(2000) and implemented in Mandelbaum et al. (2012) in the\nSHERA (SHEar Reconvolution Analysis) software27.\n27http://www.astro.princeton.edu/~rmandelb/shera/\nshera.html\nReconvolution is possible when the target band limitkmax,targ\nrelates to the originalHST band limitkmax,HST via\nkmax,targ<\n(\n1 −\n√\nκ2 +γ2\n)\nkmax,HST . (65)\nFor weak shears and convergences, this condition is easily sat-\nisﬁed by all upcoming lensing surveys, even those from space.\nIn GAL SIM , theRealGalaxyclass represents theHST\ngalaxy deconvolved by its original PSF. This can then be trans-\nformed (sheared, etc.) and convolved by whatever ﬁnal PSF is\ndesired. Observations of galaxies from theHST COSMOS sur-\nvey (described in Koekemoer et al., 2007), which form the basis\nof theRealGalaxyclass, are available for download from the\nG AL SIM repository28. Padding the input postage stamp images\nis necessary, for the reasons described in §6.2.4. We carry out\nnoise padding on the ﬂy, with a noise ﬁeld corresponding to that\nin the rest of the postage stamp (unlikeSHERA , which required\npadded images as inputs). The amount of padding was exten-\nsively tested during the numerical validation of the GAL SIM\nsoftware, and results for the default (strongly recommended)\nchoice are described in §9.2.\nThe implementation is updated compared to that inSHERA\nin several ways. First,SHERA only implemented a cubic inter-\npolant, whereas GAL SIM includes many interpolants that can\nbe tuned to users’ needs (c.f. §3.3.3). Second, GAL SIM fully\ndeconvolves the originalHST PSF. SHERA uses a technique\ncalled pseudo-deconvolution, only deconvolving theHST PSF\non scales accessible in the ﬁnal low-resolution image. In prac-\ntice, the difference between pseudo-deconvolution and decon-\nvolution is irrelevant, and what matters is the ability to render\nsheared galaxies very accurately (see §9). Finally, the original\nHST images typically contain correlated noise, and further cor-\nrelations are introduced by the shearing and subsequent convo-\nlution. In §7.5 we describe how GAL SIM (unlikeSHERA ) can\nmodel this correlated noise throughout the reconvolution pro-\ncess and then whiten the ﬁnal rendered image so that it contains\nonly uncorrelated Gaussian noise.\n7. Noise models\nNoise is a feature of all real imaging data, due to ﬁnite num-\nbers of photons arriving at each detector, thermal noise and\nelectronic noise within the detector and readout, and otherlossy\nprocesses. GAL SIM therefore provides a number of stochastic\nnoise models that can be applied to simulated images.\nIt is worth noting that images rendered by photon shooting\n(see §6.3) already contain noise: photon counts are drawn from\na Poisson distribution of mean equal to the expected ﬂux at each\npixel. But there may still be occasions when it is desirable to\nadd further noise, such as to simulate a shallower image or to\nadd detector read noise. Images rendered by DFT (§6.2) need\nnoise to be added to be made realistic.\n28https://github.com/GalSim-developers/GalSim/\nwiki/RealGalaxy%20Data\n19\n7.1. Random deviates\nUnderlying all the noise models in GAL SIM are implementa-\ntions of random deviates that sample from a range of probability\ndistributions. These include the uniform distributionU(0,1)\n(implemented by theUniformDeviateclass), the Gaus-\nsian/normal distributionN(µ,σ2) (GaussianDeviate), and\nthe Poisson distribution Pois(λ) (PoissonDeviate).\nThese fundamentally important distributions form the basis\nof noise models in GAL SIM , but they are also quite useful for\ngenerating random variates for various galaxy or PSF parame-\nters in large simulations. Additionally, we include some other\ndistributions that are more useful in this latter context rather\nthan for noise models: the binomial distribution, the Gamma\ndistribution, the Weibull distribution (a generalizationof the\nexponential and Rayleigh distributions) and theχ2 distribution\n(see, e.g., Johnson et al., 2005).\nFinally, GAL SIM also supports sampling from an arbitrary\nprobability distribution function, supplied by the user inthe\nform of either a lookup table and interpolating function, ora\ncallable Python function with a speciﬁed min and max value\nrange. This is the implemented by theDistDeviateclass.\n7.2. Uncorrelated noise models\nThe majority of noise models that GAL SIM implements gen-\nerate uncorrelated noise, i.e. noise that takes a statistically inde-\npendent value from pixel to pixel. The simplest is theGaus-\nsianNoiseclass, which adds values drawn fromN(0,σ2) to\nan image. The noise is thus spatially stationary, i.e. having a\nconstant variance throughout the image, as well as being uncor-\nrelated.\nThe PoissonNoiseclass adds Poisson noise Pois(λi) to\nthei-th pixel of the image, whereλi corresponds to the mean\nnumber of counts in that pixel (an optional sky level can be\nsupplied when simulating sky-subtracted images). ThePois-\nsonNoisemodel is not stationary, since the variance varies\nacross the image according to the different pixel ﬂuxes.\nThe CCDNoiseclass provides a good approximation to the\nnoise found in normal CCD images. The noise model has two\ncomponents: Poisson noise corresponding to the expected pho-\nton countsλi in each pixel (again with optional extra sky level)\nand stationary Gaussian read noiseN(0,σ2). It is also possi-\nble to specify a gain value in photons/ADU (analog-to-digital\nunits)29, in which case the Poisson noise applies to the photon\ncounts, but the image gets values in ADU.\nThe VariableGaussianNoiseclass implements a non-\nstationary Gaussian noise model, adding noise drawn from\nN(0,σ2\ni), using a different variance for each pixeliin the im-\nage.\nFinally, any random deviate from §7.1 can be used as the\nbasis for a simple GAL SIM noise model, using theDevi-\nateNoiseclass, which draws from the supplied random de-\nviate independently for each pixel to add noise to the image.\n29 Normally the gain is given in e-/ADU, but in GAL SIM we combine the\neffect of the gain with the quantum efﬁciency, given in e-/photon\n7.3. Correlated noise\nAstronomical images may contain noise that is spatially cor-\nrelated. This can occur at low levels due to detector crosstalk\n(e.g. Moore et al., 2004; Antilogus et al., 2014) or the use of\npixel-based corrections for charge transfer inefﬁciency (CTI,\nMassey et al. 2010), and it can be strikingly seen in images\nthat have been created through the coaddition of two or more\ndithered input images.\nDrizzled HST images (Fruchter & Hook, 2002;\nKoekemoer et al., 2003) often have correlated noise due\nto the assignment of ﬂux from single input pixels to more\nthan one output pixel. The drizzledHST COSMOS survey\nimages (see Koekemoer et al., 2007) used as the basis for\nempirical galaxy models described in §6.5 contain signiﬁcant\ninter-pixel noise correlations. For faint objects, such asthe\ngalaxies typically of interest for weak lensing, such noiseis\nwell approximated as a set of correlated Gaussian random\nvariables.\n7.3.1. Statistics of correlated Gaussian noise\nThe statistical properties of correlated Gaussian noise are\nfully described by a covariance matrix. If we denote a noise\nﬁeld asη, we may deﬁne a discrete pixel-noise autocorrelation\nfunction\nξnoise[n,m ]= ⟨η[i, j]η[i′, j′]⟩\ni′−i=n, j′−j=m , (66)\nwhere the angle brackets indicate the average over all pairsof\npixel locations [i, j] and [i′, j′] for whichi′−i= n and j′−j= m .\n(Here we use square brackets for functions with discrete, inte-\nger input variables.) Thereforen,m denote the integer separa-\ntion between pixels in the positivex and y directions, respec-\ntively. All physicalξnoise[n,m ] functions have two-fold rota-\ntional symmetry, so thatξnoise[−n,−m ] = ξnoise[n,m ], and are\npeaked atn = m = 0. If the noise is stationary, i.e. its variance\nand covariances do not depend upon location in the image, then\nξnoise[n,m ] fully determines the covariance matrix for all pairs\nof pixels in an image.\nFor any physical, discrete pixel-noise correlation function\nξnoise[n,m ] there is a positive, real-valued noise power spectrum\nPnoise[p,q] that is its Fourier counterpart (i.e. the two are related\nby a DFT). We usep,q to label array locations in Fourier space,\nand n,m in real space.\nThe functionPnoise[p,q] can be used to generate random\nnoise as a Gaussian ﬁeld. We may construct an array˜η[p,q]\nas\n˜η[p,q]=\n√\nPnoise[p,q]N\n2 {N(0,1)+iN(0,1)} (67)\nwhere samples from the standard Gaussian distributionN(0,1)\nare drawn independently at each locationp, q (subject to the\ncondition that˜η[p,q] is Hermitian, see below), andN is the to-\ntal array dimension in either direction (we assume square arrays\nfor simplicity). The inverse DFT, as deﬁned in equation (A.17),\nis then applied to generate a real-valued noise ﬁeld realization\nin real spaceη[n,m ]. The enforced Hermitian symmetry of\n˜η[p,q] is exploited to enable the use of efﬁcient inverse-real\nDFT algorithms. It can be seen that the resultantη[n,m ] will\nhave the required discrete correlation functionξnoise[n,m ].\n20\n7.3.2. Representing correlated Gaussian noise\nStationary correlated noise is modelled and generated in\nG AL SIM by theCorrelatedNoiseclass. Internally the\nnoise correlation functionξnoise[n,m ] is represented as a 2D\ndistribution using the same routines used to describe astro-\nnomical objects, described in §3. Using these to calculate\nthe noise power spectrum, and then applying the expression in\nequation (67) followed by an inverse DFT, theCorrelat-\nedNoiseclass can be used to generate a Gaussian random\nﬁeld realization with any physical power spectrum or correla-\ntion function.\nBecause theCorrelatedNoiseclass internally uses a\nregular GAL SIM surface brightness proﬁle to describe the cor-\nrelation function, it is easy to effect the transformation,as in\n§3.4, since the noise is transformed in the same manner. Simi-\nlarly, multiple noise ﬁelds may be summed (as will be required\nin §7.5), since the resultantξnoise is given by the sum of the\nindividual noise correlation functions.\nThe effect of convolution of a noise model by some kernel\nis not quite the same as what happens to surface brightness.\nInstead,ξnoiseshould be convolved by the autocorrelation of the\nkernel. The ability to describe transformations, combinations\nand convolutions of noise is valuable, as will be discussed in\n§7.5.\n7.3.3. Describing discrete correlation functions inR2\nThe description of the discrete correlation function\nξnoise[n,m ] as a distribution inR2 is worthy of some discus-\nsion. As will be seen in §7.5 it is important to be able to take\ninto account the ﬁnite size of pixels in images that may con-\ntain correlated noise, particularly when these images are being\nused to form galaxy models that will ultimately be rendered\nonto a pixel grid of a different scale. We therefore wish to rep-\nresentξnoise[n,m ] as a function of continuous spatial variables,\nξnoise(x,y) for which we require\nξnoise(ns,ms )= ξnoise[n,m ], (68)\nwhere s is the pixel scale.\nLet us consider an image containing noise. In the absence of\nany smoothing of the image, it is described mathematically as\nan array of delta function samples (located at the pixel centres)\nconvolved by the pixel response. This could also be considered\nthe formally correct model to use forξnoise(x,y): its values, like\nthose in an image, should change discontinuously across the\nboundaries between pixels as separation increases continuously.\nHowever, this description ofξnoise(x,y) presents difﬁculties\nwhen performing certain of the operations described in §7.3.2,\ne.g. convolutions, or transformations followed by a convolution.\nThe presence of sharp discontinuities at every pixel-associated\nboundary makes the necessary Fourier space representationof\nξnoise(x,y) extremely non-compact, and prohibitive in terms of\nmemory and computing resources.\nTherefore, to reduce the computational costs of handling\nGaussian correlated noise to tolerable levels, GAL SIM adopts\nbilinear interpolation between the sampled valuesξnoise(ns,ms )\nto deﬁne the continuous-valued functionξnoise(x,y) within the\nCorrelatedNoiseclass.\n−5 0 5\n∆x [pixels]\n−5\n0\n5\n∆y [pixels]\nCOSMOS F814W ACS-WFC log10[|ξnoise|/max|ξnoise|]\n−3.2\n−2.8\n−2.4\n−2.0\n−1.6\n−1.2\n−0.8\n−0.4\n'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0\nFigure 1: Illustration of the GAL SIM estimate of the discrete pixel noise cor-'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0\nFigure 1: Illustration of the GAL SIM estimate of the discrete pixel noise cor-\nrelation functionξnoise in the 0.03 arcsec/pixel, unrotated COSMOS F814W\nscience images of Leauthaud et al. (2007), made by averagingestimates from\nblank sky ﬁelds as described in §7.4. The plot depicts the logof the corre-\nlation function normalized so thatξnoise[0,0] = 1 for clarity, and shows only\nthe central region corresponding to small separations∆x,∆y, which dominate\ncovariances.\nIn practice, the impact of this efﬁciency-driven approxima-\ntion may often be small. The primary use case for the rep-\nresentation of correlated noise within GAL SIM is in handling\nnoise in models derived from direct observations of galaxies\n(see §6.5 and §7.5). In these applications, both the appliedPSF\nand the pixel scale on which the ﬁnal image will be rendered\nare typically signiﬁcantly larger than the pixel scale of the in-\nput images. The use of bilinear interpolation represents a small\nadditional convolution kernel in these cases.\n7.4. COSMOS noise\nThe HST COSMOS galaxy images made available for\ndownload with G AL SIM for use in the RealGalaxy\nclass (see Koekemoer et al., 2007; Leauthaud et al., 2007;\nMandelbaum et al., 2012) contain noise that is spatially cor-\nrelated due to drizzling. To construct a model for this cor-\nrelated noise, we estimated the discrete pixel noise correla-\ntion function in∼100 rectangular regions selected from empty\nsky in the public, unrotated, ACS-WFC F814W science im-\nages (0.03 arcsec/pixel) from COSMOS (described in detail by\nKoekemoer et al., 2007; Leauthaud et al., 2007).\nEach rectangular region varied in size and dimensions, being\nchosen so as not to include any detected objects, but were typ-\nically square regions∼50-200 pixels along a side. The mean\nnoise correlation function in these images (calculated by sum-\nming over each individual estimate, see §7.3.2) provides an\nestimate of the mean noise correlation function in COSMOS\nF814W galaxy images used by GAL SIM as the basis for galaxy\nmodels. The resulting estimate ofξnoiseis depicted in Fig. 1.\nThis model is included with the GAL SIM software for gen-\neral use in handling images that contain noise like those in the\nCOSMOS F814W images, and is accessible via thegetCOS-\nMOSNoise()convenience function.\n21\n7.5. Noise whitening\nAll images of galaxies from telescope observations will con-\ntain noise. As pointed out by Mandelbaum et al. (2012), this\nnoise will become sheared and correlated (in an anisotropic\nway) by the action of the reconvolution algorithm describedin\n§6.5, which can result in a signiﬁcant systematic offset in the re-\nsults from galaxy shear simulations. Mandelbaum et al. (2012)\nfound that the presence of correlated noise caused∼1% level er-\nrors in the determination of calibration biases for weak lensing\nshear for high-S/N galaxies; the effect is worse at lowerS/N ,\nand cannot be ignored for high-precision shear simulations.\nG AL SIM addresses the presence of correlated noise in sim-\nulated images, such as the sheared, convolved noise ﬁelds cre-\nated by the reconvolution algorithm, through a process referred\nto as “noise whitening”. This technique adds further noise to\nimages, with a correlation function chosen to make the combi-\nnation of the two noise ﬁelds approximately uncorrelated and\nstationary (aka “white”).\nWe consider an image containing correlated Gaussian noise\nthat we label asη. We assume⟨η⟩= 0 and we modelηas sta-\ntionary across the image so that its covariance matrix is fully\ndescribed by its correlation functionξnoise[n,m ] or power spec-\ntrum Pnoise[p,q]. We add additional whitening noise which we\nlabelηwhitening, giving a combined noise ﬁeld\nηtotal= η+ηwhitening. (69)\nThe statistics ofηwhiteningare also determined by its power spec-\ntrum,Pwhitening[p,q], andηwhiteningwill be physically realizable\nprovided that\nPwhitening[p,q]≥ 0 (70)\nfor allp,q. The power spectrum of the combined noise ﬁeld is\nsimply\nPtotal= Pnoise+ Pwhitening. (71)\nWe may choose Pwhiteningso thatηtotalis uncorrelated by re-\nquiringPtotalto be a constant (a ﬂat power spectrum corre-\nsponds to a delta function correlation function, which is white\nnoise). This, and the requirementPwhitening≥ 0, is satisﬁed by\nchoosing\nPwhitening[p,q]= max\np,q\n{Pnoise[p,q]}− Pnoise[p,q]. (72)\nIn practice, GAL SIM adds a small amount of additional vari-\nance so thatPwhitening>0, deﬁning\nPwhitening[p,q]= (1+ǫ)×max\np,q\n{Pnoise[p,q]}\n−Pnoise[p,q] (73)\nwhere ǫ = 0.05 by default. The whitening noiseηwhiteningcan\nthen be added following the prescription described in §7.3.1,\nusing the expression forPwhiteningabove. At a relatively small\nfractional cost in additional variance, the ‘headroom’ parameter\nǫ effectively guaranteesPwhitening[p,q] ≥ 0. Withoutǫ this im-\nportant condition might not be met, due to numerical rounding\nand approximations in the description ofξ[n,m ] (see §7.3.3).\n−3 −2 −1 0 1 2 3\nSeparation ∆x [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\n|ξnoise| / max|ξnoise|\nCOSMOS noise\n−3 −2 −1 0 1 2 3\nSeparation ∆x [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\nWhitened noise\n−3 −2 −1 0 1 2 3\nSeparation ∆y [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\n|ξnoise| / max|ξnoise|\n−3 −2 −1 0 1 2 3\nSeparation ∆y [pixel]\n10-5\n10-4\n10-3\n10-2\n10-1\n100\nFigure 2: Left panels: cross section through the discrete pixel noise correlation\nfunctionξnoisefor the COSMOS F814W blank sky ﬁelds described in §7.4 and\nshown in Fig. 1, normalized to unit zero-lag variance; the upper left panel shows\nCOSMOS noise correlations in the direction∆y = 0, and the lower left panel\nshows COSMOS noise correlations in the direction∆x = 0. Right panels: cross\nsection through the normalized discrete pixel noise correlation functions for a\nsingle∼400 pixel× 300 pixel patch of blank sky, taken from COSMOS, to\nwhich further whitening noise has been added using the §7.4 model forξnoise,\nusing the procedure described in §7.5. As for the left panels, the upper right and\nlower right panels show correlations along the directions∆y = 0 and∆x = 0,\nrespectively. Unﬁlled bars represent negative correlation function values.\nFig. 2 shows cross sections throughξtotal[n,m ] from a sin-\ngle∼ 400 × 300 pixel patch of blank sky taken from COS-\nMOS F814W ACS-WFC images, to which further whitening\nnoise has been added.Pwhiteningwas calculated using the model\nforξnoise (and thusPnoise) described in §7.4 along with equa-\ntion (73). Here GAL SIM noise whitening has lowered inter-\npixel covariances to∼10−2–10−3 of the zero-lag variance in the\nwhitened image.\nWe have tested that applying this whitening procedure to\nCOSMOS noise ﬁelds that have been sheared and convolved\n(like those produced by the reconvolution algorithm of §6.5)\nsimilarly reduce the noise correlations by 2–3 orders of mag-\nnitude, making them statistically undetectable in all but the\nlargest simulated images.\nThe price paid for noise whitening is additional variance in\nthe output image. The noise added in equation (69) is an ad-\nditional stochastic degradation of an image. For the COSMOS\nF814W noise ﬁeld whitened in Fig. 2, the ﬁnal noise ﬁeld there-\nfore has a variance that is greater than the variance in the orig-\ninal images. However, the correlated noise in a COSMOS im-\nage itself results in a lower effectiveS/N for estimates of ob-\nject properties such as ﬂux, or shape, relative to the case ofan\nimage with the same variance but with pure white noise (for\na discussion of these effects, which depend on object size and\nthe properties of the correlated noise, see, e.g., Casertano et al.,\n2000; Leauthaud et al., 2007). The effect of additional whiten-\ning of the noise in such an image, therefore, reduces theS/N\nof estimates of object properties by less than implied by thera-\n22\ntio of pre- and post-whitening image variances. The amount\nof information lost in whitening will depend on the property\nin question, the object proﬁle, and the noise correlations in the\noriginal image.\nIn the case of noise ﬁelds that have been sheared, convolved\nby a PSF, and then rendered on an image with a larger pixel\nscale (as described in §6.5), the noise added in whitening de-\npends not only on the original noise correlation function, but\nalso on the applied shear, PSF, and ﬁnal pixel scale. Interest-\ningly, it is found to be typically substantially lower in overall\nvariance than in the case of whitening raw COSMOS noise\nat native resolution (the case described above and shown in\nFig. 2).\nOn investigation, this was found to be due to a combina-\ntion of effects. The shear and convolution both increase the\nnoise correlations at large scales. However, the ﬁnal image\nrendering typically has a pixel scales signiﬁcantly larger than\nthe 0.03 arcsec/pixel of the COSMOS images, which means\nthat the values of the correlation function at integer multiples\nof s in separation are often smaller than in the original COS-\nMOS image. Also, convolution with a broad PSF reduces the\noverall noise variance considerably, being essentially a smooth-\ning kernel. These effects combine fortuitously in practice:\nMandelbaum et al. (2014) found that only a relatively modest\namount of whitening noise is required to treat the sheared, cor-\nrelated noise in images generated by the reconvolution algo-\nrithm of §6.5 with a ground-based target PSF and pixel scale.\nIn GAL SIM theImageclass has a methodwhitenNoise\nthat applies the above whitening algorithm to a given im-\nage. This method also returns the theoretical estimate of\nthe noise variance in the ﬁnal whitened image (namely (1+\nǫ) maxp,q {Pnoise[p,q]}). In addition, there is a methodsym-\nmetrizeNoisethat imposesN -fold symmetry (for evenN ≥\n4) on the noise ﬁeld rather than making it entirely white. Typ-\nically far less noise must be added bysymmetrizeNoise\ncompared towhitenNoise, which makes it a useful option\nfor those applications that do not require fully white noise.\nThe RealGalaxyclass has an attributenoisethat keeps\ntrack of the estimated correlated noise in the proﬁle. When this\nobject is transformed or convolved, the new object will also\nhave anoiseattribute that has had the appropriate transforma-\ntion done to propagate the noise in the new proﬁle. This allows\nG AL SIM to automatically track the effect of transformations on\nnoise ﬁelds without much user input required. The ﬁnal pro-\nﬁle’snoiseattribute can then be used to whiten the rendered\nimage. Furthermore, users can add anoiseattribute them-\nselves to any object they create and get the same behaviour.\nIn a larger image with many scattered, possibly overlapping\ngalaxies, the correlated noise in the original images may differ,\nfurther complicating the task of getting uniform white noise in\nthe ﬁnal image. GAL SIM handles this by drawing each galaxy\non its own postage stamp image and whitening that individu-\nally. Still, the ﬁnal image has a complicated patchwork of noise\nwith different regions having different variances, but it is rela-\ntively straightforward in GAL SIM to keep track of these noise\nlevels: the conﬁguration ﬁle interface described in §2.3 allows\nthis to be handled automatically. Then theVariableGaus-\nsianNoiseclass can add a variable amount of noise to each\npixel to bring the noise up to a uniform value across the entire\nimage.\n8. Shear estimation\nG AL SIM includes routines for estimation of weighted mo-\nments of galaxy shapes and for estimation of PSF-corrected\nshears. The code for these routines was originally introduced\nby Hirata & Seljak (2003) (hereafter HS03), including an en-\ntirely new PSF correction method known as re-Gaussianization.\nThese routines were later tested, improved, and optimized in\nsubsequent work (Mandelbaum et al., 2005, 2012; Reyes et al.,\n2012). The code was developed as a free-standing C package\nnamedHSM , and was released publicly under an open source\nlicense simultaneously with its incorporation into GAL SIM .\nThe functionFindAdaptiveMomentsimplements the\n“adaptive moments” method described in §2.1 of HS03, based\non Bernstein & Jarvis (2002). It iteratively computes the mo-\nments of the best-ﬁtting elliptical Gaussian, using the ﬁtted el-\nliptical Gaussian as a weight function.\nThe functionEstimateShearimplements multiple meth-\nods that were tested in HS03:\n1. The PSF correction method described in Appendix C of\nBernstein & Jarvis (2002) tries to analytically account for\nthe effect of the kurtosis of the PSF (in addition to the\nsecond order moments) on the galaxy shapes.\n2. The “linear” method (described in Appendix B of HS03) is\na variant of the previous method that accounts for the ﬁrst-\norder departure of both the PSF and galaxy from Gaus-\nsianity.\n3. The “re-Gaussianization” PSF correction method de-\nscribed in §2.4 of HS03 models the PSF as a Gaussian\nplus a residual, and subtracts from the observed image\nan estimate of the residual convolved with the pre-seeing\ngalaxy. The resulting image has roughly a Gaussian PSF,\nfor which the methods described above can be used for the\nﬁnal PSF correction.\n4. A speciﬁc implementation of the KSB method\n(Kaiser et al., 1995; Luppino & Kaiser, 1997), as de-\nscribed in Appendix C of HS03, is also provided.\nThese routines work directly on GAL SIM images. The ﬁrst\nthree PSF correction methods output a measure of per-galaxy\nshape called a distortion, which for an ensemble of galaxies\ncan be converted to shear estimates via a responsivity factor\n(cf. Bernstein & Jarvis 2002). The outputs are clearly labeled\nas being distinct from per-galaxy shear estimates, such as those\noutput by the KSB routine.\nAs is typical for all shape measurement algorithms, there\nare several tunable parameters for the above methods and for\nmoment estimation overall (with adaptive moment estimation\nplaying a role in all but the KSB method of PSF estimation).\nG AL SIM therefore includes two ways of tuning these param-\neters. There is anHSMParamsstructure that allows users to\n23\nchange parameters that affect how the submodule works over-\nall. Other parameters are given as arguments to the speciﬁc\nfunctions.\nAside from the obvious utility of being able to operate di-\nrectly on images in memory, rather than ﬁles, the versions of\nthese routines in GAL SIM come with some improvements over\nthe free-standing C code. These include an intuitive and more\nﬂexible user interface; optimization of convolutions, theexp\nfunction (via reduction of the number of function calls), and\nFourier transforms (using theFFTW package, Frigo & Johnson,\n2005); a clean way of including masks within images that is\neasily extensible to variable weight maps; and a ﬁx for a bug\nthat caused the original C code to work incorrectly if the input\nPSF images were not square.\n9. Numerical validation\nIn this Section we describe the investigations that were un-\ndertaken to validate the accuracy of GAL SIM image simula-\ntions. Although an exhaustive validation of the rendering of\nevery combination of galaxy/PSF proﬁles and observing con-\nditions is impractical, certain key aspects of GAL SIM perfor-\nmance are shown here. Emphasis is placed on conﬁrming that\nG AL SIM meets the stringent requirements on image transfor-\nmations for lensing shear and magniﬁcation simulation.\nIn particular, our metric for validating that the rendered im-\nages are sufﬁciently accurate is based on measurements of the\nsize and ellipticity of the rendered proﬁles, calculated using the\nadaptive moment routines described in §8.\nWe deﬁne the following “STEP-like” (see Heymans et al.,\n2006) models for the errors in the estimates of object ellipticity\ng1 and g2 and sizeσ:\n∆gi = m igi +ci, (74)\n∆σ= m σσ+cσ, (75)\nwhere i = 1,2. The method of estimating the errors∆gi and\n∆σvaries for each of the validation tests described below, buta\ncommon component is adaptive moments estimates of rendered\nobject shapes from images (see §8). We will use the formulae\nabove when describing the nature of the errors in each test.\nAs discussed in Mandelbaum et al. (2014), a well-motivated\ntarget for simulations capable of testing weak lensing measure-\nment is to demonstrate consistency at a level well within the\noverall requirements for shear estimation systematics setby Eu-\nclid(e.g. Cropper et al., 2013; Massey et al., 2013):m i ≃ 2 ×\n10−3 and ci ≃ 2 ×10−4. Such values also place conservative re-\nquirements on galaxy size estimation, as the signal-to-noise ex-\npected for cosmological magniﬁcation measurements has been\nestimated as≲ 50% relative to shear (e.g. van Waerbeke, 2010;\nSchmidt et al., 2012; Duncan et al., 2014).\nOnly if these stringentEuclidconditions are met comfortably\nwill simulations be widely usable for testing weak lensing shear\nestimation, and other precision cosmological applications, in\nthe mid-term future. For each validation test we therefore re-\nquire that GAL SIM can produce images showing discrepancies\nthat are a factor of 10 or more below theEuclidrequirements,\ni.e.m x < 2 × 10−4, cx < 2 × 10−5, wherex = 1,2,σ corre-\nsponding tog1,g2 and σ, respectively. Our intention is to show\nthat rendering accuracy improves with more stringent rendering\nparameter settings, and can be raised to meet the requirement\nabove. GAL SIM default settings for these parameters, however,\nare chosen to reﬂect a balance between speed and accuracy for\ngeneral use. Although these defaults typically take valuesthat\nguarantee meeting 1/10thEuclidrequirements, this is not ex-\nclusively the case (see §9.3).\nFor our tests, we use comparisons of rendering methods us-\ning adaptive moments measurements. Although there are inac-\ncuracies inherent in such measurements in an individual sense,\nwe take care to construct our comparisons to be sensitive only\nto differences in the image rendering. For example, the tests\nalways compare noise-free orextremelylow noise images, with\nthe same underlying galaxy model. Noise bias and model bias\ntherefore affect each test subject in the same way, and differ-\nences are due solely to how the test images were rendered.\nThe tests in this Section were conducted over a period of ex-\ntended validation of the GAL SIM software between July 2013\nand the time of writing this paper. During this time period, cor-\nresponding approximately to versions 1.0 and 1.1 of GAL SIM ,\nthe routines for rendering objects did not change signiﬁcantly\n(except where modiﬁcations were found necessary to meet the\nvalidation criteria onm x and cx deﬁned above).\n9.1. Equivalence of DFT rendering and photon shooting\nOne of the principal advantages of the photon shooting\nmethod (see §6.3) is that the implementations of the various\ntransformations described in §3.4 are very simple. Photonsare\njust moved from their original position to a new position. Con-\nvolutions are similarly straightforward. On the other hand, DFT\nrendering (see §6.2) needs to deal with issues such as band lim-\niting and aliasing due to folding (cf. §6.2.1).\nThus a powerful test of the accuracy of our DFT implementa-\ntion is that the the two rendering methods give equivalent results\nin terms of measured sizes and shapes of the rendered objects.\nAn unlikely conspiracy of complementing errors on both sides\nwould be required for this test to yield false positive results.\nOf all the objects in Table 3, Sérsic proﬁles are the most nu-\nmerically challenging to render using Fourier methods. Espe-\ncially forn ≳ 3, the proﬁles are extremely cuspy in the cen-\ntre and have very broad wings, which means that they require\na large dynamic range ofk values when performing the DFT.\nThey therefore provide a good test of our choices for parame-\nters such asfolding_thresholdand maxk_threshold\n(see §6.4) as well as general validation of the DFT implemen-\ntation strategies.\nFor our test, we builtSersicobjects with Sérsic indices in\nthe range 1.5 ≤ n ≤ 6.2. The half-light radii and intrinsic el-\nlipticities|g(s)|were drawn from a distribution that matches ob-\nserved COSMOS galaxies, as described in Mandelbaum et al.\n(2014). The galaxies were then rotated to a random orienta-\ntion, convolved with a COSMOS-like PSF (a circularAiry\nproﬁle), and then rendered onto an image via both DFT and\nphoton shooting.\n24\nThe error estimates were taken to be the difference between\nthe adaptive moments shape and size estimates from the two\nimages:\n∆gi = gi,DFT −gi,phot (76)\n∆σ= σDFT −σphot (77)\nFor each galaxy model, we made multiple trial photon shoot-\ning images, each with very highS/N to avoid noise biases (107\nphotons shot per trial image). The mean and standard error of\n∆gi and ∆σfrom these trials were used to estimate values and\nuncertainties form x,DFT and cx,DFT using standard linear regres-\nsion.\nDifferences between shape and size estimates are illustrated\nin Fig. 3, forn = 1.5 andn = 6.2. Fig. 4 shows derived esti-\nmates ofm x,DFT for these and other Sérsic indices tested. Toler-\nances are met onm -type biases. It was found thatc-type addi-\ntive biases were consistent with zero for alln indices.\nFig. 5 shows results from a high-precision investigation of\nm x,DFT as a function ofGSParamsparameters (see §6.4), us-\ning a randomly selected sample of 270 galaxies from COS-\nMOS at each parameter value and large numbers of photons.\nEach galaxy was generated in an 8-fold ring test conﬁgura-\ntion (Nakajima & Bernstein, 2007) to further reduce statistical\nuncertainty. The plot in Fig. 5 shows the impact of increas-\ning thefolding_thresholdparameter: as expected, the\nrendering agreement decreases asfolding_thresholdin-\ncreases, and the representation of object size is most affected.\nAnalogous results were achieved for many of the parameters\ndiscussed in §6.4, and the defaultGSParamsparameters were\nfound to give conservatively good performance in all tests.\n9.2. Accuracy of transformed interpolated images\nInterpolated images pose unique challenges for DFT render-\ning. As we discussed in §6.2.4, details such as the choice of the\nFourier-space interpolant and how much padding to use around\nthe original image signiﬁcantly affect the accuracy of the ren-\ndering. We thus need to validate that these choices can be varied\nto produce sufﬁciently accurate results.\nFor this test, we randomly selected a sample 6000 Sérsic\nmodels from the catalogue COSMOS galaxy ﬁts described in\nMandelbaum et al. (2014). For each galaxy in the sample, we\nconstructed aSersicobject using the best-ﬁtting parameters\nin the catalogue, which was then convolved by a COSMOS-\nlike PSF (a circularAiryproﬁle). This proﬁle was drawn onto\nan image with 0.03 arcsec resolution (matching the COSMOS\nimages). That image was then used to construct anInterpo-\nlatedImageproﬁle.\nFor each object in the sample we therefore had the same pro-\nﬁle modelled both as an analytic convolution and as an interpo-\nlated image. Small shears were then applied to both models and\nthe resulting proﬁles were drawn onto images using the DFT\nrendering algorithm, although without including the integration\nby a pixel. Each proﬁle was convolved by a tiny Gaussian to\nforce GAL SIM to use the DFT rendering method (as direct ren-\ndering would otherwise be used when omitting the pixel convo-\nlution).\n−0.6 −0.4 −0.2 0.0 0.2 0.4 0.6\ng1  (DFT)\n−0.00010\n−0.00005\n0.00000\n0.00005\n0.00010\n∆g1  (DFT - photon)\nn = 1.5\nn = 6.2\n−0.6 −0.4 −0.2 0.0 0.2 0.4 0.6\ng2  (DFT)\n−0.00010\n−0.00005\n0.00000\n0.00005\n0.00010\n∆g2  (DFT - photon)\nn = 1.5\nn = 6.2\n0.1 0.2 0.3 0.4 0.5 0.6 0.7\nσ (DFT) [arcsec]\n−0.00001\n0.00000\n0.00001\n0.00002\n0.00003\n0.00004\n0.00005\n∆σ (DFT - Photon) [arcsec]\nn = 1.5\nn = 6.2\nFigure 3: Difference between measured shears (upper panel:g1; central panel:\ng2; lower panel:σ) for Sérsic proﬁles simulated using the photon-shooting and\nDFT rendering methods, plotted against the (shot noise free) shear and size\nmeasured from the DFT image. Results are shown for 30 galaxies with realistic\nsize and shape distribution, and Sérsic index valuesn = 1.5,6.2. (Note that\nthe ‘peakiness’ of the high-n proﬁles results in their lowσestimates. The two\nsamples share the same distributions of half light radii.) The best-ﬁtting lines\nare shown, and estimates of the slopesm x,DFT for these and other values ofn\nare plotted in Fig. 4.\n25\n1 2 3 4 5 6 7\nSersic index n\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope mDFT\ng1\ng2\nσ\nFigure 4: Estimates ofm 1,DFT ,m 2,DFT and m σ,DFT , corresponding to rendering-\ninduced discrepancies in ellipticityg1,g2 and sizeσ, respectively, as a func-\ntion of Sérsic indexn. These slope parameters are deﬁned by equations (74) &\n(75) for the differences between measurements from DFT and photon-shooting-\nrendered images of Sérsic proﬁles. The shaded region shows the target for\nG AL SIM based on not exceeding one tenth of weak lensing accuracy require-\nments for Stage IV surveys such asEuclid(see §9).\n10-3 10-2 10-1\nfolding_threshold\n−0.00030\n−0.00025\n−0.00020\n−0.00015\n−0.00010\n−0.00005\n0.00000\nMultiplicative slope mDFT\ng1\ng2\nσ\nFigure 5: Estimates ofm 1,DFT ,m 2,DFT and m σ,DFT , corresponding to rendering-\ninduced discrepancies in ellipticityg1,g2 and sizeσ, respectively, as a func-\ntion of theGSParamsparameterfolding_threshold. Each point shows\nthe average from the randomly-selected sample of 270 unmodiﬁed COS-\nMOS galaxy models described in §9.1. The rendering parameter fold-\ning_thresholdis described in §6.4 and takes a default value of 5× 10−3,\nindicated by the dotted line. As for Fig. 4 these parameters are deﬁned by the\nmodel of equations (74) & (75). The shaded region shows the target for GAL -\nSIM based on not exceeding one tenth of weak lensing accuracy requirements\nfor Stage IV surveys (see §9).\nAdaptive moments estimates of the change in ellipticity were\nseen to be consistent between the parametric model and inter-\npolated image at better than 1/10thEuclidrequirements, for all\nreal and Fourier space interpolants of higher order than bilinear.\nCrucially, both were consistent with the known applied shear.\nResults for changes in object size were similar. These testsvali-\ndated theInterpolatedImagehandling of transformations\nfor simple input images derived from parametric proﬁles (such\nas a Sérsic galaxy convolved with a COSMOS PSF).\nThe test was then extended to the more complicated case of\nRealGalaxyproﬁles. Once again, adaptive moments esti-\nmates of the object ellipticity were made before and after ap-\nplying a shear. This was compared to the expected shear, cal-\nculable given an adaptive moments estimate of the intrinsicel-\nlipticity prior to shearing, and the known applied shear. The\nRealGalaxyproﬁle was again convolved with a tiny Gaus-\nsian PSF prior to rendering (see above), but in this case addi-\ntional whitening noise was applied to verify that the presence of\nsheared, correlated noise in the output was being appropriately\nhandled.\nThis test was repeated for the same sample of 6000 COS-\nMOS galaxy images. Fig. 6 shows estimates ofm i,interpfor a\nrange of Fourier space interpolants, and for two values of the\npad_factorparameter, which speciﬁes how large a region\naround the original image to pad with zeroes. A larger value\nforpad_factorproduces more accurate results, as shown in\nFig. 6, but is accompanied by large increases in computation\ntime.\nWe performed many similar tests to this for a range of trans-\nformations (in various combinations) and input parameters. In\nall tests performed, settingpad_factor= 4 and using the\ntwo-dimensional quintic interpolant gave results that satisﬁed\nm i,interp< 2 × 10−4,ci,interp< 2 × 10−5. These results justify\nthe choice of these as the defaults in GAL SIM . Values ofci,interp\nwere found to be extremely small in general.\nIn addition to verifying direct shear response, we also\nchecked for leakage between shear components, i.e., that ap-\nplying shear in one component does not result in an incorrect\nlevel of shear in the other component. The leakage was found\nto be consistent with zero and comfortably within requirements\nforpad_factorvalues of 4 and 6, for all interpolants tested.\nThe onlyRealGalaxytest that did not pass our require-\nment was when we simultaneously simulated shears in both\ncomponents and a magniﬁcation. In this case we found\nmσ,interp∼ (4± 0.4)× 10−4, largely irrespective of the choice\nof interpolant. The source of this bias, which is larger thanthe\ntarget 2× 10−4, has not yet been identiﬁed. However, as mag-\nniﬁcation is a cosmological probe that is typically noisierthan\nshear, this degree of discrepancy is likely to be tolerable for\nsimulations of magniﬁcation in Stage IV survey data.\n9.3. Accuracy of reconvolution\nAs a ﬁnal demonstration of GAL SIM ’s high precision opera-\ntion, we tested that we can accurately apply the reconvolution\nalgorithm of §6.5 (Mandelbaum et al., 2012). The aim is to rep-\nresent the appearance of a test object following an applied shear\ngapplied, when viewed at lower resolution.\n26\n3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0\nInput pad_factor\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope m 1,interp\nk interpolants: slope of ∆g1  as a function of\napplied g1  [only g1  applied]\ncubic\nquintic\nlanczos3\nlanczos4\nlanczos5\nlanczos7\n3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0\nInput pad_factor\n−0.0003\n−0.0002\n−0.0001\n0.0000\n0.0001\n0.0002\n0.0003\nMultiplicative slope m 2,interp\nk interpolants: slope of ∆g2  as a function of\napplied g2  [only g2  applied]\ncubic\nquintic\nlanczos3\nlanczos4\nlanczos5\nlanczos7\nFigure 6: Multiplicative biasm i,interpin the relationship between an applied\nshear and an adaptive moments estimate of the observed shearforReal-\nGalaxyobjects, for various Fourier space interpolants, e.g. cubic, quintic etc.,\nand the padding factor (default = 4, indicated by the dotted line). These re-\nsults include the handling of correlated noise via the noisewhitening procedure\ndescribed in §7.5. The shaded region shows the target for GAL SIM based on\nnot exceeding one tenth of weak lensing accuracy requirements for Stage IV\nsurveys (see §9).\nThis test was carried out usingSersicproﬁles convolved\nby a known COSMOS-like PSF (a circularAiryproﬁle), ren-\ndered at high resolution (0.03 arcsec/pixel). These images,\nalong with images of the PSF, were then used as inputs to ini-\ntializeRealGalaxyobjects, mimicking the use of real COS-\nMOS galaxy images. In the usual manner these objects were\nsheared and reconvolved by a broader (ground-based or Stage\nIV space-based survey) PSF, then rendered at lower resolution.\nBecause of the use of an underlying parametric Sérsic proﬁle,\nthe rendering of which has been validated in §9.1, we can also\nrender the convolved, sheared objectdirectlyat lower resolution\nto provide a reference for comparison. We quantify any error\nin the effectively applied shear due to the reconvolution process\nasm i,reconvand ci,reconv, deﬁned according to equation (74).\nThe test was done for 200 proﬁles whose parameters were\nselected from the real COSMOS galaxy catalogue described in\nMandelbaum et al. (2014), using random galaxy rotations in an\n8-fold ring test conﬁguration (Nakajima & Bernstein, 2007).\nSince galaxies with different light proﬁles might be more or\nless difﬁcult to accurately render using reconvolution, wemust\nconsider not only the mean values ofm and c, but also investi-\ngate their ranges, which could identify galaxy types for which\nthe method fails to work sufﬁciently accurately even if it issuc-\ncessful for most galaxies.\nFig. 7 shows m i,reconv as a function of the fold-\ning_thresholdparameter described in §6.4. Near the\nG AL SIM default value of 5×10−3, our requirementm i,reconv <\n2 × 10−4 is met comfortably in the ensemble average.\nAcross the sample of 200 COSMOS galaxies a small frac-\ntion (3/200) exceeded our requirement for the defaultfold-\ning_thresholdvalue form 2,reconv. However, we do not be-\nlieve that this represents enough of a concern to change the de-\nfaultGSParamssettings. Provided that a representative train-\ning set of galaxy models (such as the COSMOS sample), of\nsufﬁcient size, is used, the variation inm i,reconv seen in Fig. 7\nshould not prevent simulations using the reconvolution algo-\nrithm from being accurate to Stage IV requirements for weak\nlensing.\nIf greater accuracy is required, users wishing to reduce the\nimpact of these effects can modify the values of theGSParams\naccording to their needs. In this case, reducingfold-\ning_thresholdby a factor of 10 bringsm 2,reconv within re-\nquirements for all 200 galaxies tested. Additive biasesci,reconv\nwere found to be extremely small (and consistent with zero) in\nall cases.\nThese results shows that the approximations inherent in the\nreconvolution process do not signiﬁcantly interfere with GAL -\nSIM ’s ability to render accurate images suitable for weak lens-\ning simulations, for a realistic range of galaxy proﬁles drawn\nfrom COSMOS.\n9.4. Limitations\nWhile results presented in this Section are encouraging, with\nthe default settings providing accuracy that comfortably ex-\nceeds our requirements by a factor of 5–10 in many cases, it\nmust be remembered that no set of tests presented in this arti-\n27\ncle could be sufﬁcient to positively validate GAL SIM ’s perfor-\nmance for all possible future applications. Users of GAL SIM\nare strongly advised to conduct their own tests, tailored totheir\nspeciﬁc requirements.\nOne speciﬁc caveat worthy of mention is the adoption of a\ncircular PSF for all tests presented. A circularAirywas cho-\nsen as a simple approximation to the PSF found in COSMOS\nand otherHST images. GAL SIM makes no distinction between\nthose objects describing PSFs and those describing galaxies\nwhen rendering convolutions of multiple proﬁles. However,it is\npossible that a subtle bug or genuine rendering issue might only\nbe activated for cases wherebothgalaxy and PSF break circular\nsymmetry. We stress again that no set of tests performed here\ncan cover all possible uses of the code. Where data properties\nsuch as the PSF are known we encourage GAL SIM users to per-\nform their own validation and adjust the rendering parameters\nas required for their particular use case.\nAnother caveat is that we only used a particular set of COS-\nMOS galaxies for the training sample. It is plausible that galaxy\nmodels drawn from a population with a different redshift dis-\ntribution to the COSMOS sample, or imaged in a ﬁlter other\nthan F814W, might have sufﬁciently different morphological\ncharacteristics to fail the rendering requirements adopted in this\nwork. In future it will be of value to understand the marginal,\nm σ,interp≃ 4 ×10−4 failure of galaxy size transformations in the\nRealGalaxytests when both shear and magniﬁcation were\napplied (see §9.2).\nIn many cases, therefore, users may ﬁnd it necessary to mod-\nify and reﬁne the tests presented here, especially where thein-\nputs and requirements of their analyses differ signiﬁcantly from\nthe assumptions adopted. Some of the tests in this Section will\nhopefully serve as a useful starting point for these investiga-\ntions.\n10. Performance\nWhile the paramount consideration in GAL SIM is the accu-\nracy of the renderings, especially with respect to the shapes,\nwe have also paid considerable attention to making the code as\nfast as possible. Code optimization is of course a wide ranging\ntopic, and we will not attempt to go into detail about all the op-\ntimizations included in the GAL SIM code. We just mention a\nfew optimizations that were particularly helpful and give some\nestimates of the timings for typical use cases.\n10.1. Optimizations\nThe most important performance decision was to use C++\nfor all time-critical operations. The Python layer provides a\nnice front-end user interface, but it is notoriously difﬁcult to\ndo serious coding optimization in Python. So for all signif-\nicant calculations, GAL SIM calls C++ functions from within\nPython, where we have used the normal kinds of optimization\ntechniques that are standard with C and C++ code: precomput-\ning values that will be used multiple times, having tight inner\nloops, using iterators to be more amenable to vectorizationby\nthe compiler, using lookup tables and LRU caches, etc.\n10-3 10-2 10-1\nfolding_threshold\n−0.0004\n−0.0002\n0.0000\n0.0002\n0.0004\nMultiplicative slope m reconv\ng1\ng2\nFigure 7: Multiplicative slopem i,reconvfor the reconvolution test of §9.3, forg1\nand g2, as a function of thefolding_thresholdparameter (cf. §6.4). The\nexterior error bars show the full range of values for the 200 models tested, and\nthe points and interior error bars show the mean and standarderror. The shaded\nregion shows the target for GAL SIM based on not exceeding one tenth of weak\nlensing accuracy requirements for Stage IV surveys (see §9). The default value\noffolding_thresholdis indicated by the dotted line.\nThe FFTs for computing convolutions in DFT rendering nor-\nmally constitute the bulk of the calculation time. For these, we\nuse the excellentFFTW package (Frigo & Johnson, 2005). The\ncalculations are fastest when the image size is either an exact\npower of 2, or 3 times a power of 2, so GAL SIM pads the im-\nages to meet this criterion before performing the FFT. Aside\nfrom this consideration, we only use as large an FFT image as\nis required to achieve the desired accuracy. This balance isone\nof the principal speed/accuracy tradeoffs discussed in §6.4.\nFor some DFT calculations, we can avoid the two-\ndimensional FFT entirely by turning it into a one-dimensional\nHankel transform. This is possible when the proﬁle being trans-\nformed is radially symmetric, as are many of the analytic pro-\nﬁles. Iff(r,θ) = f(r), then the Fourier transform is similarly\nradially symmetric:\n˜\nf(k)=\n∫∞\n0\nrdr\n∫2π\n0\nf(r,θ)eikrcos(θ) dθ (78)\n= 2π\n∫∞\n0\nf(r)J0(kr)rdr (79)\nThis optimization is particularly effective for Sérsic proﬁles.\nThe large dynamic range of these proﬁles, especially forn >3,\nmeans that a two-dimensional FFT would require a very large\nimage to achieve the appropriate accuracy. It is signiﬁcantly\nfaster to precompute the one-dimensional Hankel transform\n˜\nf(k), and use that to ﬁll in thek-space values.\nThe integration package in GAL SIM uses an efﬁcient, adap-\ntive Gauss-Kronrod-Patterson algorithm (Patterson, 1968). It\nstarts with the 10-point Gaussian quadrature abscissae andcon-\ntinues adding points at optimally spaced additional locations\n28\nuntil it either converges or reaches 175 points. If the integral\nhas not converged at that point, it splits the original region in\nhalf and tries again on each sub-region, continuing in this man-\nner until all regions have converged. This algorithm is usedin\nG AL SIM for Hankel transforms, real-space integration, cumu-\nlative probability integrals for photon shooting, calculating the\nhalf-light-radius of Sérsic proﬁles, and a few other placeswhere\nintegrations are required.\nMatrix calculations do not generally account for a large share\nof the running time, but to make these as efﬁcient as possible,\nwe use the TMV library30, which calls the system BLAS library\nwhen appropriate if such a system library is available (revert-\ning to native code otherwise). The matrix calculations are thus\nabout as efﬁcient as can be expected on a given platform.\nOne calculation required us to devise our own efﬁcient func-\ntion evaluation. For interpolated images using the Lanczosin-\nterpolant, Fourier-space calculations require evaluation of the\nSine integral:\nSi(x)=\n∫x\n0\nsint\nt dt (80)\nThe standard formulae from Abramowitz & Stegun (1964) §5.2\nfor computing this efﬁciently were only accurate to about 10−6.\nThis was not accurate enough for our needs, and we could\nnot ﬁnd any other source for a more accurate calculation. We\ntherefore developed our own formulae for efﬁciently evalu-\nating Si(x), accurate to 10−16. The formulae are given in\nAppendix B.\n10.2. Parallelization\nAnother important optimization happens in the Python layer.\nWhen running GAL SIM using a conﬁguration ﬁle, rather than\nwriting Python code, it is very easy to get the code to run using\nmultiple processes using the conﬁguration parameternproc.\nOf course, experienced Python programmers can also do this\nmanually, but multiprocessing in Python is not extremely user\nfriendly, so it can be convenient to take advantage of this paral-\nlelism already being implemented in GAL SIM ’s conﬁguration\nﬁle parser.\n10.3. Timings\nThe time it takes for GAL SIM to render an image depends\non many details of the proﬁles and the image on which they are\nbeing rendered. Some proﬁles tend to take longer than others,\nand the size of the object relative to the pixel scale of the ﬁnal\nimage also matters.\nFor most analytic proﬁles, if the image scale is not much\nsmaller than the Nyquist scale of the object, rendering using\nthe DFT method will generally take of order 0.01 seconds or\nless per object. For very many purposes, this kind of proﬁle is\nperfectly appropriate, and it can include a reasonable amount of\ncomplication including multiple components to the galaxy such\na bulge plus disk model, offsets of those components, multi-\ncomponent PSFs, etc.\n30https://code.google.com/p/tmv-cpp/\nModels that include interpolated images take longer. This\nincludes models with anOpticalPSFcomponent or aRe-\nalGalaxy. Such proﬁles typically take of order 0.1 seconds\nper object for typical sizes of the interpolated images, butthe\ntime is highly dependent on the size of the image being used to\ndeﬁne the proﬁle.\nThe running time for photon shooting of course scales lin-\nearly with the number of photons. The crossover point where\nphoton shooting is faster than DFT rendering depends on the\nproﬁle being rendered, but it is typically in the range of 103–\n104 photons. So for faint objects, it can be signiﬁcantly faster\nto use the photon-shooting method.\n10.4. Potential speed pitfalls\nThere are a number of potential pitfalls that can lead to\nslower than normal rendering, which are worth highlighting:\n• Whitening.Proﬁles that use aRealGalaxycan be par-\nticularly slow if the resulting image is whitened (cf. §7.5)\nto remove the correlated noise that is present in the origi-\nnalHST images (and gets exacerbated by the PSF convolu-\ntion). The whitening step can increase the time per object\nto about 1 second, although it varies depending on details\nsuch as the ﬁnal pixel scale, what kind of PSF is used, etc.\n• Pixel size. Using a DFT to render images with very\nsmall pixels relative to the size of the galaxy can be very\nslow. The time required to perform the FFTs scales as\nO(N 2 logN ) whereN is the number of pixels across for\nthe image, so a moderate increase in the size of the galaxy\nrelative to the pixel scale can make a big difference in the\nrunning time.\n• Sérsic proﬁles with varying index.Sérsic galaxies require\npre-computation of some integrals for each Sérsic index\nused. When simulating manyn = 3.3 galaxies, the setup\ntime will be amortized over many galaxies and is thus ir-\nrelevant. When using a different indexn for each galaxy\nthough, the setup must be done for each galaxy, potentially\ndominating the running time. Thus, it is better to selectn\nfrom a list of a ﬁnite number of values rather than letting\nit varying continuously within some range.\n• Variable optical PSF parameters.The OpticalPSF\nclass similarly has a large setup cost to compute the\nFourier transform of the wavefront in the pupil plane. If\nthere is a single PSF for the image, this setup cost is\namortized over all the objects, but for a spatially variable\nPSF (which is more realistic), each object will require a\nnew setup calculation. The variable PSF branches of the\nGREAT3 challenge (Mandelbaum et al., 2014) were the\nmost time-consuming to generate for this reason.\n• Complicated wavelength dependence.Drawing chromatic\nobjects with complex SEDs through non-trivial band-\npasses can take quite a long time. The surface brightness\nproﬁle needs to be integrated over the relevant range of\n29\nwavelengths. The more complicated the SED and band-\npass are, the more samples are required to perform the in-\ntegration. Thus, depending on the purpose of the images\nbeing rendered, it may be advisable to use simple SEDs\nand/or bandpasses, instead of more realistic ones. Opti-\nmizations to this process for non-trivial chromatic objects\nare being incorporated into future versions of GAL SIM .\n10.5. Example output\nFigure 8 shows a portion of an image that can be produced\nby GAL SIM . This particular image is from a simulation that is\nintended to approximate an LSST focal plane.\nThe simulation has an object density of 70 objects per square\narcminute. The galaxies are bulge plus disk models, and the\nPSF includes both atmospheric seeing and an optical compo-\nnent with the appropriate obscuration for the LSST telescope,\nstruts, and plausible aberrations. 20% of the objects are stars.\nThe ﬂuxes of both the galaxies and the stars follow a power law\ndistribution, as does the size distribution of the galaxies, and\nthere is an applied cosmological lensing ﬁeld including both\nshear and magniﬁcation. The noise model includes both Gaus-\nsian read noise and Poisson noise on the counts of the detected\nelectrons.\nThe conﬁguration ﬁle to build this image31 is remarkably\nshort (just 122 lines), especially considering how many real-\nistic data features are included. This example showcases why\nwe consider the conﬁguration mode to be one of the strengths\nof GAL SIM . Even for users who are already comfortable writ-\ning Python code, the conﬁguration ﬁles can be easier to set up\nand get running in many cases.\nEach 4K×4K chip in this simulation takes about 3 minutes to\nrender on a modern laptop using a single core. The simulation\nis set to use as many processors as are available, and with 8\ncores running at once, the whole ﬁeld of view (189 chips in all)\ncan be rendered in a bit more than an hour.\nCurrently GAL SIM is unable to simulate many of the features\nof real images including saturation, bleeding, vignetting, cos-\nmic rays, and the like (cf. §11), so those features are not shown\nhere. For this image, we also chose to cut off the size distribu-\ntion at 20 arcsec to avoid the rare objects that would requirean\nextremely large FFT.\nDespite these apparent shortcomings, this kind of image is\nstill very useful for studying image processing algorithms. In-\ndeed, it is often helpful to intentionally make these and other\nsimpliﬁcations to study the behavior of a particular algorithm.\nImages similar to the one shown in Figure 8 have been used\nto study the effects of blending, star-galaxy separation algo-\nrithms, and shear estimation. For these and many other inves-\ntigations, complete realism of the simulated images is not re-\nquired.\n11. Effects not in GAL SIM\nIt is worth mentioning some of the many physical effects in\noptical and near-infrared astronomical observations thatG AL -\n31 Available publicly athttp://ls.st/xj0.\nSIM cannot yet model. Many of these effects will be important\nto model and explore to help ensure that accurate measurements\nwill be possible from future extragalactic survey data:\n• Physical atmospheric PSF models.Examples of public\nsoftware that can be used to generate physically motivated,\nmulti-layer phase screen models of atmospheric PSFs in-\nclude ARROYO 32, and the LSST IM SIM 33 software (Pe-\nterson et al. in prep.). While the possibility of adding\nsuch an atmospheric PSF module to GAL SIM was investi-\ngated as part of preparatory work for the GREAT3 project\n(Mandelbaum et al., 2014), this functionality is still lack-\ning.\n• Non-linear detector effects. G AL SIM cannot yet model\npixel saturation or bleeding (e.g. Bertin, 2009), interpixel\ncapacitance (e.g. Moore et al., 2004) and other forms of\ncross-talk, all of which affect image ﬂux and shape deter-\nmination.\n• Image artifacts such as ghosts, detector persistence.\nThese effects (e.g. Wynne et al., 1984; Meng et al., 2013;\nLong et al., 2010; Barrick, Ward, & Cuillandre, 2012;\nAnderson et al., 2014) can be difﬁcult to model, or even\nclassify and remove, when measuring the properties of\nastronomical objects in an object-by-object fashion (the\ncurrent standard procedure34). Simulating observations\nwith these effects will therefore be important to be able\nto demonstrate reliable measurements in their presence.\n• Cosmic rays. Simulations of these effects (such as, e.g.,\nRolland et al., 2008) are likely to be an important consid-\neration for imaging in upcoming Stage IV surveys, par-\nticularly for space missions at the second Lagrange point\n(e.g. Barth, Isaacs, & Poivey, 2000).\n• Near ﬁeld contaminants such as satellite trails and mete-\nors.These effects, of relevance to ground-based imaging,\nare not currently supported by GAL SIM . Like cosmic rays\nand instrumental artifacts such as ghosts and persistence,\nthese effects will place stringent demands on object clas-\nsiﬁcation procedures for upcoming survey experiments.\n• Flexion. Although trivially described using a photon-\nshooting approach, simulations of non-afﬁne image trans-\nformations such as weak gravitational ﬂexion are incom-\npatible with the Fourier space rendering of individual pro-\nﬁles described in §6. Flexion is not currently implemented\nin GAL SIM . However, the GAL FLEX 35 package is a stan-\ndalone, open-source Python module that can be integrated\nwith GAL SIM via a NUM PY array interface.\n• Vignetting, variable quantum efﬁciency, and ﬂat ﬁelding\neffects.No variation in the efﬁciency of photon detection\n32http://cfao.ucolick.org/software/arroyo.php\n33http://lsst.astro.washington.edu/\n34Although seehttp://thetractor.org/\n35http://physics.drexel.edu/~jbird/galflex/\n30\nFigure 8: A portion of a GAL SIM simulation of an LSST focal plane. This section is about 5 arcminutes across with a number density of 70 objects per square\narcmin, of which 80% are galaxies and 20% are stars.\nas a function of position in the output image is currently\nincluded in GAL SIM , including variation within pixels. It\nwill be possible to address large scale effects in a relatively\nstraightforward post-processing step. However, signiﬁcant\nintra-pixel quantum efﬁciency variation may require care-\nful design to render efﬁciently.\n• Complicated WCS functions.Recent studies of the DE-\nCam and LSST detectors (Plazas et al., 2014; Rasmussen,\n2014) have revealed complicated astrometric shifts, in-\ncluding edge distortions and tree-rings. These are not cur-\nrently modeled by any existing WCS package, so it would\nrequire a custom implementation to include these effects\nin GAL SIM .\nMany further possibilities for expanding and improving\nG AL SIM capabilities can be found in already existing func-\ntionality. TheOpticalPSFclass described in §3.2.2 could\nbe extended to a more general treatment of optical wavefronts\nby allowing an arbitrary number of Zernike coefﬁcients to be\nspeciﬁed on input. Support for photon shooting ofShapelet\nobjects (see §3.3.2), although a considerable task, would also\nbe a valuable addition to GAL SIM . It is hoped that, through the\nopen and collaborative development pattern already established\nwithin the GAL SIM project, many of these capabilities will be\nadded to GAL SIM in the future.\n12. Conclusions\nWe have described GAL SIM : the modular galaxy image sim-\nulation toolkit. A primary motivation for the project was the de-\nsire for an open, transparent, and community-maintained stan-\ndard toolkit for high precision simulations of the deep extra-\ngalactic imaging expected in upcoming Stage III and Stage IV\nsurveys. We have described the range of physical models cho-\nsen as the basis for describing astronomical objects in GAL -\nSIM , and the support for their description in a range of world\ncoordinate systems. We have also described the mathematical\nprinciples used in the multiple strategies supported by GAL SIM\nfor rendering these models onto images, and for adding noise.\nA number of the techniques employed by GAL SIM are novel,\nincluding the photon shooting of a range of proﬁles includ-\ningInterpolatedImageobjects (see §6.3.3) and noise\nwhitening (§7.5). The consistent handling of astronomicalob-\nject transformation and rendering under a variety of WCS trans-\nformations, described in §5, is also new in the ﬁeld of astronom-\nical image simulation. GAL SIM is unique in bringing all these\nfeatures together under a simple, highly ﬂexible, class library\ninterface.\nAn important part of any software project is testing and val-\nidation. The provision of multiple parallel methods for ren-\ndering images (see §6), a capability unique to GAL SIM among\ncomparable simulation packages, played a vitally important\nrole in this process.\nIn §9 we showed results from a number of tests demonstrat-\ning that GAL SIM output can describe weak lensing transforma-\ntions such as shear and magniﬁcation at the level of accuracyre-\nquired for Stage IV surveys such asEuclid,LSST and WFIRST-\nAFTA . This was demonstrated for highly challenging analytic\nproﬁles (theSersicclass, see §9.1), for surface brightness\nproﬁles derived from images such as theInterpolatedIm-\nageand RealGalaxyclasses (see §9.2), and for the recon-\nvolution algorithm (see §9.3).\nThe accuracy of rendering results can be tuned using input\nparameters, and using theGSParamsstructure described in\n§6.4. Less stringent requirements will yield faster execution,\nbut at the cost of lowering rendering accuracy in output im-\nages. As no set of validation tests can completely cover all us-\n31\nage scenarios, the tests of §9 should be modiﬁed by users of the\nG AL SIM software to tailor them to each application’s speciﬁc\nrequirements.\nAs discussed in §11, there are a number of important effects\nthat GAL SIM cannot yet simulate, but that may signiﬁcantly\nimpact data analysis for upcoming surveys. Work is expected\nto continue in these interesting areas: while the development\nand support of GAL SIM began in early 2012, it is an ongoing\nproject that continues to build on increasing numbers of users\n(and developers).\nAs well as being used to generate the images for the GREAT3\nchallenge (Mandelbaum et al., 2014), GAL SIM now provides\na considerable open-source toolkit for the simulation of extra-\ngalactic survey images. Having been shown to meet demanding\ntolerances on rendering accuracy in a number of tests, GAL SIM\nsimulations can be used as a benchmark for development or\ncommon reference point for code comparison. It also provides\nan accessible, well-documented reference codebase. GAL SIM\nis easily extended, or can be used simply as a class library in\nthe development of further astronomical image analysis appli-\ncations. In these respects GAL SIM achieves its primary aims,\nand will become an increasingly powerful toolkit for astronom-\nical image simulation following development that is planned for\nthe near future.\nAcknowledgments\nWe wish to thank the two anonymous referees whose insight-\nful comments signiﬁcantly improved the paper. This project\nwas supported in part by NASA via the Strategic University\nResearch Partnership (SURP) Program of the Jet Propulsion\nLaboratory, California Institute of Technology. Part of BR’s\nwork was done at the Jet Propulsion Laboratory, California In-\nstitute of Technology, under contract with NASA. BR, JZ and\nTK acknowledge support from a European Research Council\nStarting Grant with number 240672. MJ acknowledges support\nfrom NSF award AST-1138729. RM was supported in part by\nprogram HST-AR-12857.01-A, provided by NASA through a\ngrant from the Space Telescope Science Institute, which is oper-\nated by the Association of Universities for Research in Astron-\nomy, Incorporated, under NASA contract NAS5-26555; and in\npart by a Sloan Fellowship. HM acknowledges support from\nJapan Society for the Promotion of Science (JSPS) Postdoc-\ntoral Fellowships for Research Abroad and JSPS Research Fel-\nlowships for Young Scientists. PM is supported by the U.S. De-\npartment of Energy under Contract No. DE- FG02-91ER40690.\nThe authors acknowledge the use of the UCL Legion High Per-\nformance Computing Facility (Legion@UCL), and associated\nsupport services, in the completion of this work. This work\nwas supported in part by the National Science Foundation un-\nder Grant No. PHYS-1066293 and the hospitality of the Aspen\nCenter for Physics.\n32\nAppendix A. Conventions in the lensing engine\nAppendix A.1. Grid parameters\nAll calculations in the GAL SIM lensing engine (see §4) approximate real continuous functions using a discrete, ﬁnite grid. The\nreal-space grid is deﬁned by\nL = length of grid along one dimension (angular units) (A.1)\nd = spacing between grid points (angular units) (A.2)\nN = number of grid points along one dimension= L/d. (A.3)\nThere is a comparable grid in Fourier-space (i.e., sameN ). Given the parameters of the real-space grid, thekmin along one dimension\nis 2π/L, so we can think of this quantity as the grid spacing in Fourier space, i.e.,kmin = ∆k. This value ofkmin corresponds to a\nFourier mode that exactly ﬁts inside of our square grid (in one dimension). Thek range, again in one dimension, is fromk1 = −π/d\ntoπ/d, i.e.,|k1| < kmax = π/d. This corresponds to a mode that is sampled exactly twice (the minimum possible) given our choice\nof grid spacing. For the two-dimensional grid, the maximum value of|k| is then\n√\n2π/d.\nAppendix A.2. Fourier transform properties\nThe convention for the Fourier transform deﬁned by equations (34) & (35) is adopted throughout, as this is the form typically\nused for describing the statistics of cosmological shear and matter ﬁelds. Unlike the convention typically used in computing and\nsignals processing, and in the standard deﬁnition of the Discrete Fourier Transform (DFT), this convention is non-unitary and uses\nan angular (rather than normal) frequency in the exponent36. This introduces some additional factors of 2πinto standard results,\nand so here we re-express these results using the non-unitary, angular frequency convention.\nIt can be readily shown that if we deﬁneg(xL)≡ f(x), the following well-known identity holds:\nF{g(xL)} = 1\nL˜g\n( k\nL\n)\n. (A.4)\nIf we further deﬁnes(h + x)≡ g(x) then it is straightforward to show that\nF{s(h + x)} = eikh˜s(k). (A.5)\nThere is an additional factor of 2πin the exponent when this property of Fourier transforms is expressed using the normal (rather\nthan angular) frequency convention.\nThe most important result for approximating continuous functions using DFTs is the Poisson summation formula, which under\nthe conventions of equations (34) & (35) may be stated as\n∞∑\nn=−∞\nf(n)=\n∞∑\nq=−∞\n˜f(2πq) (A.6)\nfor integersn and q. It should be noted that in the normal frequency, unitary transform convention form of the Poisson summation\nformula the 2πwithin˜\nf(2πq) is absent. Using equations (A.4) & (A.5) we arrive at the following useful expression of the Poisson\nsummation formula:\n∞∑\nn=−∞\nf(nL + x)= 1L\n∞∑\nq=−∞\n˜\nf\n( 2πqL\n)\nei2πxq/L . (A.7)\nBy substituting∆k ≡ kmin = 2π/L we write this as\n∞∑\nn=−∞\nf\n( 2πn\n∆k + x\n)\n=\n( ∆k\n2π\n) ∞∑\nq=−∞\n˜f(q∆k)eix∆kq. (A.8)\n36For a discussion of transform conventions seehttp://en.wikipedia.org/wiki/Fourier_transform#Other_conventions\n33\nAppendix A.3. Fourier transform of discrete samples of the power spectrum\nLet us deﬁne the following dimensionless function, which takes samples from a power spectrum:\nP∆k[q,p]≡ (∆k)2P(q∆k,p∆k). (A.9)\nWe will use square brackets to denote functions with discrete, integer input variables, as here. We will also usen,m for integer\nindices in real space summations, andq,p in Fourier space. It can then be shown that\nF−1\n\uf8f1\n\uf8f4\n\uf8f4\n\uf8f2\n\uf8f4\n\uf8f4\n\uf8f3\n∞∑\nq,p=−∞\nδ(k1 −q∆k)δ(k2 − p∆k)P∆k[q,p]\n\uf8fc\n\uf8f4\n\uf8f4\n\uf8fd\n\uf8f4\n\uf8f4\n\uf8fe=\n∞∑\nn,m =−∞\nξ+\n(\nθ1 − 2πn\n∆k ,θ2 − 2πm\n∆k\n)\n, (A.10)\nwhere we have used the Fourier series expression for the Dirac comb function, and the convolution theorem. We note that this\nexpression is still continuous, but describes an inﬁnite, periodic summation (of periodL = 2π/∆k) of copies of the correlation\nfunctionξ+. For sufﬁciently small∆k, these copies may be spaced sufﬁciently widely in the real domain to be able to learn much\naboutξ+(θ1,θ2) in the non-overlapping regions. We therefore deﬁne this function as\nξ2π\n∆k\n(θ1,θ2)≡\n∞∑\nn=−∞\nξ+\n(\nθ1 − 2πn\n∆k ,θ2 − 2πm\n∆k\n)\n. (A.11)\nUsing the expression of the Poisson summation formula in equation (A.8), we can also write\nξ2π\n∆k\n(θ1,θ2)=\n∞∑\nq,p=−∞\n( ∆k\n2π\n) 2\nP(q∆k,p∆k)ei∆k(θ1q+θ2 p) = 1\n(2π)2\n∞∑\nq,p=−∞\nP∆k[q,p]ei∆k(θ1q+θ2 p), (A.12)\nThis is in fact an expression for the inverse of the Discrete Time Fourier Transform (DTFT), although this result is normally derived\nusing unitary conventions for the transform pair.\nThe expression in equation (A.12) is periodic with period 2π/∆k = L. All of the information it contains aboutξ+(θ1,θ2) is\ntherefore also contained in one period of the function only.For approximating this information discretely, as desiredin numerical\nanalysis, we can imagine takingN equally spaced samples of the function in equation (A.12) along a single periodL in each\ndimension. These samples are therefore separated by∆θ= 2π/∆kN = d in real space, and we deﬁne the sampled function itself as\nξ∆θ[n,m ]≡ ξ2π\n∆k\n(n∆θ,m ∆θ)= 1\n(2π)2\n∞∑\nq,p=−∞\nP∆k[q,p]ei2π(qn+pm )/N , (A.13)\nfor the integer indicesn,m = 0,1,..., N −1, by substitution into equation (A.12). Using the periodicity of the exponential term in\nthe expression above, this may be written as\nξ∆θ[n,m ]= 1\n(2π)2\nN −1∑\nq,p=0\nP N [q,p]ei2π(qn+pm )/N (A.14)\nwhere we have deﬁned\nP N [q,p]≡\n∞∑\ni,j=−∞\nP∆k[q −iN,p − jN]. (A.15)\nNeedless to say, in order to be able to calculate the values ofP N [q,p] in practice we must also truncate theP∆k sequence to be ﬁnite\nin length. Averycommon choice is to use the same numberN of samples in both real and Fourier space. Choosing to use only N\nsamples fromP∆k then gives\nξ∆θ[n,m ]= 1\n(2π)2\nN −1∑\nq,p=0\nP∆k[q,p]ei2π(qn+pm )/N\n= 1\nN 2 (∆θ)2\nN −1∑\nq,p=0\nP(q∆k,p∆k)ei2π(qn+pm )/N . (A.16)\nFor greater detail regarding this calculation, please see the lensing engine document in the GAL SIM repository.37\n37https://github.com/GalSim-developers/GalSim/blob/master/devel/modules/lensing_engine.pdf\n34\nThe relationship in equation (A.16) is in fact the inverse Discrete Fourier Transform for our non-unitary convention. The more\nusual deﬁnition of the inverse DFT, and that adopted by many DFT implementations (including the NUM PY package in Python), is\nf[n,m ]= numpy.fft.ifft2\n( ˜\nf[p,q]\n)\n≡ 1N 2\nN −1∑\nq,p=0\n˜\nf[q,p]ei2π(qn+pm )/N (N UM PY convention). (A.17)\n(The factor of 1/N 2 here is often found in conventions for the inverse DFT, and ensures that the DFT followed by the inverse DFT\nyields the original, input array.) The Fast Fourier Transform algorithm allows the DFT to be calculated very efﬁciently.\nAppendix A.4. Generating Gaussian ﬁelds\nUsing equation (A.16) we see how to construct a realization of a Gaussian random lensing ﬁeld on a grid, with an ensemble\naverage power spectrum that is approximatelyP(k). We create the following complex, 2D array of dimensionN in Fourier space:\n˜κ[p,q]=˜κE [p,q]+i˜κB [p,q], (A.18)\nwhere˜κE is deﬁned in terms of the desired E-mode power spectrumP E as\n˜κE [p,q]= 1N ∆θ\n√\nP E (p∆k,q∆k)\n2 {N(0,1)+iN(0,1)}, (A.19)\nand likewise for˜κB . HereN(0,1) denotes a standard Gaussian random deviate drawn independently at each [p,q] array location.\nThis complex-valued Fourier-space convergence can be usedto construct the Fourier-space shear ﬁeld via38\n˜g = e2iψ˜κ, (A.20)\nwhere e2iψ is the phase of thek vector deﬁned ask = ∆k(p +iq). It can be seen that⟨˜g[p,q]˜g∗[p′,q′]⟩= δp′\np δq′\nq P(|k|)/(N ∆θ)2 where\n|k| = ∆k\n√\np2 +q2. Taking the inverse DFT of˜g provides the realization of the Gaussian lensing ﬁeldg[n,m ] on a grid in real space,\nwhere the real (imaginary) parts ofg[n,m ] correspond to the ﬁrst (second) shear components. From equation (A.16),g[n,m ] will\nbe correctly scaled to have discrete correlation functionξ∆θ[n,m ] by construction.\nAppendix B. Efﬁcient evaluation of the Sine and Cosine integrals\nThe trigonometric integrals are deﬁned as\nSi(x)=\n∫x\n0\nsint\nt dt= π\n2 −\n∫∞\nx\nsint\nt dt (B.1)\nCi(x)= γ+lnx +\n∫x\n0\ncost−1\nt dt= −\n∫∞\nx\ncost\nt dt (B.2)\nwhere γis the Euler-Mascheroni constant. In GAL SIM , calculations involving Lanczos interpolants require an efﬁcient calculation\nof Si(x). As we were unable to ﬁnd a source for an efﬁcient calculation that was suitably accurate, we developed our own, which\nwe present here. We do not use Ci(x) anywhere in the code, but for completeness, we provide a similarly efﬁcient and accurate\ncalculation of it as well.\nFor small arguments, we use Padé approximants of the convergent Taylor series\nSi(x)=\n∞∑\nn=0\n(−1)nx2n+1\n(2n +1)(2n +1)! (B.3)\nCi(x)= γ+lnx +\n∞∑\nn=1\n(−1)nx2n\n2n(2n)! (B.4)\n38See, for example, Kaiser & Squires (1993), but note that there is a sign error in equation 2.1.12 in that paper that is corrected in equation 2.1.15.\n35\nUsing the Maple software package39, we derived the following formulae, which are accurate to better than 10−16 for 0≤ x ≤ 4:\nSi(x)= x ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 −4.54393409816329991 ·10−2 · x2 +1.15457225751016682 ·10−3 · x4\n−1.41018536821330254 ·10−5 · x6 +9.43280809438713025 ·10−8 · x8\n−3.53201978997168357 ·10−10 · x10 +7.08240282274875911 ·10−13 · x12\n−6.05338212010422477 ·10−16 · x14\n1 +1.01162145739225565 ·10−2 · x2 +4.99175116169755106 ·10−5 · x4\n+1.55654986308745614 ·10−7 · x6 +3.28067571055789734 ·10−10 · x8\n+4.5049097575386581 ·10−13 · x10 +3.21107051193712168 ·10−16 · x12\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.5)\nCi(x)= γ+ln(x)+\nx2 ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n−0.25 +7.51851524438898291 ·10−3 · x2 −1.27528342240267686 ·10−4 · x4\n+1.05297363846239184 ·10−6 · x6 −4.68889508144848019 ·10−9 · x8\n+1.06480802891189243 ·10−11 · x10 −9.93728488857585407 ·10−15 · x12\n1 +1.1592605689110735 ·10−2 · x2 +6.72126800814254432 ·10−5 · x4\n+2.55533277086129636 ·10−7 · x6 +6.97071295760958946 ·10−10 · x8\n+1.38536352772778619 ·10−12 · x10 +1.89106054713059759 ·10−15 · x12\n+1.39759616731376855 ·10−18 · x14\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.6)\nFor x >4, one can use the helper functions:\nf(x)≡\n∫∞\n0\nsin(t)\nt+ x dt=\n∫∞\n0\ne−xt\nt2 +1 dt= Ci(x) sin(x)+\n( π\n2 −Si(x)\n)\ncos(x) (B.7)\ng(x)≡\n∫∞\n0\ncos(t)\nt+ x dt=\n∫∞\n0\nt e−xt\nt2 +1dt= −Ci(x) cos(x)+\n( π\n2 −Si(x)\n)\nsin(x) (B.8)\nusing which, the trigonometric integrals may be expressed as\nSi(x)= π\n2 − f(x) cos(x)−g(x) sin(x) (B.9)\nCi(x)= f(x) sin(x)−g(x) cos(x) (B.10)\nIn the limit asx → ∞, f(x) → 1/x and g(x) → 1/x2. Thus, we can use Chebyshev-Padé expansions of1√y f\n(\n1√y\n)\nand 1\ny g\n(\n1√y\n)\nin the interval 0..1\n42 to obtain the following approximants, good to better than 10−16 forx ≥ 4:\nf(x)= 1\nx ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 +7.44437068161936700618 ·102 · x−2 +1.96396372895146869801 ·105 · x−4\n+2.37750310125431834034 ·107 · x−6 +1.43073403821274636888 ·109 · x−8\n+4.33736238870432522765 ·1010 · x−10 +6.40533830574022022911 ·1011 · x−12\n+4.20968180571076940208 ·1012 · x−14 +1.00795182980368574617 ·1013 · x−16\n+4.94816688199951963482 ·1012 · x−18 −4.94701168645415959931 ·1011 · x−20\n1 +7.46437068161927678031 ·102 · x−2 +1.97865247031583951450 ·105 · x−4\n+2.41535670165126845144 ·107 · x−6 +1.47478952192985464958 ·109 · x−8\n+4.58595115847765779830 ·1010 · x−10 +7.08501308149515401563 ·1011 · x−12\n+5.06084464593475076774 ·1012 · x−14 +1.43468549171581016479 ·1013 · x−16\n+1.11535493509914254097 ·1013 · x−18\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.11)\ng(x)= 1\nx2 ·\n\uf8eb\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ec\n\uf8ed\n1 +8.1359520115168615 ·102 · x−2 +2.35239181626478200 ·105 · x−4\n+3.12557570795778731 ·107 · x−6 +2.06297595146763354 ·109 · x−8\n+6.83052205423625007 ·1010 · x−10 +1.09049528450362786 ·1012 · x−12\n+7.57664583257834349 ·1012 · x−14 +1.81004487464664575 ·1013 · x−16\n+6.43291613143049485 ·1012 · x−18 −1.36517137670871689 ·1012 · x−20\n1 +8.19595201151451564 ·102 · x−2 +2.40036752835578777 ·105 · x−4\n+3.26026661647090822 ·107 · x−6 +2.23355543278099360 ·109 · x−8\n+7.87465017341829930 ·1010 · x−10 +1.39866710696414565 ·1012 · x−12\n+1.17164723371736605 ·1013 · x−14 +4.01839087307656620 ·1013 · x−16\n+3.99653257887490811 ·1013 · x−18\n\uf8f6\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f7\n\uf8f8\n(B.12)\n39http://www.maplesoft.com/\n36\nThus we can calculate Si(x) to double precision accuracy for any value ofx. In GAL SIM , all of the above polynomials are\nimplemented using Horner’s rule, so they are very efﬁcient to evaluate.\nReferences\nAbazajian, K. N., Adelman-McCarthy, J. K., Agüeros, M. A., et al. 2009, ApJS, 182, 543\nAbramowitz, M., & Stegun, I. 1964, Handbook of MathematicalFunctions, 5th edn. (New York: Dover)\nAiry, G. B. 1835, Transactions of the Cambridge Philosophical Society, 5, 283\nAlbrecht, A., Bernstein, G., Cahn, R., et al. 2006, ArXiv Astrophysics e-prints, astro-ph/0609591\nAmara, A., & Réfrégier, A. 2008, MNRAS, 391, 228\nAnderson, R. E., Regan, M., Valenti, J., & Bergeron, E. 2014,ArXiv e-prints, arXiv:1402.4181\nAntilogus, P., Astier, P., Doherty, P., Guyonnet, A., & Regnault, N. 2014, Journal of Instrumentation, 9, C3048\nBacon, D. J., Goldberg, D. M., Rowe, B. T. P., & Taylor, A. N. 2006, MNRAS, 365, 414\nBarrick, G. A., Ward, J., & Cuillandre, J.-C. 2012, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 8453, High Energy,\nOptical, and Infrared Detectors for Astronomy V , article id. 84531K, 8 pp.\nBartelmann, M. 1996, A&A, 313, 697\n—. 2010, Classical and Quantum Gravity, 27, 233001\nBarth, J., Isaacs, J., & Poivey, C. 2000, The Radiation Environment for the Next Generation Space Telescope, Tech. rep.\nBecker, M. R. 2013, MNRAS, 435, 115\nBernstein, G. M. 2010, MNRAS, 406, 2793\nBernstein, G. M., & Armstrong, R. 2014, MNRAS, 438, 1880\nBernstein, G. M., & Gruen, D. 2014, PASP, 126, 287\nBernstein, G. M., & Jarvis, M. 2002, AJ, 123, 583\nBertin, E. 2009, Mem. Societa Astronomica Italiana, 80, 422\nBorn, M., & Wolf, E. 1999, Principles of Optics\nBridle, S., Shawe-Taylor, J., Amara, A., et al. 2009, Annalsof Applied Statistics, 3, 6\nBridle, S., Balan, S. T., Bethge, M., et al. 2010, MNRAS, 405,2044\nCalabretta, M. R., & Greisen, E. W. 2002, A&A, 395, 1077\nCasertano, S., de Mello, D., Dickinson, M., et al. 2000, AJ, 120, 2747\nCiotti, L., & Bertin, G. 1999, A&A, 352, 447\nCropper, M., Hoekstra, H., Kitching, T., et al. 2013, MNRAS,431, 3103\nCypriano, E. S., Amara, A., V oigt, L. M., et al. 2010, MNRAS, 405, 494\nde Jong, J. T. A., Verdoes Kleijn, G. A., Kuijken, K. H., & Valentijn, E. A. 2013, Experimental Astronomy, 35, 25\nde Vaucouleurs, G. 1948, Annales d’Astrophysique, 11, 247\n—. 1959, AJ, 64, 397\nDuncan, C. A. J., Joachimi, B., Heavens, A. F., Heymans, C., &Hildebrandt, H. 2014, MNRAS, 437, 2471\nFried, D. L. 1966, Journal of the Optical Society of America (1917-1983), 56, 1372\nFrigo, M., & Johnson, S. G. 2005, Proceedings of the IEEE, 93,216, special issue on “Program Generation, Optimization, and Platform Adaptation”\nFruchter, A. S., & Hook, R. N. 2002, PASP, 114, 144\nGoldberg, D. M., & Bacon, D. J. 2005, ApJ, 619, 741\nHeymans, C., Van Waerbeke, L., Bacon, D., et al. 2006, MNRAS,368, 1323\nHeymans, C., Van Waerbeke, L., Miller, L., et al. 2012, MNRAS, 427, 146\nHirata, C., & Seljak, U. 2003, MNRAS, 343, 459\nHirata, C. M., Mandelbaum, R., Seljak, U., et al. 2004, MNRAS, 353, 529\nHogg, D. W., & Lang, D. 2013, PASP, 125, 719\nHuterer, D. 2010, General Relativity and Gravitation, 42, 2177\nHuterer, D., Takada, M., Bernstein, G., & Jain, B. 2006, MNRAS, 366, 101\nIrwin, J., & Shmakova, M. 2005, New Astron. Rev., 49, 83\nJohnson, N., Kemp, A., & Kotz, S. 2005, Univariate Discrete Distributions, Wiley Series in Probability and Statistics (Hoboken, New Jersey: John Wiley & Sons)\nKacprzak, T., Bridle, S., Rowe, B., et al. 2014, MNRAS, 441, 2528\nKacprzak, T., Zuntz, J., Rowe, B., et al. 2012, MNRAS, 427, 2711\nKaiser, N. 2000, ApJ, 537, 555\nKaiser, N., & Squires, G. 1993, ApJ, 404, 441\nKaiser, N., Squires, G., & Broadhurst, T. 1995, ApJ, 449, 460\nKitching, T. D., Balan, S. T., Bridle, S., et al. 2012, MNRAS,423, 3163\nKitching, T. D., Rowe, B., Gill, M., et al. 2013, ApJS, 205, 12\nKoekemoer, A. M., Fruchter, A. S., Hook, R. N., & Hack, W. 2003, in HST Calibration Workshop : Hubble after the Installation of the ACS and the NICMOS\nCooling System, ed. S. Arribas, A. Koekemoer, & B. Whitmore,337\nKoekemoer, A. M., Aussel, H., Calzetti, D., et al. 2007, ApJS, 172, 196\nLackner, C. N., & Gunn, J. E. 2012, MNRAS, 421, 2277\nLauer, T. R. 1999, PASP, 111, 227\nLaureijs, R., Amiaux, J., Arduini, S., et al. 2011, ArXiv e-prints, arXiv:1110.3193\nLeauthaud, A., Massey, R., Kneib, J.-P., et al. 2007, ApJS, 172, 219\nLong, K. S., Bagett, S. M., Deustua, S., & Riess, A. 2010, in 2010 Space Telescope Science Institute Calibration Workshop- Hubble after SM4.\nPreparing JWST, held 21-23 July 2010 at Space Telescope Science Institute. Edited by Susana Deustua and Cristina Oliveira. Published online at\nhttp://www.stsci.edu/institute/conference/cal10/proceedings, p.26\nLuppino, G. A., & Kaiser, N. 1997, ApJ, 475, 20\nMakinson, D. 2012, Sets, Logic and Maths for Computing, Undergraduate Topics in Computer Science (London: Springer-Verlag)\nMandelbaum, R., Hirata, C. M., Leauthaud, A., Massey, R. J.,& Rhodes, J. 2012, MNRAS, 420, 1518\nMandelbaum, R., Hirata, C. M., Seljak, U., et al. 2005, MNRAS, 361, 1287\n37\nMandelbaum, R., Rowe, B., Bosch, J., et al. 2014, ApJS, 212, 5\nMassey, R., & Refregier, A. 2005, MNRAS, 363, 197\nMassey, R., Stoughton, C., Leauthaud, A., et al. 2010, MNRAS, 401, 371\nMassey, R., Heymans, C., Bergé, J., et al. 2007, MNRAS, 376, 13\nMassey, R., Hoekstra, H., Kitching, T., et al. 2013, MNRAS, 429, 661\nMelchior, P., Böhnert, A., Lombardi, M., & Bartelmann, M. 2010, A&A, 510, A75\nMelchior, P., & Viola, M. 2012, MNRAS, 424, 2757\nMeng, Z., Zhou, X., Zhang, H., et al. 2013, PASP, 125, 1015\nMeyers, J. E., & Burchat, P. R. 2014, Journal of Instrumentation, 9, C3037\nMiyazaki, S., Komiyama, Y ., Nakaya, H., et al. 2012, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 8446, Society of\nPhoto-Optical Instrumentation Engineers (SPIE) Conference Series\nMoffat, A. F. J. 1969, A&A, 3, 455\nMoore, A. C., Ninkov, Z., & Forrest, W. J. 2004, in Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series, V ol. 5167, Focal Plane Arrays\nfor Space Telescopes, ed. T. J. Grycewicz & C. R. McCreight, 204–215\nNakajima, R., & Bernstein, G. 2007, AJ, 133, 1763\nNavarro, J. F., Frenk, C. S., & White, S. D. M. 1996, ApJ, 462, 563\nNoll, R. J. 1976, Journal of the Optical Society of America (1917-1983), 66, 207\nPatterson, F. S. 1940, Harvard College Observatory Bulletin, 914, 9\nPatterson, T. 1968, Mathematics of Computation, 22, 847\nPeacock, J. A., Schneider, P., Efstathiou, G., et al. 2006, ESA-ESO Working Group on “Fundamental Cosmology”, Tech. rep., arXiv:0610906\nPence, W. D., Chiappetti, L., Page, C. G., Shaw, R. A., & Stobie, E. 2010, A&A, 524, A42\nPlazas, A. A., & Bernstein, G. 2012, PASP, 124, 1113\nPlazas, A. A., Bernstein, G. M., & Sheldon, E. S. 2014, Journal of Instrumentation, 9, C4001\nPress, W. H., Teukolsky, S. A., Vetterling, W. T., & Flannery, B. P. 1992, Numerical recipes in C: The art of scientiﬁc computing, 2nd ed. (Cambridge: Cambridge\nUniversity Press)\nRacine, R. 1996, PASP, 108, 699\nRasmussen, A. 2014, Journal of Instrumentation, 9, C4027\nRefregier, A. 2003, MNRAS, 338, 35\nRefregier, A., Kacprzak, T., Amara, A., Bridle, S., & Rowe, B. 2012, MNRAS, 425, 1951\nReyes, R., Mandelbaum, R., Gunn, J. E., et al. 2012, MNRAS, 425, 2610\nRhodes, J., Leauthaud, A., Stoughton, C., et al. 2010, PASP,122, 439\nRolland, G., Pinheiro da Silva, L., Inguimbert, C., et al. 2008, Nuclear Science, IEEE Transactions on, 55, 2070\nRowe, B., Bacon, D., Massey, R., et al. 2013, MNRAS, 435, 822\nSánchez, E., et al. 2010, Journal of Physics Conference Series, 259, 012080\nSchmidt, F., Leauthaud, A., Massey, R., et al. 2012, ApJL, 744, L22\nSchneider, P. 2006, in Saas-Fee Advanced Course 33: Gravitational Lensing: Strong, Weak and Micro, ed. G. Meylan, P. Jetzer, P. North, P. Schneider, C. S.\nKochanek, & J. Wambsganss (Berlin: Springer), 269\nSchneider, P., van Waerbeke, L., & Mellier, Y . 2002, A&A, 389, 729\nScoville, N., Aussel, H., Brusa, M., et al. 2007, ApJS, 172, 1\nSemboloni, E., Hoekstra, H., Huang, Z., et al. 2013, MNRAS, 432, 2385\nSérsic, J. L. 1963, Boletin de la Asociacion Argentina de Astronomia La Plata Argentina, 6, 41\nSeshadri, S., Shapiro, C., Goodsall, T., et al. 2013, PASP, 125, 1065\nSheldon, E. S. 2014, MNRAS, 444, L25\nvan Waerbeke, L. 2010, MNRAS, 401, 2093\nVelander, M., Kuijken, K., & Schrabback, T. 2011, MNRAS, 412, 2665\nV oigt, L. M., & Bridle, S. L. 2010, MNRAS, 404, 458\nV oigt, L. M., Bridle, S. L., Amara, A., et al. 2012, MNRAS, 421, 1385\nWright, C. O., & Brainerd, T. G. 2000, ApJ, 534, 34\nWynne, C. G., Worswick, S. P., Lowne, C. M., & Jorden, P. R. 1984, The Observatory, 104, 23\nZernike, F. 1934, MNRAS, 94, 377\n38'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00010\n∆g1  (DFT - photon)'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00010\n∆g2  (DFT - photon)'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.1 0.2 0.3 0.4 0.5 0.6 0.7'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\n0.00001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00002\n0.00003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00004\n0.00005'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.00000\nMultiplicative slope mDFT'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0 7.5 8.0'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0001'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0002\n0.0003'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0000\n0.0002'), Document(metadata={'source': '/home/www/AgentFlow/agentflow/docs/GalsimToolkit.pdf'}, page_content='0.0004\nMultiplicative slope m reconv')], 'output_text': '# 项目技术概述文档\n\n## 1. 技术方法\n- **核心技术**：GAL SIM软件用于天文图像模拟，能够处理噪声和图像变换。\n- **算法**：采用噪声白化技术和傅里叶变换进行高精度图像渲染。\n\n## 2. 架构设计\n- **整体架构**：项目由多个类和方法组成，主要包括RealGalaxy类、Image类、以及用于噪声处理的whitenNoise和symmetrizeNoise方法。\n- **模块间关系**：各模块协同工作以实现图像的生成、变换和高精度渲染。\n\n## 3. 功能模块\n- **RealGalaxy类**：负责模拟真实的银河图像。\n- **Image类**：用于图像的创建和操作。\n- **whitenNoise方法**：用于处理图像中的相关噪声。\n- **symmetrizeNoise方法**：进一步优化噪声处理效果。\n\n## 4. 实现细节\n- **噪声处理**：通过噪声白化技术有效减少图像中的相关噪声，提高图像质量。\n- **图像渲染**：使用傅里叶变换技术实现高精度的图像渲染，满足天文学研究的需求。\n\n## 5. 应用场景\n- **天文学研究**：适用于高精度的天文图像模拟，特别是弱引力透镜效应的研究。\n- **算法测试**：为图像处理算法的开发和测试提供可靠的模拟数据。\n- **数据集支持**：适用于当前数据集以及未来的Stage IV暗能量调查。\n\n## 6. 优势特点\n- **高精度**：满足弱引力透镜等高精度图像分析的严格要求。\n- **开源工具**：作为开源软件，便于天文学社区的广泛使用和持续改进。\n- **高效处理**：能够高效地进行图像变换和操作，支持大规模数据处理。'}, mime_type=<MemoryMimeType.TEXT: 'text/plain'>, metadata=None)]
---------- project_assistant ----------
根据《GAL SIM Toolkit》文档，项目使用的主要技术方法包括：

1. **图像模拟和渲染**：
   - 项目核心依赖于GAL SIM软件，它是一个模块化的银河系图像模拟工具包，该工具包能够高效地生成天体对象（如恒星和银河系）的图像。
   - 采用傅里叶变换进行高精度的图像渲染和操作，包括卷积、伸缩、旋转等图像变换。

2. **噪声处理**：
   - GAL SIM通过噪声白化技术处理图像中的相关噪声。这个过程包括增加额外的噪声以消除现有噪声间的相关性，从而得到白噪声，这对于减少系统误差非常重要。
   - 支持多种噪声模型，包括高斯噪声、泊松噪声和相关噪声等，通过DeviateNoise类实现。

3. **模块化设计**：
   - 软件采用模块化设计，主要功能由不同的类实现，如RealGalaxy类用于模拟真实的银河系图像，而Image类则用于图像的生成和操作。
   - 项目提供的接口非常灵活，允许变换和组合不同的天文对象，便于扩展和新模块的集成。

4. **科学需求驱动**：
   - 该软件的基本能力由模拟天文图像的需求驱动，特别是高精度弱引力透镜观测的需求。
   - 使用的理论基础和算法能够满足如LSST、Euclid和WFIRST等大规模天文调查的高精度要求。

通过上述技术方法，GAL SIM能够为天文数据分析提供高精度的模拟图像，特别适用于弱引力透镜效应的研究和相关算法的开发。